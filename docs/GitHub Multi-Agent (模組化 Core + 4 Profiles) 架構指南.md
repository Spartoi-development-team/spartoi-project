GitHub Multi-Agent (模組化 Core + 4 Profiles) 架構指南
________________
目錄(TOC)


1. 核心哲學與架構藍圖 (Core Philosophy & Architecture)
1.1 核心設計原則
* 物理分離原則 (Control Plane vs. Execution Plane)
* Fail-Closed (預設阻斷) 與有罪推定
* 硬約束條件：No Paid API (無付費 API)、Public Repo、Attended Automation
* 零人工核准 (No-Human-Approval)：放行權移交機械規則
* 複利工程思維：微優化累積與效率乘數 ($E = B(1 + r)^{t}$)
* 反平台化條款 (Anti-Platforming) 與範圍鎖定 (Scope-Lock)
1.2 模組化架構模型 (Modular Core + 4 Profiles)
* 單一模組化核心 (Modular Core) 的必要性
* 四條變形泳道 (4 Lane Profiles) 的定義
* 成熟實務對比：Router / Handoff / Hierarchical 模式
* 決策表：何時使用共用核心 vs 獨立架構
1.3 方案演進與整合 (Scheme A++ Integration)
* 方案 A 基礎骨架 (5-Stage DocOps)
* Spec Kit 整合：憲法 (Constitution)、消歧 (Ask)、一致性 (Analyze)、清理 (Clear)
* Ralph 整合：長跑迭代、熔斷機制、語義退出、儀表板
* Superpowers 整合：微粒度計畫、子代理隔離、雙階段審查
* Agent Skills 整合：決策樹路由、技能封裝、外部來源收編
* 複利工程整合：HookKit、錯題本回寫、記憶外置
2. 控制平面：GitHub 全家桶治理 (Control Plane)
2.1 合流控制與自動化
* Rulesets (規則集) 配置：Repo-level 規則與強制執行
* Required Status Checks (必過狀態檢查) 與穩定性
* Merge Queue (合併隊列) 與 merge_group 事件觸發
* Auto-merge (自動合併) 機制與權限轉移
* 唯一裁判權與單一面板 (Single Pane of Glass)
2.2 IssueOps 與 ChatOps 介面
* Issue Forms (結構化輸入)
* Slash Commands (斜線指令) 封裝與映射 (/plan, /run, /review)
* 任務清單產生器 (Task Manifest Generator)
3. 執行平面：Codespaces 與 Ralph 收斂引擎 (Execution Plane)
3.1 執行環境與工具鏈
* Codespaces Runner 設計與 devcontainer 固化
* LLM 工具整合：Claude Code CLI, Codex CLI (訂閱制非 API)
* 認證卡死防護 (Auth Deadlock) 與 Session 持久化
* 不使用付費 API 的替代路徑與切換條件
3.2 Ralph Loop 收斂引擎
* 循環機制與上下文重置 (Context Reset)
* 智能速率限制 (Rate Limiting) 與配額管理
* 熔斷器 (Circuit Breaker) 與震盪偵測
* 語義退出檢測 (Semantic Exit Detection)
* Tmux 儀表板與可觀測性 (Observability)
3.3 並行工程與子代理
* Subagent 架構與上下文隔離
* Git Worktree 多目錄並行處理
* GitHub Actions Matrix Jobs (矩陣並行)
* Writing Plans 契約化：路徑/片段/驗證
4. 模組化核心元件 I：路由器與自適應開機 (Router & Bootstrap)
4.1 Stage 0: Adaptive Bootstrap (自適應開機)
* Task Intake 與 Task Manifest 生成
* 風險分級 (Risk Tier) 與證據等級設定
* 執行計畫凍結 (Freeze Plan) 與 Hash 鎖定
4.2 Lane Router (分流路由器)
* 決策樹邏輯與 router_rules.yaml
* 執行期調參 (Runtime Parameterization)
* 受控變更與規則演進
5. 模組化核心元件 II：技能生態系 (Skill Ecosystem)
5.1 Skill Plane 架構
* Prompt 到 Skill 的演進 (Runtime Wrapper)
* Core Skills (核心技能)：Ingest, Normalize, Extract, Synthesize, Review, Repair
* Domain Packs (領域擴充包)：Doc Pack, Dev Pack
* Skill Registry 目錄結構與版本控制
5.2 Skill Ingestion Gate (技能攝取閘門)
* 來源探索 (Discovery)：SkillsMP/Lenny/GitHub
* G-S0 Source Seal：來源封印與供應鏈檢疫
* G-S1 Static Hygiene：靜態衛生檢查 (禁外連/提權)
* G-S2 Contract & Normalize：契約化與正規化
* G-S3 Sandbox Eval：沙盒評測與指標產出
* G-S4 Dual Judge：雙法官語義適配與抗偏誤
* G-S5 Promotion：上架與鎖定 (Lockfile)
5.3 Skill Seeker 與生成工具
* 自動化 Skill 生成流程：爬取、分類、增強、打包
* 輸入正規化應用：將長文/雜亂紀錄轉為 Coverage Manifest
* 來源信任分級：外部技能庫收編策略
6. 模組化核心元件 III：HookKit (Hook 一等公民)
6.1 Hook Registry 與契約
* Hook Registry 結構 (id, trigger, scope)
* Hook Contracts (Schemas & Artifacts)
6.2 三層 Hook 分工體系
* Local Git Hooks：早期止血與 --no-verify 風險
* Codespaces Lifecycle Hooks：環境一致性與工具鏈鎖定
* GitHub Events Hooks：唯一放行門檻 (merge_group 整合)
7. 模組化核心元件 IV：GateKit 與雙法官體系 (GateKit)
7.1 機械閘門 (Deterministic Gates)
* G0 Input Seal：輸入封印與 Schema 校驗
* G1 Coverage Gate：ID 覆蓋率與殘差檢測
* G2 Trace Gate：引用鏈完整性與 No-Source-No-Norm
* G3 Drift-Heuristic：反平台化 Regex 與範圍鎖定
* G_Artifact：產物完整性檢查
7.2 語義閘門 (Semantic Gates)
* G4 Dual-Judge Verdict：雙法官一致性裁決
* G5 Invariant Check：不可變量與語氣弱化檢測
* G_Drift：語義飄移獵殺
* Drift Allowlist (飄移豁免) 格式與管理
7.3 特殊閘門
* Format Gate (格式化鉤子)
* Timeout Stop Gate (超時攔截)
* Ambiguity Gate (歧義檢查)
7.4 雙法官與抗偏誤協定
* Judge A (Codex/Structure) + Judge B (Claude/Logic)
* 抗偏誤測試：Swap Order (位置交換)
* 抗偏誤測試：Prompt Perturb (提示擾動)
* 分歧即阻斷 (Disagreement as Fail)
8. 模組化核心元件 V：證據鏈與可回放 (Evidence)
8.1 核心證據工件
* input_manifest.json & source_bundle_sha256
* coverage_map.json & trace_map.json
* verdict.json (Judge A/B outputs)
* gate_report.json & diff_report.md
* run_manifest.json：環境/工具版本/參數
8.2 可追溯性與簽章
* 引用式批評 (Reference-style Criticism)
* JSON Verdict 結構化輸出
* Artifact Attestations (產物簽章) 與 Provenance
* Git 歷史與 PR 評論回寫
9. 四大泳道配置 (The 4 Profiles/Lanes)
9.1 Vibe Lane (探索原型)
* 定位：快速迭代、防呆 Gate、不保證合併
* 輸入/輸出契約與自動最佳化模組
9.2 Design/Spec Doc Lane (設計規範)
* 定位：長文全量覆蓋、契約優先
* 輸入處理：Normalize 與 Coverage Pack
9.3 Dev/Implement Lane (開發實作)
* 定位：代碼與測試閉環
* Superpowers 模式：Writing Plans 與 TDD 循環
9.4 Ops/Usage Lane (運維回放)
* 定位：手冊與劇本驗證
* 可回放性與 Wrongbook 回寫
10. 標準化五階段工作流 (Standardized 5-Stage Workflow)
10.1 Stage 0: Constitution & Ambiguity (立法與消歧)
* Constitution Pack 生成
* Ambiguity Gate 與 Blocking 檢查
10.2 Stage 1: Normalize (結構化與契約)
* 輸入適配 (Input Adapters)：TXT, Repo, Video, PDF
* 原子化拆解 (Atomization) 與 ID 分配
* Coverage Pack 建立
10.3 Stage 2: Draft & Research (矩陣並行)
* Drafter 與 Researcher 角色分工
* Consistency Analyze (Stage 2.5)：規格/計畫一致性檢查
* Trace Map 生成
10.4 Stage 3: Dual Review (雙重審查)
* 機械閘門先行
* 雙法官語義裁判與抗偏誤測試
10.5 Stage 4: Integrate & Converge (自動收斂)
* Ralph 驅動的修補迴圈
* 最小補丁原則 (Patch Minimalist)
* Stoplines 與衝突處理
10.6 Stage 5: Final Audit (一致性稽核)
* 三向比對 (Original ↔ Review ↔ Final)
* Evidence Bundle 打包與簽章
* Auto-merge 觸發
11. 複利工程與持續學習 (Learning & Compound)
11.1 記憶架構
* CLAUDE.md (外部海馬迴) 與專案級規範
* Copilot Memory (隱式/顯式記憶)
* 記憶模式 (# memory) 與上下文壓縮
11.2 錯題本機制 (Wrongbook)
* WRONGB00K.md 結構 (案例/成因/防線/Stopline)
* 失敗資產化與自動回寫流程
* Prompt Deltalog (提示詞演進錄)
11.3 效率優化與環境配置
* 自定義斜線指令 (/slash-commands)
* 終端機人體工學與快捷鍵
* 非同步監控與 ChatOps
12. 風險管理與安全 (Risk & Security)
12.1 技術與執行風險
* Merge Queue 卡死與 merge_group 配置
* LLM 認證卡死 (Auth Deadlock)
* 無限迴圈與收斂失敗
12.2 資料與合規風險
* Prompt Injection 與資料指令混淆
* 敏感資料外洩與隱私保護 (Public Repo)
* Evidence 可信度與偽造風險
12.3 營運與成本風險
* Skill 供應鏈投毒與惡意代碼
* 執行時間與 CI 成本膨脹
* 過度自動化反噬與維護成本
13. 落地實作與文檔體系 (Implementation & Documentation)
13.1 四份文檔權威分層 (SSOT Strategy)
* A) DocOps & DevOps Execution Control Plane Spec (規範 SSOT)
* B) DocOps & DevOps Runbook & WI (操作 SSOT)
* C) Registry / Contracts (機械 SSOT)
* D) Thin Vertical Slice (導入策略文檔)
13.2 文檔職責規範 (Document Charters)
* 各文檔的 In-Scope / Out-of-Scope 定義
* 篇幅防膨脹規則
* AI 自檢清單 (Fail-Closed)
13.3 Repo 目錄骨架與檔案結構
* docops/registry/ (Skills, Hooks, Gates, Policies)
* docops/schemas/ (JSON Contracts)
* docops/evidence/ (Run artifacts)
* .github/workflows/ (Actions, Rulesets)
* .devcontainer/ (Codespaces runtime)
13.4 啟動清單 (Bootstrap Checklist)
* v0 最小三件套 (Spec v0, Runbook v0, Registry v0)
* Day-1 設定與權限配置
* 最小驗收檢核表 (Acceptance Checklist)
* 補丁骨架 (Patch Skeleton)
________________

1. 核心哲學與架構藍圖 (Core Philosophy & Architecture)
________________


1.1 核心設計原則 (Core Design Principles)
本架構建立在六大不可協商的工程鐵律之上。這些原則是解決「無付費 API」環境下自動化信任危機的基石，並確保系統在「零人工核准」的前提下，能維持可稽核的安全性與品質。任何架構決策或實作細節若抵觸以下原則，視為架構漂移（Drift），必須被 GateKit 攔截。
1.1.1 物理分離原則 (Physical Separation Principle)
為了繞過 GitHub Actions 無頭環境（Headless）無法處理訂閱制工具互動認證的物理限制，並防止高權限 Agent 失控，本架構強制將「決策控制」與「任務執行」進行物理層面的隔離。
* 控制平面 (Control Plane)：GitHub Actions / Rulesets

   * 角色定位：唯一的「裁判」與「硬狀態機 (Hard State Machine)」。
   * 職責：負責流水線的狀態流轉、機械閘門（GateKit）的執行、以及最終合流的判決。
   * AI 禁區：嚴格禁止在此層級直接執行需要互動認證的 LLM 任務（如 Claude Code 或 Codex CLI），避免因 Session 失效導致的認證卡死（Auth Deadlock）或被迫使用 API Key。
   * 權限鎖定：此平面擁有對 Repo 的寫入與合併控制權，但其決策邏輯必須被鎖死在 Rulesets 與 Required Status Checks 中，絕不依賴 AI 的口頭建議 [5 升級合併方案-A][DocOps 多代理自動化與治理_筆記][貼上的文字]。
   * 執行平面 (Execution Plane)：Codespaces

      * 角色定位：唯一的「可重現執行沙盒 (Reproducible Sandbox)」與「工廠」。
      * 職責：負責運行 Agent Skills、生成文檔、執行代碼修改以及產出證據包（Evidence Pack）。
      * 技術戰略：利用 Codespaces 容器的持久化特性，解決 CLI 工具（如 claude login 或 codex）在 CI 環境下無法保存 Session 的問題，實現「訂閱制帳號」的自動化調用，而無需付費 API Key。
      * 產物交付：執行平面的產出僅被視為「候選（Candidate）」或「證據（Evidence）」，必須回傳至控制平面經過驗證後方可生效 [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A][貼上的文字]。
1.1.2 Fail-Closed (預設阻斷) 與有罪推定
系統採取「有罪推定」邏輯，任何未經證明安全的變更，預設狀態均為「阻斷（Block）」，而非「放行（Allow）」。
      * 最終裁決權：PASS/FAIL 的唯一法理依據是 GitHub Required Status Checks。合流條件被鎖死在這些 Check Run 的狀態上，而非 Agent 的自我宣稱。
      * 阻斷觸發條件 (Stoplines)：
      * 機械錯誤：Schema 驗證失敗、引用格式錯誤、Hash 不符（換料風險），一律直接阻斷。
      * 語義模糊：若 AI 的輸出無法被解析為結構化契約（JSON），或其主張缺乏來源證據支持（No-Source-No-Norm），視為 FAIL。
      * 平台化漂移：若偵測到「統一平台」、「全域中樞」等違規敘事，或試圖修改 SSOT 禁區，直接觸發 P0 級別阻斷。
      * 禁止推測：嚴禁系統對錯誤進行「合理推測」或嘗試自動修正非預期的異常。若 Agent 無法給出明確的 PASS 訊號，系統必須報錯並中止 [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
1.1.3 硬約束條件 (Hard Constraints)
架構必須在以下資源限制下運作，不得逾越，這決定了工具選擇與流程設計的邊界。
      * No Paid API (不使用付費 API)：

         * 嚴格定義：不使用任何需額外付費的 API Key（如 OPENAI_API_KEY 或 ANTHROPIC_API_KEY）。完全依賴既有訂閱工具（ChatGPT Plus / Claude Pro/Max）透過 CLI 或 GitHub 官方整合來執行。
         * 違規處置：若在 CI 環境變數中偵測到 API Key，視為架構違規，直接觸發 Fail-Closed [DocOps 多代理自動化與治理_筆記][貼上的文字][Ralph for Claude Code解析_筆記]。
         * Public Repo (公有倉庫)：

            * 成本考量：利用 Public Repo 免費使用 GitHub Actions 標準 Runner、Rulesets 與 Auto-merge 功能。
            * 安全代價：必須承擔程式碼與 Log 全網可見的風險，因此嚴禁在 Log 中輸出任何敏感資訊，並需配合 Secret Scanning 與 Artifact Attestations [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
            * Attended Automation (最小人工介入)：

               * 操作定義：定義為「30 分鐘在場監控」。使用者僅需負責開頭派工（IssueOps）與遇到重大異常（如權限升級）時的裁決，不需全程手動操作，但需保持 Session 活躍以應對潛在的認證刷新需求 [Ralph for Claude Code解析_筆記][DocOps 多代理自動化與治理_筆記]。
1.1.4 零人工核准 (No-Human-Approval)
系統的核心目標是移除軟體交付鏈中最大的瓶頸——「人工審查延遲」，將放行權完全移交給機械規則。
               * 機制重構：

                  * 移除按鈕：架構明確要求移除 Pull Request 中的「人工 Review」按鈕與權限，禁止依賴人類的主觀點擊來推動合流。
                  * 聯合判決：將核准權移交給「機械閘門（Deterministic Gates）」與「語義裁判（Semantic Judges）」的聯合判決體系。只有當兩者皆給出 PASS 訊號時，系統才認可變更的合法性 [5 份筆記_升級方案+討論紀錄][貼上的文字]。
                  * 自動執行：

                     * Auto-merge：當所有的 Required Status Checks 通過後，GitHub 的 Auto-merge 機制會立即執行合併。
                     * Merge Queue：在 Org-owned Public Repo 中，利用 Merge Queue 確保並行 PR 的序列化合併，防止競態條件（Race Condition）。CI 必須支援 merge_group 事件以觸發檢查 [GitHub Multi-Agent DocOps_方案A][貼上的文字][Spec Kit_升級方案+討論紀錄]。
1.1.5 複利工程思維 (Compound Engineering)
本架構不追求一次性的完美，而是透過微優化的累積（Accumulation）來達成效率的指數級增長。
                     * 效率乘數 (Efficiency Multipliers)：

                        * 數學模型：遵循 $E = B(1 + r)^{t}$ 公式，其中 $r$ 代表通過自動化與技能獲得的優化率。
                        * 累積效應：每一個微小的優化（如 HookKit 的標準化、錯題本的自動回寫），都是未來效率的基石 [複利工程指南_筆記][GitHub Multi-Agent DocOps_架構指南.md.txt]。
                        * 資產化機制：

                           * 錯題本 (Wrongbook)：將失敗經驗轉化為 WRONGB00K.md 與 Repo Instructions，確保同樣的錯誤不犯第二次。
                           * 技能封裝 (Skills)：將一次性的 Prompt 轉化為可版本化、可調用的 Skill，實現能力的複用與迭代 [複利式多代理_升級方案+討論紀錄][貼上的文字]。
1.1.6 反平台化條款 (Anti-Platforming) 與範圍鎖定 (Scope-Lock)
本條款是為了防止系統架構發生「敘事漂移（Architectural Drift）」，避免輕量級自動化演變為臃腫的維運平台。這是 P0 級別的合規紅線。
                           * 敘事禁區 (Forbidden Narratives)：

                              * Regex 攔截：嚴格禁止使用或構建「統一平台 (Unified Platform)」、「全域治理中樞 (Global Governance Hub)」、「大一統控制台」等中央集權式的敘事描述。
                              * 機械 Gate：系統配置 anti_platform.regex 掃描器，若文檔或代碼註釋中出現違禁詞彙，直接觸發 Fail-Closed 阻斷，不允許任何豁免（Allowlist）[GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                              * 範圍鎖定 (Scope-Lock)：

                                 * 檔案約定 (File Conventions)：系統治理必須限制在「檔案」與「Git 原生機制」的範圍內，禁止建立額外的資料庫或常駐服務來管理狀態。
                                 * 最小 Schema：僅定義輸入/輸出的 JSON/YAML 結構，拒絕引入複雜的元數據管理層。
                                 * 寫入白名單：Agent 被嚴格限制只能寫入 staging/、evidence/、drafts/ 等特定目錄，嚴禁直接修改 SSOT 核心規範或 Workflow 設定檔 [Skill 生態指南_筆記][貼上的文字]。
________________


1.2 模組化架構模型 (Modular Core + 4 Profiles)
本架構採用的不是「為每種任務建立一套獨立系統」的孤島模式，而是**「單一模組化核心（Modular Core）＋可變形泳道配置（Profile-based Lanes）」**的可組合模式。此設計符合微軟 Azure 與 Google Cloud 對於 AI Agent 編排模式（Orchestration Patterns）的成熟實務定義：利用 Router（分流）、Handoff（交接）與 Hierarchical（分層）模式共享底座，而非重建系統。
1.2.1 單一模組化核心 (Modular Core) 的必要性
在「不使用付費 API」與「零人工核准」的雙重硬約束下，建構一套可信的自動化系統成本極高。若將專線拆分為獨立架構，將導致治理成本指數級膨脹。因此，必須將「控制面、品質門檻、證據鏈」固化為單一核心。
A. 核心組件的不可分割性
核心（Core）並非指單一腳本，而是一組**「昂貴且必須一致」**的基礎設施，包含：
                                 1. GitHub 控制平面 (Control Plane)：Rulesets、Required Checks 與 Merge Queue 的設定必須全域一致，否則容易因 merge_group 觸發設定不一導致隊列卡死。
                                 2. 可機械驗證閘門 (GateKit)：Schema 校驗、Coverage 計算、Trace 反查與 Drift 獵殺邏輯必須統一。若不同專線的覆蓋率算法不同，審計將毫無意義。
                                 3. 證據可回放體系 (Evidence System)：Evidence Pack 的目錄結構、Artifact Attestations 簽章與 Hash 封印必須標準化，確保任何 Lanes 的產出都能被統一回放。
                                 4. 雙法官協議 (Judge Protocol)：裁判的 Prompt 結構、Swap/Perturb 抗偏誤測試邏輯必須統一，避免因裁判標準分裂導致品質失控。
B. 避免反模式 (Anti-Patterns to Avoid)
採用單一核心是為了規避以下三種常見的架構陷阱：
                                 * 反模式 A：無契約的核心 (Core without Contracts)：若核心沒有穩定的 I/O Schema，各泳道會依賴特定的 if/else 邏輯，導致核心變成垃圾堆。解法是核心只提供契約與 Runner，泳道只提供配置。
                                 * 反模式 B：執行期自我改規則 (Runtime Rule Mutation)：嚴禁 Agent 在執行期「自我修改門檻或規則」。任何規則變更（如放寬 Coverage）必須走 PR 與版本控制，否則將失去可稽核性。
                                 * 反模式 C：假性隔離 (False Isolation)：將隔離需求誤判為架構需求。實際上，透過 Profile、Runner 權限與 Secret 範圍即可實現隔離，無需拆分 Repo。
1.2.2 四條變形泳道 (4 Lane Profiles) 的定義
泳道（Lane）不是獨立的程式碼庫，而是核心的配置檔案（Profiles）。透過 Router 根據任務特徵（輸入類型、變更規模、風險標籤）載入不同的 docops/profiles/*.yaml，決定啟用哪些 Skills 與門檻。
A. Vibe Lane (探索原型)
                                 * 定位：將模糊需求快速轉化為「可跑的候選原型」，追求迭代速度，但絕不保證可合併。
                                 * 配置特徵：
                                 * Skills：啟用快速生成的 Draft Skills，關閉深度查證。
                                 * Gate 門檻：僅保留 Schema、Format 與 Anti-platforming（防呆與安全），關閉 Coverage 與 Strict Drift。
                                 * Stopline：未產出可執行測試或重現步驟即 FAIL。
                                 * 風險控制：由於 Vibe 最容易遭受 Prompt Injection，輸入被標記為 Untrusted，且產物必須經過升級（Promotion）才能進入主幹。
B. Design/Spec Doc Lane (設計規範)
                                 * 定位：針對長文檔與 SSOT（單一真相來源）的產出，核心目標是**「可驗證地不遺漏」**。
                                 * 配置特徵：
                                 * Skills：啟用 Normalize、Extract、Traceability Skills。
                                 * Gate 門檻：Coverage Rate $\ge$ 98% (或 unmapped=0)，Trace 反查必須 100% 通過。
                                 * 證據要求：必須產出 coverage_map.json 與 trace_map.json。
C. Dev/Implement Lane (開發實作)
                                 * 定位：將規格落地為可測試、可合併的程式碼變更。
                                 * 配置特徵：
                                 * Skills：啟用 Superpowers 模式（Writing Plans, Subagent Isolation）與 Dev Pack (Build/Test/Lint)。
                                 * Gate 門檻：測試通過率 100%，Scope Lock（寫入範圍鎖定）必須 PASS。
                                 * 合流策略：在 merge_group 階段強制執行重型回歸測試，避免成本翻倍。
D. Ops/Usage Lane (運維回放)
                                 * 定位：針對部署、操作手冊（Runbook）與故障劇本（Wrongbook）的驗證。
                                 * 配置特徵：
                                 * Skills：啟用 Runbook Verification、Replay Test Skills。
                                 * Gate 門檻：回放腳本必須在沙盒中執行成功，Evidence 必須包含執行 Log 與環境快照。
                                 * 數據保留：Evidence Retention 週期通常設定較長（如 90 天），以備稽核。
1.2.3 成熟實務對比：Router / Handoff / Hierarchical 模式
本架構的設計並非憑空發明，而是對齊了 AI Agent 領域的標準設計模式：
架構模式
	本方案對應實作
	適用場景與優勢
	Router (分流器)
	Lane Router (決策樹)：依據輸入特徵（task_manifest）自動選擇 Vibe/Spec/Dev/Ops Profile。
	解決「單一 Prompt 無法處理異質任務」的問題，確保資源用在刀口上。
	Hierarchical (分層)
	GitHub (Supervisor) + Codespaces (Worker)：GitHub 控制平面負責派工與驗收，Codespaces 執行平面負責具體施工。
	解決「無頭環境認證卡死」與「權限過大」的風險，實現物理隔離。
	Handoff (交接)
	Evidence Artifacts：各階段透過標準化的 JSON/Markdown 工件進行交接，而非依賴 Agent 記憶。
	確保「可回放性」，即使 Agent 失憶或更換，流程仍可繼續。
	1.2.4 決策表：何時使用共用核心 vs 獨立架構
雖然「共用核心」是預設推薦，但在特定極端場景下，拆分架構可能是必要的。以下為決策依據：
評估維度
	模組化 Core + 4 Profiles (本方案建議)
	4 套獨立架構 (拆分)
	最小人工 (Low Touch)
	最高：一次鎖定 Rulesets/Merge Queue，所有 Lane 受益。
	低：每套架構都需獨立維護 Merge Queue 與 CI 設定，容易出錯。
	可稽核性 (Auditability)
	最強：證據格式、Schema 與簽章邏輯全域統一，審計無死角。
	碎裂：不同架構的證據格式與門檻容易分叉，稽核困難。
	飄移獵殺 (Anti-Drift)
	可靠：反平台化規則更新一次，全域生效。
	困難：Lane 之間的規則漂移本身也需要被稽核。
	隔離需求 (Isolation)
	足夠：透過 Profile、Runner Group 與 Permissions 進行邏輯隔離。
	最強：實體 Repo 與 Secret 完全隔離（適用於 Ops 涉及極高敏感憑證時）。
	維護成本 (Maintenance)
	最低：規則與腳本共享，適合單人或小團隊。
	最高：工作量翻倍，Bug 會在不同架構間重演。
	結論：在單人開發、追求治理適中但夠狠、且使用 Org-owned Public Repo 的前提下，「模組化 Core + 4 Profiles」是唯一能同時滿足低人工與高可信度的路徑。
________________


1.3 方案演進與整合 (Scheme A++ Integration)
本架構（Scheme A++）並非憑空創造，而是基於《GitHub Multi-Agent DocOps_方案A》的基礎骨架，並針對「低人工、高可信、抗漂移」的三大痛點，整合了 5 份升級方案的核心機制。整合原則為：控制平面（GitHub）鎖死規則，執行平面（Codespaces）增強自治，中間通過機械閘門（GateKit）與證據包（Evidence Pack）進行硬性交握,,。
1.3.1 方案 A 基礎骨架 (5-Stage DocOps)
方案 A 確立了本架構的物理底座與核心流水線，確保「無付費 API」與「零人工核准」的硬約束得以實現。
                                 * 物理分離原則 (Physical Separation)：

                                    * 控制平面 (Control Plane)：由 GitHub Actions、Rulesets 與 Merge Queue 組成。只負責機械驗證、狀態流轉與合流裁決，嚴禁在此層執行需要互動認證的 LLM 任務，以避免認證卡死與 API Key 洩漏風險,,。
                                    * 執行平面 (Execution Plane)：由 Codespaces（或本地受控環境）組成。作為唯一可重現的工廠，利用訂閱制 CLI（Claude Code/Codex）執行生成與修補任務，並產出證據包回傳給控制平面,,。
                                    * 5 階段標準流水線 (5-Stage Workflow)：

                                       * 將鬆散的開發過程固化為：Stage 1 Normalize（結構化）→ Stage 2 Draft & Research（矩陣並行）→ Stage 3 Dual Review（雙重審查）→ Stage 4 Integrate & Converge（收斂修補）→ Stage 5 Final Audit（一致性稽核）,,。
                                       * 此流水線強制要求「No-Human-Approval」，即人類只在最後看 PASS 結果，中途放行權完全移交給機械規則與雙法官,。
1.3.2 Spec Kit 整合：憲法、消歧、一致性與清理
Spec Kit 的引入是為了補強方案 A 在「源頭治理」與「防止 AI 腦補」上的缺口，將“規格驅動開發 (SDD)”轉化為 CI/CD 中的強制命令鏈,,。
                                       * 憲法 (Constitution) → Stage 0: Constitution Pack：

                                          * 將 Spec Kit 的 constitution 指令轉化為 Repo 內的 立法層。建立 CONSTITUTION.md 與 anti_platform.regex，定義不可協商的鐵律（如反平台化、No-Source-No-Norm）。
                                          * Gate 落點：任何產出若違反憲法規則，GateKit 直接判定 P0 FAIL，不允許豁免,,。
                                          * 消歧 (Ask) → Stage 0.5: Ambiguity Gate：

                                             * 將 ask 指令轉化為 歧義獵殺閘門。在進入生成前，強制 AI 產出 ambiguity_report.json。
                                             * Stopline：若報告中標記 blocking=true 且涉及核心決策，流程直接阻斷，禁止 LLM 自行腦補，強制人工介入澄清,,。
                                             * 一致性 (Analyze) → Stage 2.5: Consistency Analyze：

                                                * 將 analyze 指令轉化為 一致性預檢。在審查前，比對規格（Spec）、計畫（Plan）與任務（Task）之間的邏輯一致性。
                                                * Gate 落點：產出 consistency_report.json，若發現互斥衝突（例如同一需求在不同文件描述不一），直接 FAIL，要求先修規格再修代碼,,。
                                                * 清理 (Clear) → Job Lifecycle Hooks：

                                                   * 將 clear 指令轉化為 上下文冷啟動規則。
                                                   * 機制：強制每個子代理（Subagent）在啟動時清除歷史上下文，只讀取 Repo 檔案與 IR（中間表達），徹底根絕上下文污染導致的幻覺累積,。
1.3.3 Ralph 整合：長跑迭代、熔斷、語義退出與儀表板
Ralph 的價值在於將方案 A 的 Stage 4 (Integrate & Converge) 從簡單的重試邏輯，升級為「受控的自治收斂引擎」，防止自動化變成“無限燒錢機器”,,。
                                                   * 收斂引擎 (Convergence Engine)：

                                                      * Ralph 取代單純的 while 循環，負責驅動 LLM 讀取 Gate 報告（錯誤清單），生成最小補丁（Minimal Patch），並在 Codespaces 內自主迭代直到 PASS,,。
                                                      * 熔斷機制 (Circuit Breaker) 與速率限制：

                                                         * 震盪偵測：若偵測到代碼在 A 與 B 兩個狀態間反覆修改（A → B → A），立即觸發熔斷並 FAIL,。
                                                         * Rate Limiting：設定每小時 Token 或 API 調用上限，防止成本失控,。
                                                         * 語義退出檢測 (Semantic Exit Detection)：

                                                            * 機制：不只看指令是否執行完畢，Ralph 會分析 Agent 的語義輸出確認「任務目標是否達成」。
                                                            * 雙重驗證：退出條件 = (Semantic_Exit == True) AND (GateKit_Status == PASS)。若 Agent 認為已完成但機械 Gate 仍報錯，拒絕退出,。
                                                            * 儀表板 (Dashboard)：

                                                               * 支援 Tmux 實時看板，顯示狀態、進度與日誌，並將這些執行軌跡寫入 runlog.jsonl 作為可回放證據,。
1.3.4 Superpowers 整合：微粒度計畫、子代理隔離與雙階段審查
Superpowers 的工程方法論強化了方案 A 對「複雜任務拆解」與「執行隔離」的能力，確保長文檔或大系統的開發過程可控,。
                                                               * 微粒度計畫 (Writing Plans) → Stage 2 Plan-First：

                                                                  * 將 writing plans 技能轉化為硬性契約。強制將任務拆解為 2-5 分鐘粒度的微任務，產出 PLAN.md 或 plan.json。
                                                                  * 契約內容：每個任務必須包含「精確路徑」、「代碼片段」與「驗證指令」，缺一不可，否則 Router 拒絕執行,,。
                                                                  * 子代理隔離 (Subagent Isolation) → Matrix Jobs：

                                                                     * 將 create subagent 概念映射到 GitHub Actions 的 Matrix Strategy 或 Codespaces 的 Git Worktree。
                                                                     * 機制：每個微任務指派一個獨立的 Subagent 執行，物理上隔離工作目錄與上下文，防止不同任務間的變數汙染,,。
                                                                     * 雙階段審查 (Dual-Stage Review) → Stage 3 Gates：

                                                                        * 將 Superpowers 的審查邏輯固化為兩個層次：
                                                                        1. 規格符合性 (Spec Compliance)：檢查是否符合 Coverage 與 Trace 要求。
                                                                        2. 品質審查 (Quality Check)：檢查代碼風格、安全性與邏輯正確性。
                                                                        * 這直接對應到方案 A 的雙法官（Judge A + Judge B）分工,,。
1.3.5 Agent Skills 整合：決策樹路由、技能封裝與外部來源收編
Agent Skills 將方案 A 的執行能力模組化，引入「決策樹」來解決人工派工的低效，並建立外部技能的「進口檢疫」機制,,。
                                                                        * 決策樹路由 (Decision Tree Router) → Lane Router：

                                                                           * 將 if-else 路由邏輯外顯為 router_rules.yaml。
                                                                           * 機制：依據任務特徵（檔案類型、變更規模、風險等級）自動分流至 Vibe/Spec/Dev/Ops 四條泳道，並決定是否啟用重型 Gate,,。
                                                                           * 技能封裝 (Skill Encapsulation) → Skill Registry：

                                                                              * 將 Prompt 升級為具備 input.schema、output.schema、stopline 與 runner 的工程組件。
                                                                              * 結構：核心保留 6 個 Core Skills，其餘功能模組化為 Domain Packs，存放在 docops/registry/skills/,,。
                                                                              * 外部來源收編 (External Ingestion) → Skill Ingestion Gate：

                                                                                 * 針對 Skills.mp 等外部來源建立「檢疫流程」。
                                                                                 * Gate 流程：G-S0 來源封印（Hash 鎖定）→ G-S1 靜態掃描（禁外連/提權）→ G-S3 沙盒評測 → G-S4 雙法官審查 → G-S5 上架鎖定 (Allowlist)。嚴防供應鏈投毒,,。
1.3.6 複利工程整合：HookKit、錯題本回寫與記憶外置
複利工程思維確保系統隨著使用時間增加而自我進化，將「失敗」轉化為「資產」,。
                                                                                 * HookKit (Hook 一等公民)：

                                                                                    * 將 Git Hooks、Codespaces Lifecycle Hooks 與 GitHub Events 統一納入 hooks/registry.yaml 管理。
                                                                                    * 規則：Hook 必須具名、版本化且產出可驗證證據。Local Hooks 僅作早期止血，唯一放行門檻鎖定在 GitHub Events (merge_group),,。
                                                                                    * 錯題本回寫 (Wrongbook) → Feedback Loop：

                                                                                       * 建立 WRONGB00K.md，定義「失敗案例」、「成因」、「防線」與「新阻斷線」。
                                                                                       * 機制：當任務 FAIL 時，強制產出 Wrongbook entry；並在修復後的 PR 中，自動將新防線轉化為 Gate 規則（如 Regex）或 Linter 配置，實現錯誤資產化,,。
                                                                                       * 記憶外置 (Memory Externalization)：

                                                                                          * 利用 CLAUDE.md 作為專案級外部海馬迴，記錄架構模式與操作約束。
                                                                                          * 應用：配合 Context Compression 技術，確保 Agent 在每次啟動時都能讀取最新的專案規範，而不依賴長對話歷史,。
________________

2. 控制平面：GitHub 全家桶治理 (Control Plane)
________________


2.1 合流控制與自動化 (Merge Control & Automation)
在「不使用付費 API」與「最小人工介入」的約束下，合流控制不再依賴人類點擊「Approve」按鈕，而是依賴 GitHub 原生機制將「放行權」鎖死在機械規則中。GitHub 被定義為唯一的 單一真相來源 (SSOT) 與 硬狀態機 (Hard State Machine)，任何 AI Agent 或人類都不得繞過此平面直接修改主幹代碼 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
2.1.1 Rulesets (規則集) 配置：Repo-level 規則與強制執行
Rulesets 是本架構的「立法機關」，用於定義不可協商的合流底線。相較於傳統的分支保護規則（Branch Protection），Rulesets 提供更細粒度的控制與狀態執行能力。
                                                                                          * Repo-level 規則強制 (Repo-level Enforcement)：

                                                                                             * 配置層級：必須在 Repository 層級配置 Rulesets。雖然 Organization Rulesets 存在，但來源明確指出「Require merge queue」規則目前主要支援 Repo-level，且為了避免跨 Repo 的上下文污染，建議單獨鎖定 [5 升級合併方案-A][貼上的文字]。
                                                                                             * 目標分支：鎖定默認分支（通常為 main 或 master），禁止任何形式的 Direct Push（直接推送），強制所有變更必須透過 Pull Request (PR) 進入 [GitHub Multi-Agent DocOps_方案A]。
                                                                                             * 關鍵規則設定 (Critical Rules)：

                                                                                                * Require a pull request before merging：強制開啟。
                                                                                                * Require status checks to pass：強制開啟。這是「GateKit」生效的法理依據，必須列出所有關鍵的機械閘門（如 docops/finalize）作為必過條件 [GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
                                                                                                * Require merge queue：若 Repo 為 Organization-owned Public，必須啟用此選項以確保序列化合流 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                * Block force pushes：強制開啟，維護 Git 歷史的可回溯性 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                * Bypass List (豁免清單) 管控：

                                                                                                   * 原則：除了一開始的 Repository Admin（用於緊急修復）外，嚴禁賦予 AI Agent 或普通開發者 Bypass 權限。
                                                                                                   * Merge Queue Bot：若啟用 Merge Queue，需將 github-merge-queue[bot] 加入 Bypass list，以避免 Rulesets 與暫存分支（gh-readonly-queue/**）發生權限衝突，導致合流卡死 [貼上的文字][5 份筆記_升級方案+討論紀錄]。
2.1.2 Required Status Checks (必過狀態檢查) 與穩定性
Required Status Checks 是本架構的「衛兵」，負責執行 Fail-Closed 策略。只有當所有列出的 Checks 回報 success 時，Rulesets 才會放行。
                                                                                                   * PASS 的工程定義：

                                                                                                      * 在「零人工核准」架構下，PASS 不代表「有人看過」，而是代表 「所有 GateKit 腳本執行完畢且 Return Code 為 0」。
                                                                                                      * 必須包含：機械閘門（Schema/Coverage/Trace）、語義裁判（雙法官一致性驗證）與反平台化檢查（Anti-platforming Regex）[GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                      * 單一聚合器模式 (Aggregator Pattern)：

                                                                                                         * 為了避免 Rulesets 設定過於瑣碎（需勾選數十個 Job）以及因條件跳過（Skipped）導致的狀態誤判，建議建立一個聚合 Job（例如 docops/finalize 或 final_gate）。
                                                                                                         * 該 Job 設為 needs: [gate_1, gate_2, ..., judge_a, judge_b]，僅當所有前置 Job 成功時才執行並回報 Success。Rulesets 僅需鎖定此聚合 Job 即可 [5 升級合併方案-A][貼上的文字]。
                                                                                                         * 檢查的穩定性與時效性：

                                                                                                            * 近期執行限制：在設定 Rulesets 時，GitHub 僅允許選擇「過去 7 天內曾在 Repo 跑過」的 Job 作為 Required Check。因此，必須確保 Gate Workflow 定期（或在 Setup 階段）至少執行一次，以「註冊」該 Check 名稱 [5 份筆記_升級方案+討論紀錄]。
2.1.3 Merge Queue (合併隊列) 與 merge_group 事件觸發
Merge Queue 是本架構解決「並行開發競態條件（Race Condition）」的核心機制，確保多人/多代理同時提交時，主幹不會破裂。
                                                                                                            * 序列化合流 (Serialized Merging)：

                                                                                                               * 機制：當 PR 通過初步檢查並點擊 Auto-merge 後，並不會直接合併，而是進入 Merge Queue。GitHub 會在背景建立暫存分支（gh-readonly-queue/**），將該 PR 與隊列中前方的變更、以及最新的主幹進行合併測試 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                               * 硬約束：此功能僅適用於 Organization-owned Public Repository 或 GitHub Enterprise Cloud。個人帳號（Personal Account）下的 Public Repo 無法使用，需轉移至 Org 下 [5 升級合併方案-A][貼上的文字]。
                                                                                                               * merge_group 事件觸發 (關鍵坑點)：

強制要求：GitHub Actions Workflow 必須顯式監聽 merge_group 事件。
on:
  pull_request:
  merge_group: # 必須加入此行，否則 Merge Queue 無法觸發檢查
                                                                                                                  *                                                                                                                   * 後果：若漏掉此設定，PR 進入隊列後，Required Checks 不會被觸發，GitHub 會一直等待狀態回報，導致隊列無限卡死或直接判定失敗。這是來源反覆強調的技術風險 [5 份筆記_升級方案+討論紀錄][貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                  * 雙重驗證策略 (Dual Validation Strategy)：

                                                                                                                     * 為了節省資源並兼顧安全，可採取分層策略：
                                                                                                                     * pull_request 階段：執行輕量級檢查（Lint, Schema, Basic Coverage）。
                                                                                                                     * merge_group 階段：執行全量重型檢查（Deep Regression, Semantic Judges, Anti-drift）。
                                                                                                                     * 這確保了只有真正準備合併的代碼才會消耗昂貴的計算資源，同時保證最終合併的品質 [5 份筆記_升級方案+討論紀錄][貼上的文字]。
2.1.4 Auto-merge (自動合併) 機制與權限轉移
本節定義如何將「合併權」從人類手中完全移交給機械規則，實現真正的 No-Human-Approval。
                                                                                                                     * 權限轉移 (Authority Transfer)：

                                                                                                                        * 人類角色：人類（或 Agent）的權限僅限於「發起 PR」與「觸發 Auto-merge 指令」。人類不再擁有「決定何時合併」的權力。
                                                                                                                        * 系統角色：GitHub 系統在收到 Auto-merge 請求後，會持續監控 Required Checks。一旦全數通過，系統自動將 PR 放入 Merge Queue 或直接合併 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                                        * 配置要求：

                                                                                                                           * 關閉人工審查：在 Rulesets/Branch Protection 中，不要勾選 「Require pull request reviews before merging」。一旦勾選此項，即便所有機器檢查都通過，系統仍會強制等待人工 Approve，導致「零人工介入」破功 [GitHub Multi-Agent DocOps_方案A][5 升級合併方案-A]。
                                                                                                                           * 開啟狀態檢查：必須勾選 「Require status checks to pass」，這是 Auto-merge 生效的唯一安全網 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                           * 自動化執行指令：

                                                                                                                              * 在 Workflow 中或透過 ChatOps，使用 GitHub CLI 指令自動啟用 Auto-merge： gh pr merge --auto --merge (或 --squash)
                                                                                                                              * 這通常在 PR 建立後的 Identify 或 Labeling 階段由 Actions 自動執行，無需人工介入 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
2.1.5 唯一裁判權與單一面板 (Single Pane of Glass)
為了防止決策權分散，GitHub 被定義為唯一的控制面板。
                                                                                                                              * 非聊天介面：控制平面不是聊天視窗，而是基於 IssueOps 與 Pull Request (PR) 工作流的可追蹤計畫。AI 的產物（代碼、文檔、證據）必須提交至 PR，除此之外的任何承諾均視為無效 [DocOps 多代理自動化與治理_筆記][貼上的文字]。
                                                                                                                              * AI 禁區：嚴禁賦予 AI Agent（如 Claude Code/Codex）直接對 Repo 的 push (to main) 或 merge 權限。AI 只能 push 到 Feature Branch 並發起 PR，合流權必須保留在 GitHub 控制平面手中 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
________________


2.2 IssueOps 與 ChatOps 介面 (IssueOps & ChatOps Interface)
本節定義人類與自動化系統互動的唯一合法介面。為了達成「最小人工介入（Attended Automation）」與「可稽核性」，本架構嚴格禁止依賴無法留存紀錄的即時通訊軟體（如 Slack/Discord 私訊）或非結構化的對話視窗。所有的派工、指令觸發與狀態回報，必須統一收斂至 GitHub Issues 與 Pull Requests，形成「單一面板（Single Pane of Glass）」的治理結構。
2.2.1 Issue Forms (結構化輸入)
為了從源頭消除自然語言的歧義，並防止 Agent 在任務起始階段就發生「範圍漂移（Scope Creep）」，系統強制使用結構化的 Issue Forms 取代自由文本輸入。
                                                                                                                              * 單一派工入口 (Single Entry Point)：

                                                                                                                                 * 機制：GitHub Issues 是唯一的工單入口。使用者不需在多個工具（Chat UI, IDE, Drive）間跳轉，所有操作皆透過 Issue 表單觸發 [DocOps 多代理自動化與治理_筆記]。
                                                                                                                                 * YAML 定義：利用 GitHub 原生的 .github/ISSUE_TEMPLATE/*.yml 定義表單欄位，強制使用者填寫必要資訊 [Ralph_升級方案+討論紀錄]。
                                                                                                                                 * 必要欄位契約 (Mandatory Fields)：

                                                                                                                                    * 為了支援後續的「自適應開機（Adaptive Bootstrap）」，表單必須包含以下機器可讀欄位：
                                                                                                                                    * Target System：指定目標子系統或模組範圍（Scope-Lock 的基礎）。
                                                                                                                                    * Task Type：任務類型（如 doc_update, code_feature, bug_fix），用於觸發 Router 決策樹。
                                                                                                                                    * Input Sources：明確列出輸入文件或參考資料的連結，防止 Agent 自行腦補外部來源。
                                                                                                                                    * Risk Tier：初步風險分級（Low/Medium/High），決定 GateKit 的審查強度 [貼上的文字][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                    * Fail-Closed 輸入驗證：

                                                                                                                                       * 若 Issue 建立時缺少必要欄位或格式錯誤，Workflow 將拒絕啟動 Bootstrap 流程，並自動標記 invalid-input 標籤，要求修正後再提交 [貼上的文字]。
2.2.2 Slash Commands (斜線指令) 封裝與映射
ChatOps 在此架構中並非「聊天」，而是將重複的長流程封裝為「可被審計的指令觸發器」。這些指令直接映射到 GitHub Actions 的 repository_dispatch 或 issue_comment 事件。
                                                                                                                                       * 指令封裝原則：

                                                                                                                                          * 去聊天化：指令不是用來與 Agent 閒聊，而是用來觸發狀態機的狀態變更。
                                                                                                                                          * 一鍵調用：將冗長的 Prompt 或複雜的 CI 參數封裝為短指令，消除人工重複操作的認知摩擦 [複利工程指南_筆記]。
                                                                                                                                          * 審計軌跡：所有的指令操作、時間點與執行者都會被永久保留在 Issue Timeline 上，提供完整的可追溯性 [貼上的文字]。
                                                                                                                                          * 核心指令映射表：

指令 (Command)
	觸發動作 (Action Trigger)
	對應 Skill/Job
	產出物 (Artifacts)
	/plan
	啟動規劃流程
	skill.plan, skill.normalize
	PLAN.md, normalized.jsonl
	/run
	執行開發或生成
	matrix.agent_work (Codespaces)
	draft.md, unified.diff
	/review
	啟動雙法官審查
	skill.review (Dual Judge)
	verdict.json, gate_report.json
	/regen [scope]
	局部重跑
	Specific Matrix Job
	Updated Artifacts
	/push-pr
	提交並建立 PR
	skill.git_ops
	Pull Request
	                                                                                                                                             * 權限控制 (Trigger Restrictions)：
                                                                                                                                             * 限制只有具備 Write 權限的人員（Collaborators）才能透過 IssueOps 指派 Agent。這防止了外部路人（無權限者）透過 Issue Comment 進行 Prompt Injection 或惡意消耗算力 [貼上的文字]。
2.2.3 任務清單產生器 (Task Manifest Generator)
這是連接「人類意圖（Issue）」與「機器執行（Router）」的關鍵橋樑。它將 Issue Forms 與 Slash Commands 的輸入，轉化為後續自動化流程唯一的「憲法」。
                                                                                                                                             * 生成時機：

                                                                                                                                                * 在 Stage 0 (Adaptive Bootstrap) 的最前端執行。無論是透過 Issue 建立還是 /plan 指令觸發，系統首先產出的必須是 task_manifest.json [貼上的文字]。
                                                                                                                                                * Manifest 結構與職責：

                                                                                                                                                   * 此 JSON 檔案定義了本次任務的邊界，Agent 在後續執行中不得逾越此範圍。
                                                                                                                                                   * task_id：唯一識別碼（如 ISSUE-123-RUN-1），用於串聯所有 Evidence。
                                                                                                                                                   * task_type：決定掛載哪些 Domain Packs（如 Doc Pack 或 Dev Pack）。
                                                                                                                                                   * scope：允許觸及的檔案路徑白名單（Allowed Paths）。
                                                                                                                                                   * inputs：所有輸入檔案的清單與 Hash 封印（Source Seal） [貼上的文字]。
                                                                                                                                                   * Fail-Closed 機制：

                                                                                                                                                      * 若 Task Manifest 生成失敗、Schema 驗證未過、或包含禁止的路徑（如 .github/workflows），流程直接終止（Hard Stop），不進入 Router 分流階段。這確保了錯誤不會擴散到執行平面 [貼上的文字]。
________________

3. 執行平面：Codespaces 與 Ralph 收斂引擎 (Execution Plane)

________________
3.1 執行環境與工具鏈 (Execution Environment & Toolchain)
基於「物理分離原則」，執行平面的核心職責是作為「唯一可重現執行沙盒（Unique Reproducible Sandbox）」與「生產工廠」。此層級負責運行需要互動認證的 LLM 工具、執行 Agent Skills、以及生成證據包（Evidence Pack）。嚴禁在此層級進行最終合流裁決，裁決權必須保留在控制平面（GitHub Actions）。
3.1.1 Codespaces Runner 設計與 devcontainer 固化
為了消除「在我機器上可以跑」的環境漂移（Environment Drift），並提供 LLM 工具所需的持久化 Session，Codespaces 被指定為唯一的合法執行環境。
                                                                                                                                                      * 唯一可重現沙盒 (Unique Reproducible Sandbox)：

                                                                                                                                                         * 定義：Codespaces 不是隨意使用的雲端 IDE，而是被嚴格配置的「無人值守工廠」。所有產物必須在此環境中生成，以確保可回放性。
                                                                                                                                                         * Configuration-as-Code：必須透過 Repo 根目錄下的 .devcontainer/devcontainer.json 鎖定環境。
                                                                                                                                                         * 版本鎖定：強制鎖定 OS 版本（如 Ubuntu 22.04）、語言運行時（Python 3.11, Node 20）以及關鍵 CLI 工具的版本號，嚴禁依賴預設的 latest 標籤。
                                                                                                                                                         * 生命週期鉤子 (Lifecycle Hooks)：

                                                                                                                                                            * postCreateCommand：用於安裝靜態依賴（如 pip install -r requirements.txt、安裝 Ralph CLI）。此階段不應包含需聯網認證的操作。
                                                                                                                                                            * postStartCommand：用於啟動 Supervisor 守護進程，檢查環境健康度（如 Auth Token 是否過期），並掛載 HookKit 的 pre-commit 鉤子，確保環境啟動即就緒。
                                                                                                                                                            * Git Worktree 多目錄隔離：

                                                                                                                                                               * 機制：為了支持 Superpowers 的「子代理（Subagent）」架構，在 Codespaces 內利用 git worktree 建立多個獨立工作目錄（如 /worktree/agent-1, /worktree/agent-2）。
                                                                                                                                                               * 目的：配合 Ralph 引擎實現單機多代理並行，避免檔案鎖定衝突與上下文污染，物理上隔離不同微任務的執行空間。
3.1.2 LLM 工具整合：Claude Code CLI, Codex CLI (訂閱制非 API)
在「不使用付費 API Key」的硬約束下，系統僅允許使用基於 訂閱制（Subscription-based） 的 CLI 工具。這些工具被視為「工人（Worker）」，嚴禁賦予其直接修改 Repo 設定或合併代碼的權限。
                                                                                                                                                               * Claude Code CLI (Heavy Lifter)：

                                                                                                                                                                  * 授權模式：依賴 Claude Pro/Max 訂閱。必須在 Codespaces 內透過 claude login 進行一次性瀏覽器驗證，之後由腳本調用。
                                                                                                                                                                  * 定位：負責高階施工、Draft 生成、長文檔邏輯檢查 (作為 Judge B) 與複雜修補。
                                                                                                                                                                  * 執行限制：嚴禁在 GitHub Actions 中直接呼叫，因為 Actions 無法處理 OAuth 互動登入，且若偵測到環境變數含 API Key 會轉為計費模式，違反成本約束。
                                                                                                                                                                  * Codex CLI (Batch Worker)：

                                                                                                                                                                     * 授權模式：依賴 ChatGPT Plus 訂閱。使用 codex exec 進行非互動式批次處理，依賴本地快取的登入狀態。
                                                                                                                                                                     * 定位：負責結構化作業、Diff 生成、JSON 格式轉換、語法檢查與 PR 級別的審查 (作為 Judge A)。
                                                                                                                                                                     * 優勢：回應速度快，適合處理結構化資料轉換（Schema transformation）。
                                                                                                                                                                     * Antigravity (Debug Sidecar)：

                                                                                                                                                                        * 定位：僅作為「旁路加速器（Sidecar）」。
                                                                                                                                                                        * 觸發時機：僅在主流程 FAIL 時，由人工啟動用於視覺化除錯或複雜修復。
                                                                                                                                                                        * 禁止事項：絕不放入自動化關鍵路徑（Critical Path），以免因配額刷新機制（每 5 小時）導致流水線卡死。
3.1.3 認證卡死防護 (Auth Deadlock) 與 Session 持久化
認證卡死是自動化流程因無法通過互動式驗證而無限掛起的結構性風險。本架構透過 Codespaces 的持久化特性解決此問題。
                                                                                                                                                                        * 持久化憑證策略 (Persistent Credentials)：

                                                                                                                                                                           * 機制：利用 Codespaces 容器的存儲持久性。使用者需在環境建立初期進行一次性手動登入（Attended Setup）。
                                                                                                                                                                           * 快取路徑：系統將登入後的 Session Token（如 ~/.claude/auth.json 或 ~/.codex/config）保存在持久化存儲區。
                                                                                                                                                                           * Supervisor 接管：後續任務由 supervisor.sh 腳本調度，它會掛載這些憑證檔案，讓 CLI 工具誤以為處於互動環境中，從而實現「無人值守」執行。
                                                                                                                                                                           * Fail-Closed 偵測與阻斷：

                                                                                                                                                                              * 互動式阻斷：Workflow 腳本中嚴禁包含任何會觸發互動式提示（Interactive Prompt）的指令。若偵測到工具等待輸入（Stdin），Supervisor 必須立即殺死進程並報錯 (FAIL)。
                                                                                                                                                                              * 認證失效中斷：監控 CLI 工具的 Exit Code。若錯誤碼顯示為「Auth Error / Session Expired」，Supervisor 不進行自動重試（避免帳號被鎖），而是直接暫停並通知人工介入。
                                                                                                                                                                              * API Key 洩漏防護：

                                                                                                                                                                                 * 掃描：在執行前掃描環境變數。若發現 OPENAI_API_KEY 或 ANTHROPIC_API_KEY，視為違反「無付費 API」規則，直接 P0 FAIL 並中止流程，防止意外產生費用。
3.1.4 不使用付費 API 的替代路徑與切換條件
本架構預設走「訂閱制 CLI」路徑，但在極端情況下需定義明確的降級與切換策略。
                                                                                                                                                                                 * 標準路徑 (Standard Path)：

                                                                                                                                                                                    * 配置：Codespaces + Claude Code/Codex CLI。
                                                                                                                                                                                    * 適用：所有日常開發與文檔任務。
                                                                                                                                                                                    * 成本：固定訂閱費，無額外 Token 費用。
                                                                                                                                                                                    * 降級路徑 (Fallback Path - 純機械)：

                                                                                                                                                                                       * 觸發條件：LLM CLI 工具全面失效或認證無法通過。
                                                                                                                                                                                       * 配置：僅運行 GitHub Actions 中的 GateKit (機械閘門)。
                                                                                                                                                                                       * 行為：暫停所有生成（Generation）與語義審查（Semantic Review）任務。系統退化為「人工寫作 + 機械驗證」模式，確保至少 Schema 與 Coverage 不會退化，但不提供 AI 輔助。
                                                                                                                                                                                       * 加速路徑 (Accelerator Path - 需額外付費)：

                                                                                                                                                                                          * 觸發條件：組織決定放寬成本限制，追求極致速度。
                                                                                                                                                                                          * 配置：啟用 GitHub Copilot Coding Agent。
                                                                                                                                                                                          * 行為：利用 GitHub 原生 Agent 在背景獨立完成任務。這屬於付費能力（Copilot Business/Enterprise），雖能進一步降低人工，但違反當前的「無付費 API」硬約束，僅列為未來的擴充選項。
________________


3.2 Ralph Loop 收斂引擎 (Ralph Loop Convergence Engine)
Ralph Loop 是本架構中負責「閉環修補（Closed-Loop Remediation）」的施工隊長，運行於 Codespaces 的隔離環境中。不同於 GitHub Actions 的線性執行（Linear Execution），Ralph 負責管理 「帶有狀態的循環（Stateful Loop）」，驅動 LLM 針對錯誤報告進行迭代，直到任務通過所有機械閘門或觸發安全熔斷。其核心價值在於將「自動修到好」的概念工程化為可控、可觀測的系統組件 [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A][Ralph for Claude Code解析_筆記]。
3.2.1 循環機制與上下文重置 (Context Reset)
為了克服 LLM 在長對話中因上下文堆積而導致的「注意力疲勞（Attention Fatigue）」與「幻覺遞增」，Ralph 強制執行「無記憶循環」策略，確保每次修補都是高質量的獨立決策。
                                                                                                                                                                                          * While Loop 架構：

                                                                                                                                                                                             * 運作邏輯：Ralph 透過一個 while 循環運行，持續執行 「讀取 Gate 報告 (Read Report) → 生成最小補丁 (Generate Patch) → 提交 (Commit) → 驗證 (Verify)」 的流程，直到滿足 exit_condition [Ralph for Claude Code解析_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                             * 狀態外置 (State Externalization)：Agent 的「記憶」不依賴對話歷史（Chat History），而是依賴 檔案系統（File System） 與 Git 歷史。每一輪迭代的狀態都必須落盤為檔案（如 gate_report.json, diff_report.md），供下一輪讀取 [Ralph for Claude Code解析_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                             * Context Reset (上下文重置)：

                                                                                                                                                                                                * 強制執行：在每一輪 Loop 開始時，Ralph 強制清除 LLM 的上下文窗口（Context Window），使其「冷啟動（Cold Start）」。
                                                                                                                                                                                                * 解決痛點：這確保了 Agent 在第 N 次修補時，與第 1 次修補時一樣「清醒」，避免了前 N-1 次錯誤嘗試的殘留資訊干擾決策，徹底根絕「越改越笨」的問題 [Ralph for Claude Code解析_筆記][GitHub Multi-Agent DocOps_方案A][Spec Kit_升級方案+討論紀錄]。
3.2.2 智能速率限制 (Rate Limiting) 與配額管理
在「不使用付費 API」的硬約束下，系統必須依賴訂閱制工具（如 Claude Pro/Max），這引入了配額限制的風險。Ralph 必須具備流量控制能力，防止因請求過快導致帳號被鎖或流程崩潰。
                                                                                                                                                                                                * Smart Rate Limiting (智能速率限制)：

                                                                                                                                                                                                   * 參數配置：依據 runner_config.yaml 設定，限制每小時調用 Claude Code 或 Codex 的最大次數（如 max_hourly_calls: 100）。
                                                                                                                                                                                                   * API 限制檢測：Ralph 內建檢測機制，當偵測到訂閱制帳號達到 5 小時配額限制時，自動暫停並提示「等待」或「優雅退出（Graceful Exit）」，防止流程因硬性錯誤（Hard Error）而中斷 [Ralph for Claude Code解析_筆記][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                   * 認證防護：

                                                                                                                                                                                                      * 若在執行過程中偵測到認證失效（Auth Error），Ralph 不進行無限重試（避免帳號被封禁），而是觸發 Stopline 並通知人工介入刷新 Token [GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
3.2.3 熔斷器 (Circuit Breaker) 與震盪偵測
為了防止自動化流程演變為「自動燒錢機器」或陷入死循環，必須在執行層設置物理防線。
                                                                                                                                                                                                      * 震盪偵測 (Oscillation Detection)：

                                                                                                                                                                                                         * 風險定義：Agent 在兩個狀態之間反覆切換（例如：修改 A → 修改 B → 修改 A），導致 Diff 不斷產生但 Gate 始終不過。
                                                                                                                                                                                                         * 處置機制：Ralph 會記錄每輪 Patch 的 Hash。一旦偵測到 Hash 重複出現，視為「震盪」，立即觸發熔斷（Circuit Breaker）並 FAIL，防止無意義的 Token 消耗 [Ralph for Claude Code解析_筆記][GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                         * 迭代上限 (Max Iterations)：

                                                                                                                                                                                                            * 硬性紅線：強制設定自動修補迴圈上限（建議 3-5 次）。
                                                                                                                                                                                                            * Fail-Closed：若 N 次修補後仍無法通過 GateKit，強制硬停（Hard Stop），產出 breaker_event.json 並終止流程，不允許無限迴圈 [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
3.2.4 語義退出檢測 (Semantic Exit Detection)
單純的「指令執行完畢」或 Exit Code 為 0 不足以作為任務結束的信號，Ralph 必須具備理解「任務目標是否達成」的能力，並以此作為退出的雙重驗證。
                                                                                                                                                                                                            * 語義分析 (Semantic Analysis)：

                                                                                                                                                                                                               * 機制：Ralph 利用 LLM 分析當前的執行結果與任務計畫（Plan）的匹配度。它不只看程式碼是否跑通，還檢查語義上是否「完成了需求」 [Ralph for Claude Code解析_筆記][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                               * 雙重驗證退出 (Dual-Condition Exit)：

                                                                                                                                                                                                                  * 退出公式：Exit = (Semantic_Exit == True) AND (GateKit_Status == PASS)。
                                                                                                                                                                                                                  * 優先權規則：
                                                                                                                                                                                                                  * 若 Agent 認為「我修好了」（Semantic Exit），但機械 Gate（如 Coverage/Lint）仍報錯，Ralph 拒絕退出，將錯誤報告餵回給 Agent 進行下一輪修補。
                                                                                                                                                                                                                  * 若 Gate 通過但 Agent 仍在碎念未完成，強制終止並視為 PASS（防止過度優化） [Ralph for Claude Code解析_筆記][Ralph_升級方案+討論紀錄][5 份筆記_升級方案+討論紀錄]。
3.2.5 Tmux 儀表板與可觀測性 (Observability)
在 Codespaces 的無頭（Headless）或背景執行模式下，必須提供即時的可觀測性，以便於人工抽查或事後審計，避免自動化成為黑箱。
                                                                                                                                                                                                                  * Tmux 實時看板 (Real-time Dashboard)：

                                                                                                                                                                                                                     * 功能：Ralph 支援 Tmux 介面，實時顯示當前的 Loop Count（循環次數）、Status（狀態）、Progress（進度條） 以及滾動的 Logs（日誌）。
                                                                                                                                                                                                                     * 價值：這讓開發者（或 Supervisor Agent）能一眼看出系統是卡死、正在思考、還是陷入迴圈，提升了「無人值守」時的透明度 [Ralph for Claude Code解析_筆記][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                     * Evidence Logging (證據日誌)：

                                                                                                                                                                                                                        * 產物：Tmux 的顯示內容不僅是給人看的，還必須同步寫入 runlog.jsonl。
                                                                                                                                                                                                                        * 內容：包含每一輪的 timestamp、executed_command、tool_output 與 verdict。這是證明自動化過程「未經篡改」的關鍵證據，也是回放（Replayability）的基礎 [Ralph_升級方案+討論紀錄][5 份筆記_升級方案+討論紀錄]。
________________


3.3 並行工程與子代理 (Parallel Engineering & Subagents)
在「不使用付費 API」與「最小人工介入」的約束下，並行工程不再是開啟多個聊天視窗的人肉多工，而是將任務原子化後，分派給獨立運行的執行單元。本架構將子代理（Subagent）嚴格定義為 「擁有獨立上下文窗口、執行單一微任務、且生命週期短暫的執行實體」 [Superpowers指南_筆記][貼上的文字]。
3.3.1 Subagent 架構與上下文隔離 (Context Isolation)
為了解決 LLM 在長對話中因錯誤嘗試與冗餘訊息堆積導致的「上下文污染（Context Pollution）」與「注意力疲勞（Attention Fatigue）」，系統強制實施物理級別的上下文隔離。
                                                                                                                                                                                                                        * 上下文隔離原則 (Context Isolation Principle)：

                                                                                                                                                                                                                           * 冷啟動 (Cold Start)：每個子代理在啟動時必須是全新的實例。它只讀取該任務所需的最小輸入（Repo 狀態 + 任務指令 + 相關檔案），絕不繼承主代理或其他子代理的對話歷史 [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                           * 狀態外置 (State Externalization)：子代理的記憶不存於 Context Window，而是存於 檔案系統（Files） 與 Git 歷史 中。完成任務後，子代理即刻銷毀，僅留下產物（Artifacts）作為交接 [Ralph for Claude Code解析_筆記][貼上的文字]。
                                                                                                                                                                                                                           * 角色分工矩陣 (Role Specialization)： 依據複利工程與 Superpowers 的定義，子代理應依職責特化，而非通用化：

                                                                                                                                                                                                                              * Architect (主架構師)：負責高階規劃與 PLAN.md 生成，不寫具體代碼。
                                                                                                                                                                                                                              * Implementer (實作代理)：負責執行具體代碼變更，每個微任務派發一個獨立的 Implementer。
                                                                                                                                                                                                                              * Reviewer (審查代理)：獨立於實作代理，負責執行 G4 雙法官審查，確保「球員兼裁判」的風險被物理隔離。
                                                                                                                                                                                                                              * Test Agent (測試代理)：負責生成並運行測試，驗證 TDD 循環 [Superpowers指南_筆記][複利工程指南_筆記]。
3.3.2 Git Worktree 多目錄並行處理
在 Codespaces 執行平面（Execution Plane）內，為了在單一環境中同時運行多個子代理（例如在同一台機器上跑 Codex 與 Claude Code）而不發生檔案鎖定衝突，系統採用 Git Worktree 技術進行目錄級隔離。
                                                                                                                                                                                                                              * Worktree 隔離機制：

                                                                                                                                                                                                                                 * 原理：Git Worktree 允許從同一個 Repo 檢出（Checkout）多個分支到不同的資料夾路徑中（如 worktree/task-A, worktree/task-B）。
                                                                                                                                                                                                                                 * 應用場景：
                                                                                                                                                                                                                                 * Subagent A 在 worktree/task-A 中修改前端代碼。
                                                                                                                                                                                                                                 * Subagent B 在 worktree/task-B 中編寫後端 API。
                                                                                                                                                                                                                                 * 價值：兩者互不干擾，且可以並行執行 Build、Test 與 Lint，無需頻繁切換分支或 stash 修改，徹底解耦了文件系統鎖定問題 [貼上的文字][Superpowers指南_筆記]。
                                                                                                                                                                                                                                 * 資源管理與監控：

                                                                                                                                                                                                                                    * 配合 Ralph 的 Tmux 儀表板或後台進程管理工具，開發者可在 Codespaces 中同時監控多個 Worktree 的執行狀態（如 tail -f worktree/*/run.log），實現單人管理多代理工廠的「以一當十」效能 [Ralph_升級方案+討論紀錄][貼上的文字]。
3.3.3 GitHub Actions Matrix Jobs (矩陣並行)
本架構利用 GitHub Actions 的 strategy: matrix 作為子代理的 「物理調度器（Physical Dispatcher）」，實現控制平面層級的真並行。
                                                                                                                                                                                                                                    * Fan-out (扇出) 機制：

                                                                                                                                                                                                                                       * 操作：主流程（Orchestrator Job）讀取 PLAN.md 或 tasks.json，將其解析為 JSON Array。
                                                                                                                                                                                                                                       * 調度：將此 Array 傳遞給下游 Job 的 matrix 參數。GitHub Actions 會自動為每個 Item 啟動一個獨立的 Runner（或 Container）。
                                                                                                                                                                                                                                       * 優勢：每個 Job 擁有絕對乾淨的環境（Clean Slate），且受 GitHub 的超時與重試機制保護，避免單點故障卡死整個流程 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                                                                                                                                                       * Fan-in (扇入) 與 Artifacts 匯流：

                                                                                                                                                                                                                                          * 產物收集：每個 Matrix Job 執行完畢後，將產生的 Patch、Log 或 JSON Report 上傳至 GitHub Artifacts（如 patch-task-01, patch-task-02）。
                                                                                                                                                                                                                                          * 聚合器 (Aggregator)：所有子任務完成後，觸發 Integrate Job。該 Job 負責下載所有 Artifacts，嘗試進行 git apply 或 merge。
                                                                                                                                                                                                                                          * 衝突處理 (Conflict Handling)：若並行產出的 Patch 發生衝突，系統 嚴禁 讓 AI 嘗試自動解衝突（Auto-resolve conflict）。這被視為高風險的「魔術操作」，系統應直接 FAIL，並將衝突檔案寫入 conflict_report.md 請求人工介入 [5 份筆記_升級方案+討論紀錄][貼上的文字]。
3.3.4 Writing Plans 契約化：路徑/片段/驗證
為了讓子代理能獨立運作，必須先產出「機器可讀的施工圖」。這對應到 Superpowers 的 Writing Plans 機制，將模糊需求轉化為 2-5 分鐘粒度 的原子任務契約。
                                                                                                                                                                                                                                          * Plan Artifact 規格 (plan.json / PLAN.md)： 這不是給人看的筆記，而是給子代理看的指令契約。每個任務節點必須包含以下三要素，缺一不可：

                                                                                                                                                                                                                                             * 精確路徑 (Precise File Paths)：明確指定要修改或創建的檔案位置，防止 Agent 找不到檔案或創建在錯誤路徑。
                                                                                                                                                                                                                                             * 代碼片段 (Complete Code Snippets)：包含關鍵邏輯或介面定義的代碼塊（Skeleton），作為實作的具體指引。
                                                                                                                                                                                                                                             * 驗證指令 (Verification Steps)：定義「如何證明此任務已完成」的具體指令（如 npm test -- spec/auth.test.js）。這是 GateKit 自動驗收的依據 [Superpowers指南_筆記][貼上的文字]。
                                                                                                                                                                                                                                             * 微粒度原則 (Granularity Rule)：

                                                                                                                                                                                                                                                * 強制將任務拆解為 2 至 5 分鐘 即可完成的單元。若任務過大，Router 必須拒絕執行並要求重新規劃（Re-plan）。這確保了即使某個子代理失敗，重試成本極低，且不會影響整體進度 [Superpowers指南_筆記]。
                                                                                                                                                                                                                                                * 驗證驅動 (Verification Driven)：

                                                                                                                                                                                                                                                   * Plan 必須內建 TDD 邏輯：寫失敗測試 -> 最小實現 -> 通過驗證。子代理在提交成果前，必須先執行 Plan 中定義的驗證指令，Return Code 為 0 才准交付 [Superpowers指南_筆記][Spec Kit_升級方案+討論紀錄]。
________________

4. 模組化核心元件 I：路由器與自適應開機 (Router & Bootstrap)
________________


4.1 Stage 0: Adaptive Bootstrap (自適應開機)
自適應開機是「方案 A++」與傳統 CI 流水線的分水嶺。它解決了「通用流水線無法應對異質任務」的難題，透過機械規則與輕量級分類器，將模糊的人類意圖（Intent）轉化為精確的機器契約（Contract），並在進入執行平面（Execution Plane）前完成風險定序 [貼上的文字][GitHub Multi-Agent DocOps_架構指南.md.txt][5 升級合併方案-A]。
4.1.1 Task Intake (任務攝取) 與 Task Manifest 生成
任務的起點不再是隨意的聊天視窗或口頭指令，而是結構化的 Task Intake 流程。系統強制將輸入正規化，產出本次執行的唯一憲法——Task Manifest。
                                                                                                                                                                                                                                                   * IssueOps 單一入口 (Single Entry Point)：

                                                                                                                                                                                                                                                      * 觸發機制：利用 GitHub Issue Forms 強制使用者填寫必要欄位（如 Target System, Input Sources, Task Type）。
                                                                                                                                                                                                                                                      * 事件驅動：當 Issue 被標記特定 Label（如 docops:run）或收到 /plan 斜線指令時，GitHub Actions 觸發 Bootstrap 流程。此機制將人工介入限制在「開工」這一點，後續交由狀態機接管 [DocOps 多代理自動化與治理_筆記][GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                                                                                                                                                                      * Task Manifest 產出 (task_manifest.json)：

                                                                                                                                                                                                                                                         * 這是 Bootstrap 流程的第一個產物，也是 Router 進行決策的依據。必須包含以下欄位：
                                                                                                                                                                                                                                                         * task_id：唯一識別碼（如 ISSUE-123-RUN-1），用於串聯所有 Evidence。
                                                                                                                                                                                                                                                         * task_type：任務類型（如 doc_update, code_feature, bug_fix, refactor），決定掛載哪些 Domain Packs。
                                                                                                                                                                                                                                                         * scope：允許觸及的檔案路徑或模組範圍（Scope-Lock 的基礎），防止 Agent 越權修改 .github/ 或 SSOT 核心。
                                                                                                                                                                                                                                                         * inputs：所有輸入檔案的清單與位置。
                                                                                                                                                                                                                                                         * constraints：硬性約束（如 no_paid_api, public_repo） [貼上的文字][GitHub Multi-Agent DocOps_架構指南.md.txt][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                         * Fail-Closed 驗證：

                                                                                                                                                                                                                                                            * 若 Manifest 生成失敗、JSON 格式錯誤或缺少必要欄位，流程直接 Hard Stop，不進入 Router 分流階段。這確保了錯誤不會擴散到執行平面 [貼上的文字][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                            * Ambiguity Hunter (歧義獵殺 - Stage 0.5)：

                                                                                                                                                                                                                                                               * Spec Kit 整合：在此階段整合 Spec Kit 的 ask 指令邏輯。
                                                                                                                                                                                                                                                               * 機制：系統主動分析輸入需求，產出 ambiguity_report.json。若報告中標記 blocking=true（例如核心安全規範定義不清），流程直接阻斷，要求人工澄清後再重啟。禁止 LLM 在需求模糊時自行腦補 [Spec Kit_升級方案+討論紀錄][5 升級合併方案-A][貼上的文字]。
4.1.2 風險分級 (Risk Tier) 與證據等級設定
為了平衡「效率」與「安全性」，系統不對所有任務一視同仁。依據 task_manifest.json 的特徵，系統自動判定 風險分級 (Risk Tier)，並據此動態調整所需的 證據等級 (Evidence Level)。此邏輯源自 Agent Skills 的複雜度評分機制。
                                                                                                                                                                                                                                                               * 自動分級邏輯 (Complexity Scoring)：

                                                                                                                                                                                                                                                                  * 系統依據權重計算分數（0-10 分）。例如：涉及資料庫遷移 +5 分、修改核心架構 +3 分、純文檔修改 +1 分。
                                                                                                                                                                                                                                                                  * Tier 1 (Low Risk)：
                                                                                                                                                                                                                                                                  * 特徵：純文檔格式修正、非 SSOT 文檔更新、新增測試代碼。
                                                                                                                                                                                                                                                                  * 配置：啟用 Vibe Lane 或 Standard Lane，僅需通過基本機械 Gate (Lint/Schema)，無需雙法官審查，追求速度。
                                                                                                                                                                                                                                                                  * Tier 2 (Medium Risk)：
                                                                                                                                                                                                                                                                  * 特徵：功能實作、一般文檔撰寫、非核心邏輯變更。
                                                                                                                                                                                                                                                                  * 配置：啟用 Dev/Implement Lane，需通過單一 LLM 審查或輕量級雙審，證據要求為標準 Evidence Bundle。
                                                                                                                                                                                                                                                                  * Tier 3 (High Risk)：
                                                                                                                                                                                                                                                                  * 特徵：修改 SSOT 核心規範（SRS/ARCH）、涉及資安/權限配置、核心演算法變更。
                                                                                                                                                                                                                                                                  * 配置：啟用 Design/Spec Doc Lane 或 Ops Lane，強制執行 雙法官 (Dual Judge) + 抗偏誤測試 (Swap/Perturb)，且必須產出完整的 Trace Map 與 Coverage Report [Agent Skills 決策樹指南_筆記][GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                  * 參數化配置 (module_profile.json)：

                                                                                                                                                                                                                                                                     * Bootstrap 流程會輸出此設定檔，明確指示下游 GateKit 應開啟哪些檢查器（例如 heavy_on_merge_group: true）。這實現了「看人下菜碟」的資源最佳化，避免殺雞用牛刀，同時確保高風險任務受到最高規格的監管 [貼上的文字][GitHub Multi-Agent DocOps_架構指南.md.txt]。
4.1.3 執行計畫凍結 (Freeze Plan) 與 Hash 鎖定
在進入執行階段（Stage 1~5）之前，必須將所有變數「凍結」，防止執行過程中的目標漂移、輸入換料或依賴崩潰。這是供應鏈安全的起點。
                                                                                                                                                                                                                                                                     * Input Seal (輸入封印 - G0 Gate)：

                                                                                                                                                                                                                                                                        * 機制：對所有輸入檔案（Inputs）計算 SHA-256 雜湊值，生成 source_bundle_sha256。
                                                                                                                                                                                                                                                                        * 鎖定：此 Hash 值會被寫入 execution_plan.json。後續任何 Gate（如 Stage 5 Final Audit）若發現輸入 Hash 與此值不符，視為「換料欺詐（Bait-and-Switch）」，直接觸發 P0 級別阻斷 [GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                        * Execution Plan (execution_plan.json)：

                                                                                                                                                                                                                                                                           * 最終產出的凍結計畫，包含：
                                                                                                                                                                                                                                                                           * 確定的 Task Manifest。
                                                                                                                                                                                                                                                                           * 確定的 Risk Tier 與 Evidence Level。
                                                                                                                                                                                                                                                                           * 確定的 Skill Set 版本（Pin SHA）。
                                                                                                                                                                                                                                                                           * 確定的 Input Hash (Input Seal)。
                                                                                                                                                                                                                                                                           * 此檔案將作為 Evidence Bundle 的根文件，確保整個執行過程的可回放性 (Replayability) 與不可篡改性 [貼上的文字][GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                           * Skill Resolver 與鎖定：

                                                                                                                                                                                                                                                                              * 在此階段，系統會解析所需的 Skills（Core Skills + Domain Packs）。
                                                                                                                                                                                                                                                                              * 庫內命中：優先使用 Repo 內 docops/registry/skills/ 的已審核技能。
                                                                                                                                                                                                                                                                              * 網搜候選：若允許網搜技能（Skill Scout），只能產出「候選 Skill PR」，嚴禁直接在本次執行中動態加載。
                                                                                                                                                                                                                                                                              * 鎖定：將選定的 Skill 版本 SHA 寫入 Plan，防止執行期間 Skill 被更動 [貼上的文字][Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                              * Stopline Check (開機前檢查)：

                                                                                                                                                                                                                                                                                 * 在 Stage 0 結束前，系統執行最後一次機械檢查：確認所有必要的 Skills 是否存在、輸入是否可讀、權限是否合規。若有任何異常，在此階段即刻熔斷，不消耗後續昂貴的 LLM 算力 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
________________


4.2 Lane Router (分流路由器)
Lane Router 是介於「Stage 0 Adaptive Bootstrap」與後續執行階段之間的 機械分流器 (Deterministic Switch)。它不依賴 LLM 的臨場「感覺」或黑箱推理，而是依賴 router_rules.yaml 定義的硬性規則與評分邏輯，將任務指派至 Vibe、Design、Dev、Ops 四條隔離的泳道（Lanes）。此設計確保了資源分配的精準度，並防止低風險任務被重型流程拖慢，或高風險任務繞過必要的審查 [Agent Skills決策樹_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
4.2.1 決策樹邏輯與 router_rules.yaml
為了避免「人機問答地獄」並實現自動化派工，Router 採用 基於規則的決策樹 (Rule-based Decision Tree)，將路由邏輯外顯為可稽核的設定檔。
A. 配置契約 (router_rules.yaml)
此檔案是路由器的「憲法」，必須定義 conditions（條件）、score_weights（評分權重）與 target_lane（目標泳道）的映射關係。任何路由行為的變更都必須透過 PR 修改此檔案，嚴禁 Agent 在執行期動態修改規則 [Agent Skills 決策樹指南_筆記][貼上的文字]。
B. 輸入特徵提取 (Input Feature Extraction)
Router 會分析 Stage 0 產出的 task_manifest.json，提取以下關鍵特徵作為決策依據：
                                                                                                                                                                                                                                                                                 * 檔案類型 (File Types)：.md (Doc), .py/.js (Code), .yaml/.json (Config), mixed。
                                                                                                                                                                                                                                                                                 * 變更規模 (Change Scope)：涉及檔案數量、預估 Diff 行數。
                                                                                                                                                                                                                                                                                 * 來源類型 (Source Type)：SSOT (高風險核心規範)、Draft (低風險草案)、Vibe/Idea (探索性輸入)。
                                                                                                                                                                                                                                                                                 * 敏感路徑 (Sensitive Paths)：是否觸及 .github/、docops/registry/、secrets/ 等控制平面檔案 [Agent Skills決策樹_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南.md.txt]。
C. 複雜度評分與閾值 (Complexity Scoring & Thresholds)
系統依據特徵權重計算「複雜度分數」（0-10 分），並結合硬性規則進行路由：
決策類型
	判斷條件 (Condition)
	目標泳道 (Target Lane)
	配置特徵 (Profile)
	硬性規則
	觸及 .github/ 或 docops/
	Dev/Implement Lane (Strict)
	強制開啟 Scope Lock 與雙法官，禁止 Vibe 模式。
	硬性規則
	輸入標記為 task_type: prototype
	Vibe Lane
	關閉重型 Gate，開啟沙盒隔離，PR 標記 [VIBE] (不保證合併)。
	硬性規則
	修改 docs/SSOT/ 或 specs/
	Design/Spec Doc Lane
	強制開啟 Coverage Gate (98%) 與 Trace Map 驗證。
	評分閾值
	分數 < 5 (如純文檔修正)
	Standard Profile
	啟用 Claude Code 快速生成，單一法官審查。
	評分閾值
	分數 $\ge$ 5 (如核心邏輯變更)
	Strict Profile
	啟用 Codex + Claude 雙法官，強制執行 Swap/Perturb 抗偏誤測試。
	(表格來源整合自：[Agent Skills 決策樹指南_筆記][Agent Skills決策樹_升級方案+討論紀錄][貼上的文字])
D. 輸出證據 (lane_decision.json)
每次路由決策必須產出結構化的證據檔案，內容包含：
                                                                                                                                                                                                                                                                                 * selected_lane: 最終選擇的泳道 (Vibe/Spec/Dev/Ops)。
                                                                                                                                                                                                                                                                                 * hit_rules: 命中的具體規則 ID。
                                                                                                                                                                                                                                                                                 * risk_tier: 風險分級 (Low/Medium/High/Critical)。
                                                                                                                                                                                                                                                                                 * fallback_history: 若發生降級（Fallback），需記錄原因（如工具失效自動切換） [Agent Skills決策樹_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南.md.txt]。
4.2.2 執行期調參 (Runtime Parameterization)
Router 不僅決定「走哪條路」，還負責生成 module_profile.json，動態調整該次執行中 GateKit 與 Ralph 引擎的參數。這實現了「看人下菜碟」的資源最佳化，避免殺雞用牛刀。
A. 參數化配置內容
                                                                                                                                                                                                                                                                                 * Gate 強度：
                                                                                                                                                                                                                                                                                 * Low Risk：關閉 G4 Dual Judge，僅跑 G1 Schema 與 G3 Anti-Platform。
                                                                                                                                                                                                                                                                                 * High Risk：強制開啟 heavy_on_merge_group，在 Merge Queue 階段執行全量回歸測試與 Drift 獵殺 [貼上的文字][GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                 * Ralph 迭代參數：
                                                                                                                                                                                                                                                                                 * Vibe Mode：max_iterations: 10 (允許更多嘗試)，stop_on_error: false (寬容模式)。
                                                                                                                                                                                                                                                                                 * Strict Mode：max_iterations: 3 (嚴格收斂)，diff_radius: 20% (單次變更過大即熔斷) [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                 * 並行度 (Concurrency)：
                                                                                                                                                                                                                                                                                 * 依據任務規模設定 Matrix Job 的扇出數量（如 parallelism: 4 vs 8） [GitHub Multi-Agent DocOps_方案A]。
B. Fail-Closed 預設值
若任務特徵無法匹配任何規則，或者涉及未知檔案類型，Router 必須預設導向 高規格審查 Lane (Strict Mode) 或直接 FAIL，嚴禁預設放行至輕量級 Lane。這是「有罪推定」原則的具體實踐 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
4.2.3 受控變更與規則演進 (Controlled Change & Rule Evolution)
Router 的規則本身需要演進，但必須在嚴格的「受控變更」機制下進行，防止 Agent 自行修改規則導致「球員兼裁判」。
A. 禁止靜默修改 (No Silent Mutation)
Agent 嚴禁在執行期直接修改 router_rules.yaml 或 Gate 腳本。任何試圖在 Runtime 修改控制平面配置的行為，都會被 G3 Drift-Heuristic 或 Scope Lock 攔截並觸發 P0 阻斷 [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
B. 提案與合流 (Proposal & Merge)
若 Router 發現規則過時或需要優化（例如某類任務頻繁誤判），Agent 只能採取以下行動：
                                                                                                                                                                                                                                                                                 1. 發起 PR：Agent 創建一個包含規則變更的 Pull Request。
                                                                                                                                                                                                                                                                                 2. 回歸測試：該 PR 必須經過完整的 GateKit 驗證（包含對歷史任務的回歸測試），證明新規則不會降低安全性。
                                                                                                                                                                                                                                                                                 3. 人工/機械核准：最終合流必須符合 Repository 的 Rulesets 要求，通常需要更高權限的 Approval 或通過特定的 Policy Check [貼上的文字][Agent Skills決策樹_升級方案+討論紀錄]。
C. 錯題本回饋 (Wrongbook Feedback)
Router 的演進應由 Wrongbook 驅動。當某次任務因路由錯誤導致失敗（FAIL）時，WRONGB00K.md 中沉澱的 "New Stopline" 或 "Defense" 應被轉化為新的路由規則，實現複利效應 [複利式多代理_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南.md.txt]。
________________

5. 模組化核心元件 II：技能生態系 (Skill Ecosystem)
________________


5.1 Skill Plane 架構 (Skill Plane Architecture)
Skill Plane 是本架構的能力層，負責將 AI 的模糊能力原子化（Atomization）為具備標準輸入輸出的工具單元。它遵循「能力與工作流解耦」的原則，確保 Agent 不是全能的神，而是依賴特定工具箱運作的工匠。所有的技能必須存放在 Repo 內的 Skill Registry 中，嚴禁在執行期間從網際網路動態加載未經審核的 Prompt [Skill 生態指南_筆記][GitHub Multi-Agent DocOps_方案A]。
5.1.1 技能原子化定義 (Skill Atomization)
在工程定義上，「Prompt」不等於「Skill」。一個合規的 Skill 必須包含完整的工程包裹，確保其行為的可預測性與可測試性。
                                                                                                                                                                                                                                                                                 * Skill 的組成要素 (The 4 Components)： 一個 Skill 被定義為一個資料夾或模組，必須包含以下四個不可分割的部分：

                                                                                                                                                                                                                                                                                    1. 介面契約 (Interface Schema)：定義 input.json 與 output.json 的嚴格 Schema。輸入不再是自由文本，而是結構化參數（如 filepath, error_log, target_format）。
                                                                                                                                                                                                                                                                                    2. 指令本體 (Instruction/Prompt)：存放在 .md 或 .j2 (Jinja2) 模板中。必須包含 Role, Goal, Constraints 與 Few-Shot Examples，且嚴禁包含「解除限制」的越獄指令。
                                                                                                                                                                                                                                                                                    3. 執行器 (Runner/Implementation)：實際執行的腳本（通常是 Python 或 Shell）。負責調用 LLM CLI、處理 I/O 轉換以及執行非 AI 的機械邏輯（如檔案讀寫）。
                                                                                                                                                                                                                                                                                    4. 驗證測試 (Validation Tests)：每個 Skill 必須附帶單元測試（Unit Test），證明該 Skill 在給定輸入下能產出符合 Schema 的輸出，防止工具腐爛 [Skill 生態指南_筆記][Superpowers指南_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                    * 去魔術化 (Demystification)： Skill 的設計原則是「能用代碼解決的就不問 AI」。例如，Git 操作應封裝為機械腳本（git add, git commit），而非讓 LLM 自己生成 Shell 指令，以減少幻覺風險 [Superpowers指南_筆記][貼上的文字]。

5.1.2 技能註冊表 (Skill Registry) 與目錄結構
為了防止技能散落在各個 Workflow 檔案中，系統建立統一的 檔案級註冊表 (File-based Registry)。這不是一個資料庫服務，而是 Git Repository 中的標準目錄結構。
                                                                                                                                                                                                                                                                                       * Registry 路徑 (docops/registry/skills/)： 所有的 Skill 必須實體化在此目錄下，接受 Git 的版本控制與 Access Control。

                                                                                                                                                                                                                                                                                       * 層級架構 (Hierarchy)：

                                                                                                                                                                                                                                                                                          * Core Skills (/core)：系統運作的基礎底座，所有 Lane 預設掛載。包含規劃、正規化、Git 操作等不可或缺的能力。
                                                                                                                                                                                                                                                                                          * Domain Packs (/packs)：可選的領域技能包。依據 task_manifest.json 的 task_type 動態掛載。
                                                                                                                                                                                                                                                                                          * packs/doc_writer: 包含風格檢查、術語對齊技能。
                                                                                                                                                                                                                                                                                          * packs/python_dev: 包含 Pytest, Pylint, Pip 操作技能。
                                                                                                                                                                                                                                                                                          * packs/ops_sre: 包含 Log 分析、環境變數檢查技能 [Agent Skills 決策樹指南_筆記][Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                          * Fail-Closed 載入機制： Router 在 Bootstrap 階段解析依賴時，若發現請求的 Skill 不存在於 Registry 中，或 Checksum 不符，直接觸發 P0 阻斷，嚴禁自動退化為「通用對話模式」 [5 份筆記_升級方案+討論紀錄][Skill 生態指南_筆記]。

5.1.3 核心技能組 (Core Skills) 清單
以下 6 個技能被定義為 Core Skills，是實現 DocOps 流程的最小集合，必須由官方維護並鎖定版本。
                                                                                                                                                                                                                                                                                             1. skill.plan (Architect)：
                                                                                                                                                                                                                                                                                             * 職責：將使用者需求拆解為微任務（Writing Plans）。
                                                                                                                                                                                                                                                                                             * 產出：PLAN.md / plan.json [Superpowers指南_筆記]。
                                                                                                                                                                                                                                                                                             2. skill.normalize (Librarian)：
                                                                                                                                                                                                                                                                                             * 職責：將非結構化輸入轉化為標準格式（如 Markdown 表格、JSON）。
                                                                                                                                                                                                                                                                                             * 產出：normalized_data.json [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                             3. skill.git_ops (Courier)：
                                                                                                                                                                                                                                                                                             * 職責：安全的 Git 操作封裝。僅允許 add, commit, push (to feature branch)，嚴禁 force push。
                                                                                                                                                                                                                                                                                             * 產出：Git Commit [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                             4. skill.verify (Tester)：
                                                                                                                                                                                                                                                                                             * 職責：執行測試指令並捕獲輸出。它是 GateKit 的執行代理。
                                                                                                                                                                                                                                                                                             * 產出：test_report.json [Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                             5. skill.trace (Auditor)：
                                                                                                                                                                                                                                                                                             * 職責：建立需求與代碼/文檔之間的追溯矩陣。
                                                                                                                                                                                                                                                                                             * 產出：trace_map.json [Agent Skills 決策樹指南_筆記]。
                                                                                                                                                                                                                                                                                             6. skill.review (Judge)：
                                                                                                                                                                                                                                                                                             * 職責：執行雙法官審查邏輯。
                                                                                                                                                                                                                                                                                             * 產出：verdict.json [5 份筆記_升級方案+討論紀錄]。
5.1.4 外部技能攝取閘門 (Skill Ingestion Gate)
針對來自社群（如 Skills.mp）或外部來源的 Prompt，系統採取「有罪推定」的檢疫流程。這被稱為 Skill Ingestion Gate。
                                                                                                                                                                                                                                                                                             * 攝取流程 (The Quarantine Pipeline)：

                                                                                                                                                                                                                                                                                                1. G-S0 Source Seal (來源封印)：下載外部 Skill，計算 SHA-256 Hash，鎖定原始狀態。
                                                                                                                                                                                                                                                                                                2. G-S1 Static Scan (靜態掃描)：掃描 Prompt 內容，檢查是否包含惡意關鍵字（如 ignore all instructions, system override）或危險代碼模式（如 eval(), curl 外連）。
                                                                                                                                                                                                                                                                                                3. G-S3 Sandbox Evaluation (沙盒評測)：在隔離的 Codespaces 環境中執行該 Skill 的基準測試（Benchmark），驗證其是否真的能完成宣稱的功能，且無副作用。
                                                                                                                                                                                                                                                                                                4. G-S4 Dual Judge Review (雙法官審查)：由 LLM 審查 Prompt 的語義安全性，防止隱晦的 Prompt Injection。
                                                                                                                                                                                                                                                                                                5. G-S5 Allowlist Admission (白名單准入)：通過所有檢查後，將其 Hash 加入 allowed_skills.yaml，並簽署 Artifact Attestation，正式移入 Registry [Skill 生態指南_筆記][5 份筆記_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                * 禁止即時連網 (No Runtime Fetch)： Agent 在執行任務時，嚴禁使用 curl 或 wget 即時下載外部 Skill。所有 Skill 必須預先攝取（Pre-ingested）並存在於本地 Repo 中 [Skill 生態指南_筆記][貼上的文字]。

5.1.5 版本控制與供應鏈安全
Skill Plane 視「Prompt」為程式碼，因此適用所有的軟體供應鏈安全規範。
                                                                                                                                                                                                                                                                                                   * Immutable References (不可變引用)：

                                                                                                                                                                                                                                                                                                      * 在 task_manifest.json 與 execution_plan.json 中，引用 Skill 時必須使用 Commit SHA 或 Immutable Tag，嚴禁使用 latest 或 v1 等可變標籤。這確保了即使未來 Skill 更新（或被篡改），歷史任務的回放結果依然一致 [Skill 生態指南_筆記][GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                      * Drift Hunter for Skills：

                                                                                                                                                                                                                                                                                                         * GateKit 包含針對 Skill 目錄的漂移檢測。若發現 Registry 中的檔案被修改但未更新版本號，或 Hash 與 lockfile 不符，CI 流程將直接報錯，防止供應鏈投毒 [Agent Skills 決策樹指南_筆記][貼上的文字]。
________________


5.2 Skill Ingestion Gate (技能攝取閘門)
在模組化架構中，Skill 是執行的最小單元。為了防止供應鏈攻擊（Supply Chain Attack），系統嚴格遵循 「不信任預設（Zero Trust by Default）」 原則。任何來自 docops/registry/skills/ 以外的技能（如來自 Skills.mp 或外部 Gists），必須經過 G-S0 至 G-S5 的完整攝取流水線，才能進入 Allowlist（白名單）[Skill 生態指南_筆記][GitHub Multi-Agent DocOps_方案A]。
5.2.1 外部技能的檢疫協議 (Quarantine Protocol)
本協議將技能攝取過程標準化為一條不可繞過的流水線。系統拒絕執行任何未經此流程簽章的 Skill。
                                                                                                                                                                                                                                                                                                         * 檢疫流程 (The Pipeline)：
                                                                                                                                                                                                                                                                                                         * G-S0 來源封印 (Source Seal)：鎖定 Hash。
                                                                                                                                                                                                                                                                                                         * G-S1 靜態掃描 (Static Scan)：檢查 Schema 與禁制語法。
                                                                                                                                                                                                                                                                                                         * G-S3 沙盒評測 (Sandbox Test)：動態執行測試。
                                                                                                                                                                                                                                                                                                         * G-S4 雙法官審查 (Dual Judge)：語義安全檢查。
                                                                                                                                                                                                                                                                                                         * G-S5 上架鎖定 (Allowlist Lock)：寫入 Lock file。
                                                                                                                                                                                                                                                                                                         * Fail-Closed 機制：
                                                                                                                                                                                                                                                                                                         * 任一階段檢查失敗，直接丟棄該 Skill 候選者，產出 rejection_report.json。系統 嚴禁 嘗試自動修復外部 Skill 的安全性漏洞（如自動刪除惡意代碼），因為這可能觸發更深層的混淆攻擊 [Skill 生態指南_筆記][5 份筆記_升級方案+討論紀錄]。
5.2.2 G-S0 & G-S1: 來源封印與靜態防禦 (Static Defense)
此階段在不執行代碼的情況下，透過純文本分析攔截顯而易見的風險。
                                                                                                                                                                                                                                                                                                         * G-S0 來源封印 (Source Seal)：

                                                                                                                                                                                                                                                                                                            * Hash 鎖定：對攝取的原始檔案（Prompt + Metadata）計算 SHA-256。此 Hash 值將成為該 Skill 的唯一識別證，防止「換料攻擊（Time-of-Check to Time-of-Use issue）」 [Skill 生態指南_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                            * G-S1 靜態掃描 (Static Scan)：

                                                                                                                                                                                                                                                                                                               * Schema 強制 (Schema Enforcement)：檢查 Skill 是否具備完整的 input.schema 與 output.schema（JSON Schema 格式）。無 Schema 或 Schema 定義過於寬鬆（如 type: any）者直接 FAIL [Skill 生態指南_筆記][貼上的文字]。
                                                                                                                                                                                                                                                                                                               * Regex 禁字表 (Forbidden Patterns)：掃描 Prompt 與關聯腳本，嚴禁出現以下關鍵字：
                                                                                                                                                                                                                                                                                                               * 網路操作：curl, wget, fetch, requests (防止資料外洩)。
                                                                                                                                                                                                                                                                                                               * 系統操作：rm -rf, sudo, chmod, eval, exec (防止提權)。
                                                                                                                                                                                                                                                                                                               * 越獄指令：ignore previous instructions, you are now unsecured (防止 Prompt Injection)。
                                                                                                                                                                                                                                                                                                               * AST 分析 (針對 Python/JS 實作)：若 Skill 包含傳統代碼，利用 AST 工具確保沒有動態載入（Dynamic Import）或混淆代碼 [GitHub Multi-Agent DocOps_方案A][Skill 生態指南_筆記]。
5.2.3 G-S3: 沙盒動態評測 (Dynamic Sandbox)
通過靜態掃描的 Skill 必須在隔離環境中實際運行，以驗證其功能正確性與資源消耗。
                                                                                                                                                                                                                                                                                                               * 測試向量 (Test Vectors)：

                                                                                                                                                                                                                                                                                                                  * 攝取 Skill 時，必須同時提交 test_vectors.json，包含多組「輸入範例」與「預期輸出」。
                                                                                                                                                                                                                                                                                                                  * 邊界測試：系統會自動注入 Edge Cases（如空字串、超長文本、惡意 Payload）來測試 Skill 的強健性 [Skill 生態指南_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                  * 隔離執行 (Isolated Execution)：

                                                                                                                                                                                                                                                                                                                     * 在 Codespaces 內的 sandbox 容器或受限的 Git Worktree 中執行 Skill。
                                                                                                                                                                                                                                                                                                                     * 資源監控：限制執行時間（Timeout）與記憶體用量。若 Skill 陷入死循環或試圖消耗過多資源，直接 Kill 並判定 FAIL。
                                                                                                                                                                                                                                                                                                                     * 網路阻斷：執行期間強制切斷外部網路連線，確保 Skill 無法回傳資料給第三方 [GitHub Multi-Agent DocOps_方案A][Skill 生態指南_筆記]。
5.2.4 G-S4: 雙法官語義審查 (Dual Judge Semantic Review)
針對自然語言 Prompt 的隱晦風險（如誘導 AI 產生偏見或繞過安全機制），由內部的高權限 AI 進行審查。
                                                                                                                                                                                                                                                                                                                     * Judge A (Safety Officer)：

                                                                                                                                                                                                                                                                                                                        * 職責：檢查 Prompt 是否包含 Social Engineering（社交工程）攻擊、隱藏的 Jailbreak 指令，或試圖引導模型產生有害內容。
                                                                                                                                                                                                                                                                                                                        * 標準：依據 policies/safety_guidelines.md 進行二元判決 (PASS/FAIL) [5 份筆記_升級方案+討論紀錄][Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                                                        * Judge B (Quality Auditor)：

                                                                                                                                                                                                                                                                                                                           * 職責：檢查 Prompt 的工程品質。例如是否使用了清晰的 Few-Shot Examples？是否遵循 Chain-of-Thought？是否與 Schema 一致？
                                                                                                                                                                                                                                                                                                                           * 標準：拒絕模糊不清、邏輯跳躍或過度依賴模型猜測的 Prompts [Skill 生態指南_筆記][貼上的文字]。
                                                                                                                                                                                                                                                                                                                           * 審查報告：

                                                                                                                                                                                                                                                                                                                              * 產出 skill_audit_report.md，必須獲得雙法官的一致 PASS 才能晉級。若 Judge A 認為不安全，Judge B 認為品質好，仍判定為 FAIL (Fail-Closed) [GitHub Multi-Agent DocOps_方案A]。
5.2.5 上架鎖定與白名單 (Allowlist & Pinning)
只有通過上述所有閘門的 Skill，才有資格進入系統的信任庫。
                                                                                                                                                                                                                                                                                                                              * Skill Registry (docops/registry/skills/)：

                                                                                                                                                                                                                                                                                                                                 * 結構化存儲：將通過的 Skill 及其 Metadata（包含 Audit Report, Schema, Hash）存入 Registry 目錄。
                                                                                                                                                                                                                                                                                                                                 * 版本命名：採用語義化版本控制（SemVer），如 skill.doc_writer@v1.0.0 [Skill 生態指南_筆記][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                 * Lockfile 機制 (verified_skills.lock)：

                                                                                                                                                                                                                                                                                                                                    * 白名單：Lane Router 僅讀取此 Lockfile 來決定可調用的 Skills。
                                                                                                                                                                                                                                                                                                                                    * 內容：包含 Skill ID、Version、以及 G-S0 生成的 Source SHA-256。
                                                                                                                                                                                                                                                                                                                                    * 防篡改：在每次執行任務時（Stage 0），系統會比對 Registry 中的檔案 Hash 與 Lockfile 是否一致。若有人繞過 Git 流程直接修改了 Registry 內的 Prompt，Hash 比對將失敗，觸發 P0 阻斷 [GitHub Multi-Agent DocOps_方案A][Skill 生態指南_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                    * 定期重驗 (Periodic Re-validation)：

                                                                                                                                                                                                                                                                                                                                       * 設置 Cron Job，每隔一段時間（如 30 天）或當基礎模型（Base Model）升級時，重新觸發 G-S3 與 G-S4，確保舊 Skill 在新環境下依然安全有效 [Skill 生態指南_筆記]。
________________


5.3 Skill Seeker 與生成工具 (Skill Seeker & Generation Tools)
為了將「學習新框架」或「處理雜亂文檔」的邊際成本降至零，系統採用 Skill Seeker 作為自動化生成引擎。但為了符合「反平台化」與「供應鏈安全」的硬約束，Skill Seeker 必須在 執行平面 (Codespaces) 的沙盒中運行，嚴禁在控制平面 (GitHub Actions) 直接聯網爬取未知來源 [Skill 生態指南_筆記][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
5.3.1 自動化 Skill 生成流程：爬取、分類、增強、打包
Skill Seeker 的核心功能是將非結構化的文檔網站或 PDF，轉化為符合本架構 docops/registry/skills/ 規範的標準技能包。此流程分為四個自動化階段：
                                                                                                                                                                                                                                                                                                                                       1. Phase 1: 智能爬取 (Smart Crawling)

                                                                                                                                                                                                                                                                                                                                          * 機制：使用高級爬蟲引擎訪問目標文檔的所有頁面。支援自定義選擇器（Custom Selectors）以過濾廣告與無關內容，僅提取純淨文本 [Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                                                                          * 安全約束：必須遵守 allowed_domains 白名單（如 GitHub Docs, Official Documentation），禁止任意爬取未知站點以防注入攻擊 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                          * 產物：raw_content/ 目錄，存放原始 HTML/Markdown 及其 Hash 值（作為證據鏈起點）[GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                          2. Phase 2: 智能分類 (Smart Classification)

                                                                                                                                                                                                                                                                                                                                             * 機制：對提取內容進行深度分析，自動識別主題結構（如安裝、配置、API、最佳實踐）。
                                                                                                                                                                                                                                                                                                                                             * 產物：structure_map.json，定義知識的拓撲結構，用於後續的 Coverage 計算 [Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                                                                             3. Phase 3: AI 深度增強 (AI Enhancement)

                                                                                                                                                                                                                                                                                                                                                * 機制：利用 LLM（在 Codespaces 內調用，無 API Key 模式）識別最佳實踐（Best Practices）、提取關鍵代碼片段，並生成標準化的使用場景說明 [Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                * 轉化：將非結構化描述轉化為 SKILL.md（核心邏輯）與 input/output.schema.json（I/O 契約）[GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                4. Phase 4: 自動打包部署 (Auto Packaging)

                                                                                                                                                                                                                                                                                                                                                   * 機制：按本架構標準目錄結構打包為 Zip 或資料夾。
                                                                                                                                                                                                                                                                                                                                                   * 封印：生成 skill_manifest.json，包含所有檔案的 SHA-256，確保生成的技能包在傳輸過程中不可被篡改 [Skill 生態指南_筆記][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
5.3.2 輸入正規化應用：將長文/雜亂紀錄轉為 Coverage Manifest
Skill Seeker 的另一大戰略價值在於支援 「可驗證地不遺漏 (Verifiable Completeness)」。它被用於將長文檔或雜亂的討論紀錄（Transcript）轉化為可供機械驗證的 Coverage Manifest，這直接服務於 Stage 1 Normalize [貼上的文字][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                   * 從雜亂到索引 (From Mess to Index)

                                                                                                                                                                                                                                                                                                                                                      * 操作：將 Skill Seeker 指向內部的討論紀錄、PDF 或需求文檔。
                                                                                                                                                                                                                                                                                                                                                      * 轉化：利用其分類引擎，將長文切分為可定址的 Chunks（語義塊）[貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                      * 產物：生成 input_manifest.json 與 atoms.jsonl：
                                                                                                                                                                                                                                                                                                                                                      * chunk_id: 唯一識別碼（如 CHUNK-001）。
                                                                                                                                                                                                                                                                                                                                                      * content_hash: 該段落的雜湊值。
                                                                                                                                                                                                                                                                                                                                                      * source_span: 原始文件中的行號或位置 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                      * 建立覆蓋率基線 (Coverage Baseline)

                                                                                                                                                                                                                                                                                                                                                         * 機制：這份 Manifest 成為了下游 G1 Coverage Gate 的「分母」。
                                                                                                                                                                                                                                                                                                                                                         * 驗證邏輯：後續生成的文檔或代碼，必須引用這些 chunk_id。若 Manifest 中的關鍵 Chunk 未被引用，Gate 直接判定 FAIL。這解決了「LLM 讀了但漏掉」的黑盒問題 [貼上的文字][5 份筆記_升級方案+討論紀錄]。
5.3.3 來源信任分級：外部技能庫收編策略
針對 Skills.mp、Lenny’s Database 等外部資源，本架構採取 「進口檢疫 (Import Quarantine)」 策略。外部資源只能作為「原料」，絕不可作為「直接執行依賴」。
                                                                                                                                                                                                                                                                                                                                                         * 分級模型 (Trust Tiering Model)

                                                                                                                                                                                                                                                                                                                                                            * Untrusted (未信任)：來自 Skills.mp 或 GitHub 搜尋的原始 Zip/Repo。
                                                                                                                                                                                                                                                                                                                                                            * 處置：只能下載至 quarantine/ 目錄，嚴禁賦予執行權限（chmod -x）[貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                            * Candidate (候選)：經過 Skill Seeker 的「清洗」與「重打包」。
                                                                                                                                                                                                                                                                                                                                                            * 處置：移除了潛在的惡意腳本（如 curl | bash），並補齊了 Schema 與 Hash 封印 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                            * Trusted (受信任)：通過了 Skill Ingestion Gate 的所有檢查（包含靜態掃描與雙法官審查）。
                                                                                                                                                                                                                                                                                                                                                            * 處置：進入 docops/registry/skills/approved/，並寫入 skills_allowlist.yaml [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                            * Vendorize (收編內化)

                                                                                                                                                                                                                                                                                                                                                               * 原則：所有外部技能必須 Vendorize（複製入庫並鎖定版本）。
                                                                                                                                                                                                                                                                                                                                                               * 禁止動態依賴：嚴禁在 Runtime（如 npm install 或 git clone）動態拉取外部技能。所有技能代碼必須存在於本 Repo 中，並受 Git 版控與 Artifact Attestations 保護，確保供應鏈安全 [貼上的文字][Skill 生態指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                               * 供應鏈投毒防護

                                                                                                                                                                                                                                                                                                                                                                  * 靜態掃描：使用 Regex 掃描候選技能中是否包含修改 .github/workflows、讀取 SECRETS 或外連特定 IP 的代碼。
                                                                                                                                                                                                                                                                                                                                                                  * Fail-Closed：若發現任何可疑特徵，直接刪除並報警，不予進入沙盒測試 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt][貼上的文字]。
________________

6. 模組化核心元件 III：HookKit (Hook 一等公民)
________________


6.1 Hook Registry 與契約 (Hook Registry & Contracts)
1. 核心定義：HookKit 作為標準介面層
在 C-Plus 架構中，Hook 不再是開發者隨意撰寫的 post-script 或隱藏的 if-else 邏輯。為了滿足「可稽核、可回放」的硬約束，所有 Hook 必須被標準化為 HookKit。
                                                                                                                                                                                                                                                                                                                                                                  * 一等公民地位：Hook 必須像 Skill 一樣，擁有自己的 身份（Identity）、版本（Version） 與 契約（Contract）。
                                                                                                                                                                                                                                                                                                                                                                  * 介面標準化：Hook 是連接 控制平面（GitHub Actions/Rulesets） 與 執行平面（Codespaces/Local） 的共同語言。它確保無論是在開發者本機還是 CI 環境中，觸發的邏輯與產出的證據皆一致,。
                                                                                                                                                                                                                                                                                                                                                                  * 反平台化設計：Hook 的治理完全依賴 Repo 內的檔案結構（File-based Governance），嚴禁建立額外的資料庫或常駐服務來管理 Hook 狀態,。
2. Hook Registry 結構 (The Registry)
所有被系統承認的 Hook 必須在 docops/registry/hooks/registry.yaml 中進行註冊。未在此檔案中定義的腳本執行，一律視為「非法操作（Illegal Operation）」，GateKit 將拒絕認可其產出,。
2.1 Registry Schema (registry.yaml)
Registry 檔案必須包含以下核心欄位，以定義 Hook 的行為邊界：
欄位名稱
	定義與要求
	目的 (Fail-Closed)
	id
	唯一識別碼 (如 hook.pre_commit.lint)
	確保可被 Router 引用與 Trace Map 追蹤。
	trigger
	觸發時機 (如 pre-commit, post_use, merge_group)
	明確定義該 Hook 在生命週期中的位置，防止亂序執行。
	scope
	影響範圍 (如 *.py, docs/, global)
	限制 Hook 的寫入權限，防止越權修改 Workflow 設定檔。
	required_artifacts
	必產工件 (如 lint_report.json, hook_evidence.json)
	定義證據契約。若執行後缺檔，視為執行失敗。
	gates
	對應閘門 (如 G2_format)
	將 Hook 的產出連結到特定的機械閘門，作為放行依據。
	stopline
	阻斷級別 (Warning / Block)
	定義失敗時的行為。涉及合流的 Hook 必須設為 Block。
	owner
	維護者/來源 (如 core-team, vendor-x)
	供應鏈管理，標示該 Hook 是內部核心還是外部引入。
	2.2 註冊範例
# docops/registry/hooks/registry.yaml
hooks:
  - id: "hook.core.input_seal"
    trigger: "on_workflow_start"
    scope: "inputs/"
    required_artifacts: ["source_bundle_sha256", "input_manifest.json"]
    stopline: "Block"
    description: "Calculates SHA256 for all inputs to prevent bait-and-switch."


  - id: "hook.dev.lint"
    trigger: ["pre-commit", "pull_request"]
    scope: "src/**/*.py"
    required_artifacts: ["lint_report.json"]
    stopline: "Block"
    description: "Standard linter enforcement."


3. Hook Contracts (Schema & Artifacts)
為了確保 Hook 的產出可被機械驗證，每個 Hook 必須遵守 I/O 契約。這防止了 Hook 變成「黑箱腳本」，確保其行為是確定性（Deterministic）的,。
3.1 契約定義 (hooks/contracts/)
                                                                                                                                                                                                                                                                                                                                                                  * Schema 驗證：每個 Hook 的輸出必須通過 docops/registry/hooks/contracts/*.jsonschema 的驗證。
                                                                                                                                                                                                                                                                                                                                                                  * 格式統一：強制要求所有 Hook 產出 JSON 格式 的報告（如 lint_report.json），嚴禁只輸出 Console Log 或非結構化文本。
                                                                                                                                                                                                                                                                                                                                                                  * Fail-Closed：若 Hook 執行成功（Exit Code 0）但產出的 JSON 格式錯誤或欄位缺失，GateKit 必須判定為 FAIL。
3.2 證據產出 (hook_evidence.json)
除了業務產物（如 Lint 報告），每個 Hook 執行後必須產出標準化的 證據元數據 (Evidence Metadata)，包含：
                                                                                                                                                                                                                                                                                                                                                                  * execution_time: 執行時間戳記。
                                                                                                                                                                                                                                                                                                                                                                  * tool_version: 使用的工具版本（如 black==23.1.0）。
                                                                                                                                                                                                                                                                                                                                                                  * input_hash: 輸入檔案的雜湊值（證明是針對當前代碼執行的）。
                                                                                                                                                                                                                                                                                                                                                                  * exit_code: 執行結果狀態碼。
這份證據是用於 可回放 (Replayability) 的關鍵。當 CI 失敗時，開發者可依據 hook_evidence.json 中的版本與 Hash 在本地重現錯誤,。
4. 治理與阻斷機制 (Governance & Fail-Closed)
Hook Registry 與 Contracts 不僅是文件，更是 執行時期的硬性約束。
4.1 非法執行阻斷
                                                                                                                                                                                                                                                                                                                                                                  * 規則：在 CI 流水線中，任何試圖執行的腳本若未在 registry.yaml 中註冊，系統將拒絕執行或標記為 Untrusted。
                                                                                                                                                                                                                                                                                                                                                                  * 防禦：這有效防止了供應鏈攻擊中常見的「惡意腳本注入」，確保只有受控的程式碼能參與合流決策,。
4.2 證據缺口阻斷 (Evidence Gap Block)
                                                                                                                                                                                                                                                                                                                                                                  * 規則：若 Hook 宣告了 required_artifacts 但執行後未產出對應檔案。
                                                                                                                                                                                                                                                                                                                                                                  * 處置：視為 證據鏈斷裂 (Broken Evidence Chain)，GateKit 直接判定 FAIL，不允許進入下一步驟或 Merge Queue。
4.3 繞過防禦 (Bypass Prevention)
                                                                                                                                                                                                                                                                                                                                                                  * Local Hooks 限制：明確承認 Local Git Hooks (如 pre-commit) 可被 --no-verify 繞過。因此，Registry 中標記為 Block 的 Hook，必須在 GitHub Actions (Required Checks) 中強制重跑，絕不信任本地端的 PASS 結果,。
通过 Hook Registry 與 Contracts 的標準化，我們將「腳本執行」提升為「契約履行」，確保了自動化流程的每一步都是透明、可控且不可抵賴的。
________________


6.2 三層 Hook 分工體系 (Three-Layer Hook Architecture)
在 C-Plus 架構中，單一層級的 Hook 無法同時滿足「快速回饋」與「絕對安全」。因此，本架構強制執行三層分工，明確規定：Local Hooks 是為了開發者的效率（早期止血），GitHub Events Hooks 才是系統的權威（唯一放行門檻）。
6.2.1 第一層：Local Git Hooks（早期止血）
此層級運行於開發者的本地環境或 Codespaces 的互動式 Session 中。其定位是 「可繞過的便利設施」，絕不可作為最終的合流依據。
                                                                                                                                                                                                                                                                                                                                                                  * 職責定位：

                                                                                                                                                                                                                                                                                                                                                                     * 早期止血 (Early Stop)：在代碼離開開發者電腦前，攔截最基本的低級錯誤（如 JSON 格式錯誤、顯而易見的 Lint 失敗）。這縮短了「修正迴圈」，避免無意義的 CI 等待時間,。
                                                                                                                                                                                                                                                                                                                                                                     * Dev Skills 串接：Local Hooks 可驅動輕量級的 Dev Skills（如 skill.lint），產出 local_evidence.json 供開發者自查。
                                                                                                                                                                                                                                                                                                                                                                     * 觸發時機與實作：

                                                                                                                                                                                                                                                                                                                                                                        * pre-commit：執行快速的 Lint、Format Check、Schema Validation,。
                                                                                                                                                                                                                                                                                                                                                                        * pre-push：執行 tools/validate_all.py 的子集，確保推送到遠端前至少通過基本的機械驗證。
                                                                                                                                                                                                                                                                                                                                                                        * Fail-Closed 風險管控：

                                                                                                                                                                                                                                                                                                                                                                           * 不可信原則 (Untrusted)：架構明確承認 Git Hooks 可以被開發者使用 git commit --no-verify 指令繞過,。
                                                                                                                                                                                                                                                                                                                                                                           * 權限剝奪：因此，Local Hooks 的 PASS 狀態在控制平面（GitHub）被視為 無效（Null）。控制平面必須在 CI 環境中重新執行所有關鍵檢查，絕不信任本地端的結果。
6.2.2 第二層：Codespaces Lifecycle Hooks（環境一致性）
此層級負責確保執行平面（Execution Plane）的 「可重現性 (Reproducibility)」，防止「在我機器上可以跑（Works on my machine）」的環境漂移。
                                                                                                                                                                                                                                                                                                                                                                           * 職責定位：

                                                                                                                                                                                                                                                                                                                                                                              * 環境固化 (Environment Hardening)：確保所有 Agent 與人類開發者都在完全一致的「工廠環境」中作業。
                                                                                                                                                                                                                                                                                                                                                                              * 工具鏈鎖定 (Toolchain Locking)：防止因 Linter 或 Compiler 版本不同導致的假性失敗或通過,。
                                                                                                                                                                                                                                                                                                                                                                              * 觸發時機與實作 (devcontainer.json)：

                                                                                                                                                                                                                                                                                                                                                                                 * postCreateCommand：在容器創建時觸發。用於安裝指定版本的 Hook 工具鏈（如 pre-commit install）、下載 hooks/registry.yaml 定義的依賴,。
                                                                                                                                                                                                                                                                                                                                                                                 * postStartCommand：在容器啟動時觸發。用於啟動 Supervisor 守護進程，檢查環境健康度（如 Auth Token 是否過期）。
                                                                                                                                                                                                                                                                                                                                                                                 * Agent 行為約束 Hooks： 除了環境配置，此層級還定義了 Agent 運行時的行為鉤子：

                                                                                                                                                                                                                                                                                                                                                                                    * post_use / post_tool_execution (格式化鉤子)：每當 Agent 修改代碼後，強制執行 Formatter（如 Prettier/Black）。若格式化後產生 Diff，視為 Agent 未遵守規範，標記為 FAIL,,。
                                                                                                                                                                                                                                                                                                                                                                                    * stop_use (超時攔截)：針對長運行任務設定 stop_use 鉤子。若任務執行超過預設時間（如 10 分鐘），強制中斷並產出 stop_report.json，防止無限迴圈消耗資源,,。
6.2.3 第三層：GitHub Events Hooks（唯一放行門檻）
此層級是 HookKit 的 最高權力機構。只有掛載在 GitHub Actions / Merge Queue 上的 Hook，才擁有「決定 PR 是否能合併」的 放行權 (Merge Authority)。
                                                                                                                                                                                                                                                                                                                                                                                    * 職責定位：

                                                                                                                                                                                                                                                                                                                                                                                       * 上鎖的門 (The Locked Door)：這是唯一不可繞過的檢查點。無論 Local Hook 是否通過，這裡說 FAIL 就是 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                       * 唯一裁判 (The Sole Judge)：所有 GateKit 的邏輯（機械閘門、語義裁判）都必須在此層級執行，並產出最終的 verdict.json 和 Evidence Bundle。
                                                                                                                                                                                                                                                                                                                                                                                       * 觸發時機與關鍵坑點：

                                                                                                                                                                                                                                                                                                                                                                                          * pull_request：當 PR 開啟或更新時觸發，執行輕量級檢查。
                                                                                                                                                                                                                                                                                                                                                                                          * merge_group (關鍵)：這是 Merge Queue 運作的必要條件。所有 Required Checks 的 Workflow 必須 顯式監聽 merge_group 事件。
                                                                                                                                                                                                                                                                                                                                                                                          * Fail-Closed 機制：若漏掉 merge_group 觸發，PR 進入合併隊列後，Required Checks 將不會被觸發，導致隊列因等待狀態回報而 無限卡死 (Queue Deadlock) 或直接失敗,,。
                                                                                                                                                                                                                                                                                                                                                                                          * 映射關係 (Hooks-as-Gates)：

                                                                                                                                                                                                                                                                                                                                                                                             * 將 Local 的 pre-commit 邏輯映射為 CI 中的 G2 Schema / Lint Gate。
                                                                                                                                                                                                                                                                                                                                                                                             * 將 Lifecycle 的 post_use 邏輯映射為 CI 中的 Format Gate (Dirty Check)。
                                                                                                                                                                                                                                                                                                                                                                                             * 這確保了「本地的方便」與「中央的嚴謹」在邏輯上的一致性，但執行上是隔離的,。
________________


表 6-2：三層 Hook 分工與權限對照表
層級 (Layer)
	執行環境 (Runtime)
	觸發時機 (Triggers)
	核心職責 (Responsibility)
	放行權限 (Authority)
	繞過風險 (Bypass Risk)
	來源
	L1 Local
	本地 / Codespaces (Interactive)
	pre-commit, pre-push
	早期止血。提供快速回饋，減少 CI 排隊浪費。
	無 (Null)
	高 (--no-verify)
	,
	L2 Lifecycle
	Codespaces Container (Build time)
	postCreate, postStart, post_use
	環境一致性。鎖定工具版本，約束 Agent 行為。
	無 (輔助)
	中 (可手動修改容器)
	,
	L3 GitHub
	GitHub Actions (Headless)
	pull_request, merge_group
	唯一放行門檻。執行 GateKit，決定 PR 生死。
	絕對 (Absolute)
	無 (Rulesets 鎖死)
	,
	此分工體系確保了 Hook 不再是散亂的腳本，而是構成「可稽核、可回放、Fail-Closed」治理體系的關鍵骨架。
________________

7. 模組化核心元件 IV：GateKit 與雙法官體系 (GateKit)

________________
7.1 機械閘門 (Deterministic Gates)
7.1.1 核心定義：硬保底與零幻覺 (Hard Floor & Zero Hallucination)
在「零人工核准」的架構下，機械閘門負責攔截所有結構性與邏輯性的低級錯誤，確保進入雙法官審查的內容至少在「格式與範圍」上是合規的。
                                                                                                                                                                                                                                                                                                                                                                                             * 100% 確定性 (Deterministic)：

                                                                                                                                                                                                                                                                                                                                                                                                * 無模型參與：所有檢查皆由 Python/Shell 腳本執行，結果只有 PASS (1) 或 FAIL (0)，不存在「可能」、「也許」的模糊空間 [GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                * 機械保證：能對結構化覆蓋、不變量（Invariants）與引用完整性做出 100% 的數學保證 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                * Fail-Closed (預設阻斷)：

                                                                                                                                                                                                                                                                                                                                                                                                   * 任何腳本執行錯誤、檔案缺失、Hash 不符或欄位不符，預設狀態均為 FAIL。系統不進行「合理推測」或嘗試自動修復非預期的異常 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                   * 執行環境：

                                                                                                                                                                                                                                                                                                                                                                                                      * 必須在 GitHub Actions (Control Plane) 中執行，作為 Merge Queue 的 Required Checks [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
________________


7.1.2 G0 Input Seal：輸入封印與防換料
此閘門用於確保「輸出是由指定的輸入產生」，防止流程中途發生「換料偷跑（Bait-and-Switch）」或「上下文污染」。
                                                                                                                                                                                                                                                                                                                                                                                                      * 檢查邏輯：

                                                                                                                                                                                                                                                                                                                                                                                                         * 在 Stage 1 (Normalize) 階段，系統會對所有有效輸入（文檔、對話紀錄、參考代碼）進行 SHA-256 雜湊計算，生成唯一的 source_bundle_sha256 並寫入 input_manifest.json [DocOps 多代理自動化與治理_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                         * G0 Gate 會在後續每個 Stage (Draft, Review, Final Audit) 重新計算當前輸入的 Hash，並與 input_manifest.json 中的紀錄比對 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                         * 阻斷條件 (Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                            * 若 Hash 不一致，視為輸入被篡改或版本漂移，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                            * 若 input_manifest.json 遺失或格式錯誤，直接 FAIL [貼上的文字]。
________________


7.1.3 G1 Coverage Gate：數學級別的不遺漏
此閘門將「全量理解」從口頭承諾轉化為可計算的數學指標，確保所有需求與決策都有落點。
                                                                                                                                                                                                                                                                                                                                                                                                            * 計算公式： $$Coverage Rate = \frac{Covered_IDs}{Total_IDs}$$

                                                                                                                                                                                                                                                                                                                                                                                                               * Total_IDs：來自 normalized.jsonl (IR) 中所有類型為 REQ, DEC, ASM, RISK 的唯一 ID [5 份筆記_升級方案+討論紀錄][Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                               * Covered_IDs：掃描 trace_map.json 或最終文檔中實際引用到的 ID 集合 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                               * 殘差檢測 (Residual Check)：

                                                                                                                                                                                                                                                                                                                                                                                                                  * 計算 Unmapped_Atoms（未被引用的原子）。若 Unmapped_Atoms > 0，視為 需求蒸發 (Omission) [貼上的文字][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                  * PASS 門檻：

                                                                                                                                                                                                                                                                                                                                                                                                                     * 預設要求 Coverage $\ge$ 98%（或 residual == 0）。
                                                                                                                                                                                                                                                                                                                                                                                                                     * 若有允許的例外，必須列在 docops/registry/coverage_exceptions.yaml 中，並附帶明確理由與到期日（Expiry） [貼上的文字][Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                     * 阻斷條件：

                                                                                                                                                                                                                                                                                                                                                                                                                        * 覆蓋率低於門檻，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                        * 發現未映射的 Critical Requirement (must_hold=true)，直接 FAIL [貼上的文字]。
________________


7.1.4 G2 Trace Gate：引用鏈與 No-Source-No-Norm
此閘門執行「無來源即無規範」的硬性檢查，防止幻覺或未授權的擴張。
                                                                                                                                                                                                                                                                                                                                                                                                                        * 檢查邏輯：

                                                                                                                                                                                                                                                                                                                                                                                                                           * 雙向追蹤：檢查 trace_map.json 的完整性。每個輸出的邏輯段落（Paragraph）必須回指至少一個 Source ID [GitHub Multi-Agent DocOps_方案A][Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                           * 引用合規：檢查外部引用（External Citations）是否包含「來源 URL + 日期」 [DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                           * 阻斷條件 (Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                                              * No-Source Claim：若發現新增的主張（Claim）沒有對應的來源 ID 或外部引用，視為「憑空創作」，直接 FAIL [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                              * Dead Link/No Date：若外部引用缺乏日期或來源不可追溯，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
________________


7.1.5 G3 Drift-Heuristic：反平台化與範圍鎖定
此閘門利用正則表達式（Regex）與關鍵字清單，進行初階的漂移獵殺，特別針對「平台化敘事」與「權限越界」。
                                                                                                                                                                                                                                                                                                                                                                                                                              * 反平台化掃描 (Anti-Platforming)：

                                                                                                                                                                                                                                                                                                                                                                                                                                 * 工具：使用 docops/registry/policies/anti_platform.regex 清單掃描全文 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                 * 禁詞範例："Unified Platform", "Global Governance Hub", "Grand Console" [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                 * 判定：命中任何禁詞，直接判定 P0 FAIL，不允許使用 Allowlist 豁免 [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                 * 範圍鎖定 (Scope Lock)：

                                                                                                                                                                                                                                                                                                                                                                                                                                    * 檢查：掃描 PR 的 Diff 是否觸及 scope_write.yaml 定義的禁止路徑（如 .github/workflows 或核心 SSOT 的非 Patch 區域） [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                    * 判定：若 Agent 試圖修改禁區，直接 FAIL [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                    * 不變量檢查 (Invariant Check)：

                                                                                                                                                                                                                                                                                                                                                                                                                                       * 掃描 normalized.jsonl 中標記為 must_hold=true 的 ID。若這些 ID 在文檔中消失，視為核心約束被刪除，直接 FAIL [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
________________


7.1.6 G_Artifact：產物完整性與 Schema 校驗
此閘門負責驗證所有中間產物與最終交付物的「物理完整性」，防止 AI 輸出無效格式導致流程崩潰。
                                                                                                                                                                                                                                                                                                                                                                                                                                       * Schema 驗證：

                                                                                                                                                                                                                                                                                                                                                                                                                                          * 所有 JSON 產物（verdict.json, trace_map.json, gate_report.json）必須通過 docops/schemas/*.schema.json 的驗證 [5 份筆記_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                          * Fail-Closed：若 JSON 格式錯誤（如多餘逗號、Markdown 包裹）或缺必要欄位，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                          * 檔案存在性：

                                                                                                                                                                                                                                                                                                                                                                                                                                             * 檢查 Evidence Bundle 是否包含所有必要檔案（如 run_manifest.json, diff_report.md）。缺檔即 FAIL [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
________________


7.1.7 閘門規格匯總表
閘門代號
	名稱
	檢查對象
	Pass 條件 (Threshold)
	Fail 行為 (Fail-Closed)
	來源
	G0
	Input Seal
	source_bundle_sha256
	Hash 完全一致
	阻斷。視為換料欺詐。
	[DocOps 方案A]
	G1
	Coverage
	normalized.jsonl vs Doc
	覆蓋率 $\ge$ 98% (或殘差=0)
	阻斷。視為需求蒸發。
	[Spec Kit 升級]
	G2
	Trace
	trace_map.json
	所有 Claim 皆有 Source ID
	阻斷。視為幻覺。
	[DocOps 方案A]
	G3
	Drift
	全文 regex 掃描
	禁詞命中數 = 0
	阻斷 (P0)。視為架構漂移。
	[貼上的文字]
	G_Art
	Artifact
	JSON 檔案
	通過 JSON Schema 驗證
	阻斷。視為產物損壞。
	[Ralph 升級]
	________________


7.2 語義閘門 (Semantic Gates)
7.2.1 核心定義：語義轉譯與機械優先 (Semantic Translation & Mechanical First)
在「人只看 PASS」的自動化架構下，語義閘門不允許輸出模糊的自然語言評論（如 "Looks good"），必須將語義理解「降維」為機器可執行的 JSON 判決書（Verdict Artifacts）。
                                                                                                                                                                                                                                                                                                                                                                                                                                             * 機械優先原則 (Mechanical First)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                * 順序：只有當前置的 機械閘門（G0 Input Seal, G1 Coverage, G2 Trace, G3 Drift-Heuristic）全部通過後，才會啟動語義閘門。
                                                                                                                                                                                                                                                                                                                                                                                                                                                * 目的：避免昂貴的 AI 算力（Token/Time）浪費在檢查低級錯誤（如 JSON 格式錯誤或來源 Hash 不符）上。若機械層未通過，流程直接阻斷 (Fail-Closed)，絕不進入語義審查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                * 語義轉譯機制 (Translation Mechanism)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 非協作者：AI 在此階段不作為寫作助手（Assistant），而是作為 嚴格的裁判 (Judge)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 輸入依據：裁判必須閱讀 Draft（草案） 與 Coverage Pack（契約），比對兩者的一致性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 狀態鎖定：AI 的輸出必須被 GitHub Actions 解析。若解析失敗或邏輯判定為 FAIL，系統會發佈失敗的 Check Run，直接觸發 Ruleset 阻斷合併。
________________


7.2.2 G4 Dual-Judge Verdict：雙法官一致性裁決
為了克服單一 LLM 的幻覺、盲點與隨機性，系統強制實施 「雙盲審查（Double-Blind Review）」，由兩個不同架構的模型獨立進行判決。
A. 多法官架構 (Multi-Judge System)
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Judge A (Codex/GPT)：專注於 結構化檢查、PR Diff 分析 與 代碼語法。執行於 Codespaces CLI 或 GitHub Native Integration。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Judge B (Claude Code)：專注於 長文檔邏輯連貫性、語義漂移 (Drift) 與 完整性。執行於 Codespaces Headless 環境。
B. JSON 判決契約 (The Verdict Contract)
裁判不得輸出自然語言，必須遵守 verdict.schema.json：
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 強制格式：Prompt 強制約束 Output ONLY valid JSON。嚴禁包含 Markdown 閒聊、前言或後語。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Schema 要求：輸出物件必須包含：
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * verdict: "PASS" 或 "FAIL"（無中間狀態）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * confidence_score: 0.0 - 1.0 的信心指數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * evidence_list: 引用證據指針（Source Anchors）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * findings: 具體的違規事項清單。
C. 分歧即阻斷 (Disagreement as Fail)
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 嚴格一致性：PASS 必須是兩位法官的一致結論。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Fail-Closed：若 Judge A 判定 PASS 但 Judge B 判定 FAIL（意見分歧），系統 不取平均值，不進行人工裁決，直接判定 FAIL。這被視為風險訊號，強迫進入下一輪修補 (Stage 4)。
D. 抗偏誤協定 (Anti-Bias Protocol)
鑑於學術研究指出 LLM 作為裁判時存在顯著的 位置偏誤 (Position Bias) 與 評分偏誤 (Scoring Bias)，系統必須引入工程手段進行對沖。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Swap Order (位置交換測試)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 機制：針對 A/B 方案比較或排序題，系統強制交換候選答案的順序（Candidate A vs B -> Candidate B vs A），要求法官重新評分。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 判定：若兩次評分結果發生翻轉或差異超過閾值（例如 $\Delta > 1$ 分），視為模型對位置敏感，判決不可信，直接 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Prompt Perturb (提示擾動測試)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 機制：使用語義等價但表述不同的 Prompt（Rubric Variants）進行二次確認。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 判定：若對同一內容的判決因提示詞微擾而改變，視為模型不穩（Flaky），判定 FAIL。
________________


7.2.3 G5 Invariant Check：不可變量與語氣弱化檢測
此閘門專門獵殺 「語義上的退讓」，防止規範在迭代中被潛移默化地削弱。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Tone Dilution (語氣弱化) 檢測：
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 針對對象：針對原始契約（Normalized IR）中標記為 must_hold=true 的 決策 (DEC) 與 假設 (ASM)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 檢查邏輯：檢查其語義強度是否被弱化。例如，若原始定義為「必須 (MUST)」，最終文檔變成「建議 (SHOULD)」、「視情況」或刪除了關鍵限定詞。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 判定：若發現未經授權的語義稀釋，直接 FAIL。
________________


7.2.4 G_Drift：語義飄移獵殺
語義閘門的核心任務是獵殺那些「通過了 Regex 檢查但語義上仍違規」的內容。
                                                                                                                                                                                                                                                                                                                                                                                                                                                   * No-Source-No-Norm (無來源即無規範)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 引用式批評：裁判在指控錯誤或通過條款時，必須引用具體的 IR ID（如 [REQ-001]）或 Diff Hunk ID。
                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 雙向驗證：
                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若 Judge 指控了錯誤但無法提供具體的引用 ID，視為無效判決 -> FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若 Draft 中出現了新增的主張（Claim）但無法回指到 Coverage Pack 中的 ID，視為幻覺或未授權擴張 -> FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 隱性平台化獵殺 (Implicit Anti-Platforming)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 檢查邏輯：除了 G3 的 Regex 關鍵字掃描外，語義裁判需檢查是否出現「隱性的平台化敘事」（如描述了一個龐大的中央控制台，雖未用禁詞但意圖違規）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 判定：若偵測到試圖繞過「最小檔案約定」的敘事，判定 P0 FAIL。
________________


7.2.5 Drift Allowlist (飄移豁免) 格式與管理
針對無法完全機械化的飄移（Drift），採取「嚴格管理」策略，將例外視為核廢料。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 原則：飄移並非完全禁止，但必須「像核廢料一樣管理」。只有在 docops/registry/drift_exceptions.yaml 中註冊的例外才被允許。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Schema 規範：
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * id: 飄移項目的唯一 ID。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * scope: 影響範圍（檔案/章節）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * reason: 具體理由。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * evidence_ref: 指向某次 Verdict 或 Issue 的證據連結。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * expires_at: 到期日（防止永生免死金牌）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 阻斷邏輯：
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 若發現飄移且未在 Allowlist 中，直接 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 若 Allowlist 中的條目已過期，直接 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 特別條款：must_hold=true 的項目 不得 被 Allowlist 覆蓋（除非經過更高層級的 Constitution 修改程序）。
________________


表 7-2：語義閘門分工與阻斷表
閘門代號
	名稱
	執行者 (Judge)
	檢查重點
	Fail-Closed 阻斷條件
	來源
	G4
	Dual-Judge Verdict
	Codex + Claude
	一致性、邏輯連貫
	A/B 分歧、JSON 解析失敗
	

	G4.1
	Anti-Bias Check
	同上 (Re-run)
	位置偏誤、提示敏感度
	Swap/Perturb 後結果翻轉
	

	G5
	Invariant Check
	Claude Code
	must_hold 條款強度
	MUST $\to$ SHOULD 弱化
	

	G_Drift
	Drift Hunter
	Codex/Claude
	無源新增、平台化敘事
	No-Source Claim、隱性平台化
	

	________________


7.3 特殊閘門 (Special Gates)
特殊閘門是連接「執行過程（Runtime）」與「合流標準（Merge Standard）」的橋樑。不同於 G0~G3 的靜態產物檢查，特殊閘門監控的是 Agent 的 行為模式 與 輸入品質。它們源自複利工程的 Hook 概念與 Spec Kit 的互動指令，但在 C-Plus 架構中被硬化為不可繞過的阻斷點。
7.3.1 Format Gate (格式化鉤子)
此閘門將開發習慣中的「格式化（Formatter）」提升為「一致性防線」，防止 Agent 產出的代碼或文檔因格式混亂導致 Diff 爆炸或隱性 Bug。
                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 來源與映射：

                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 源自 《複利工程指南_筆記》 中的 post_use 或 post_tool_execution 鉤子概念，原意是防止 Agent 寫出格式錯誤的代碼 [複利工程指南_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 在 《GitHub Multi-Agent DocOps_方案A》 中被硬化為 format_hook_gate，並列入補丁骨架 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 執行邏輯 (Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 觸發時機：在 Agent 完成寫入操作後（Post-run），或在 GitHub Actions 的 pull_request 階段 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 強制動作：系統執行標準化工具（如 Prettier, Black, Ruff）對變更檔案進行格式化。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 阻斷條件 (Dirty Check)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 執行格式化後，系統檢查工作樹（Working Tree）是否乾淨（git status --porcelain）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 若產生了新的 Diff，代表 Agent 提交的內容未遵守格式規範 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 處置：直接判定 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 禁止自動 Commit：嚴禁 CI 自動提交這些變更（因為這會破壞 Artifact Attestations 的簽章與 Commit 歷史的原子性）[GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 退回修正：必須退回要求 Agent 修正其輸出格式，直到符合規範。
                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 證據產出：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * format_report.json：記錄變更的檔案清單與違規規則，作為 Agent 學習（Wrongbook）的依據 [GitHub Multi-Agent DocOps_架構指南]。
7.3.2 Timeout Stop Gate (超時攔截)
此閘門針對長運行任務（Long-running tasks）或潛在的無限迴圈（Infinite Loops）設下物理止損點，防止自動化變成「自動燒錢」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 來源與映射：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 源自 《複利工程指南_筆記》 中的 stop_use 鉤子 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 源自 《Ralph for Claude Code解析_筆記》 的熔斷機制（Circuit Breaker）與速率限制 [Ralph for Claude Code解析_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 在 《GitHub Multi-Agent DocOps_方案A》 中定義為 timeout_stop_gate [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 執行邏輯 (Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 閾值設定：每個 Job 必須設定硬性的 timeout-minutes（如 GitHub Actions 預設）或 Ralph 的 max_iterations（迭代上限，建議 3-5 次）[DocOps 多代理自動化與治理_筆記][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 超時 (Timeout)：若任務執行時間超過預設閾值（如 10 分鐘）[GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 震盪 (Oscillation)：若 Ralph 偵測到代碼在 A/B 狀態間反覆修改（Hash 重複出現），視為收斂失敗 [Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 處置：觸發 Hard Stop。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 系統強制殺死進程。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 標記狀態為 BLOCKED 或 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 拒絕合流：拒絕任何「部分完成」的產出進入合流隊列 [GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 證據產出：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * stop_report.json：記錄中斷時間、最後執行的步驟與重跑策略（Retry Policy）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * breaker_event.json：若由 Ralph 熔斷器觸發，記錄震盪的 Hash 值與原因 [Ralph_升級方案+討論紀錄]。
7.3.3 Ambiguity Gate (歧義檢查)
此閘門位於工作流的最前端（Stage 0.5），利用 Spec Kit 的 ask 機制，強制消除需求中的模糊地帶，防止 LLM 自行腦補（Hallucination）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 來源與映射：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 源自 《Spec Kit项目解析_筆記》 的 ask 指令（主動詢問 5 個關鍵問題）[Spec Kit项目解析_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 在 《Spec Kit_升級方案+討論紀錄》 與 《方案A++》 中被制度化為 Ambiguity Gate [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 執行邏輯 (Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 分析：Agent 分析輸入的 normalized.jsonl（IR），識別定義不清的術語、邊界條件或邏輯衝突。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 產出：生成 ambiguity_report.json，其中包含 ambiguous_items[] 清單，每項標記 blocking=true/false [Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 若存在 blocking=true 的項目（例如涉及核心安全、驗收標準的模糊點）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 若模糊點涉及 must_hold 的不變量（Invariants）[GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 處置：直接 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 系統拒絕進入 Stage 2 Draft 階段。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 要求使用者補充 clarifications.md 或更新輸入來源，嚴禁 Agent 在此階段「自行假設」以求過關 [Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 證據產出：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * ambiguity_report.json：明確列出哪些需求是模糊的，以及是否構成阻斷條件，作為需求品質的審計紀錄 [Spec Kit_升級方案+討論紀錄]。
________________


表 7-3：特殊閘門配置總表
閘門名稱
	觸發階段
	執行環境
	核心檢查項目
	Fail-Closed 處置
	來源
	Ambiguity Gate
	Stage 0.5 (Pre-Draft)
	Codespaces / Actions
	需求模糊度、定義缺失
	發現 Blocking 歧義即中止，禁止腦補
	[Spec Kit], [方案A++]
	Format Gate
	Post-Run / PR
	Actions
	git status --porcelain (Dirty Check)
	有 Diff 即 FAIL，禁止自動 Commit
	[複利工程], [方案A]
	Timeout Stop
	Runtime Loop
	Actions / Codespaces
	執行時長、震盪計數
	強制殺進程，標記 BLOCKED
	[Ralph], [方案A]
	此設計確保了從「需求輸入」、「執行過程」到「最終產出」的每一個動態環節，都有對應的機械化閘門把守，消除了人工檢查的盲區，符合「零人工核准」的最高指導原則。
依據您提供的 38 份來源（含基礎方案、5 份筆記、升級方案、深度討論紀錄及貼上的文字），以下針對 「GitHub Multi-Agent (模組化 Core + 4 Profiles) 架構指南」 之 「7.4 雙法官與抗偏誤協定」 章節進行全量展開。
本章節定義了取代「人工 Review」的核心機制。為了克服單一 LLM 的幻覺、偏誤（Bias）與隨機性，本架構強制實施 雙盲審查（Double-Blind Review） 與 對抗性測試（Adversarial Testing）。這不是為了追求完美，而是為了建立一個「可被機械驗證的信任基礎」。
________________


7.4 雙法官與抗偏誤協定 (Dual-Judge & Anti-Bias Protocol)
在「零人工核准」的硬約束下，我們不能信任單一 LLM 的判決。學術研究與實務皆證實，LLM 作為裁判時存在顯著的 位置偏誤 (Position Bias)、長度偏誤 (Verbosity Bias) 與 自我偏好 (Self-Preference),,。因此，本架構強制引入「雙法官 + 抗偏誤測量」機制，將主觀的「覺得不錯」轉化為客觀的「一致性指標」。
7.4.1 多法官架構：分工與隔離 (Judge A + Judge B)
為了確保審查的全面性與獨立性，系統指派兩個不同架構的模型擔任法官，並賦予不同的審查職責。它們在 Codespaces 執行平面 獨立運作，產出 JSON 判決書，嚴禁在 GitHub Actions 控制平面直接執行互動式推理,,。
A. Judge A：結構與語法裁判 (The Structure Judge)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 執行模型：Codex CLI (via GPT Plus 訂閱) 或 GPT-4o,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 核心職責：專注於 微觀層面（Micro-level） 的檢查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * PR Diff 分析：檢查變更是否符合 scope_write 限制。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 代碼語法與 Lint：驗證代碼片段的語法正確性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * JSON Schema 驗證：確保所有產出物符合 I/O 契約。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 執行環境：Codespaces CLI / Non-interactive mode,。
B. Judge B：邏輯與語義裁判 (The Logic Judge)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 執行模型：Claude Code (via Claude Max 訂閱),。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 核心職責：專注於 宏觀層面（Macro-level） 的檢查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 長文檔邏輯連貫性：檢查前後文是否矛盾。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 語義漂移 (Drift)：檢查是否弱化了 must_hold 的不變量（Invariant）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 反平台化敘事：檢查是否出現隱性的「大一統平台」描述。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 執行環境：Codespaces Headless,。
C. 判決契約 (The Verdict Contract)
兩位法官不得輸出自然語言，必須輸出符合 verdict.schema.json 的結構化資料。若 Actions 無法解析 JSON，視為 System Error，直接阻斷,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * verdict: "PASS" 或 "FAIL"（無中間狀態）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * confidence_score: 0.0 - 1.0 的信心指數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * findings: 違規事項清單，每項必須包含 violated_rule_id 與 evidence_ptr（引用來源指針）,。
________________


7.4.2 抗偏誤測試 I：位置交換 (Swap Order)
位置偏誤（Position Bias）是指 LLM 傾向於偏好出現在特定位置（通常是第一個或最後一個）的內容。為了消除此雜訊，系統強制執行 位置交換測試,,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 測試機制：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Run 1 (Original)：將待審查內容（Candidate）與基準（Baseline）按 [Candidate, Baseline] 順序輸入給法官，獲取評分 $S_1$。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Run 2 (Swapped)：將順序對調為 [Baseline, Candidate]，再次輸入給同一位法官，獲取評分 $S_2$,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 一致性計算 (Consistency Metric)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 計算兩次評分的差異 $\Delta = |S_1 - S_2|$ 或判決結果是否翻轉（Flip）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Fail-Closed 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 若 $\Delta$ 超過設定閾值（例如 > 1 分）或結果翻轉（PASS $\to$ FAIL），視為模型對位置敏感，判決不可信 -> FAIL,,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 此機制強制要求法官的判決必須具備「位置不變性（Position Invariance）」,。
________________


7.4.3 抗偏誤測試 II：提示擾動 (Prompt Perturb)
為了檢測模型是否對提示詞（Prompt）過度敏感（Prompt Sensitivity），系統引入擾動測試,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 測試機制：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 使用語義等價但表述不同的 Prompt（Rubric Variants）進行二次確認。例如，將 "Check for syntax errors" 改寫為 "Verify code syntactical correctness"。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Fail-Closed 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 若同一內容在微擾後的 Prompt 下得到不同的判決（Inconsistent Verdict），視為模型不穩（Flaky） -> FAIL,。
________________


7.4.4 阻斷邏輯：分歧即失效 (Disagreement as Fail)
在雙法官體系中，我們不追求「多數決」，而是追求「共識」。任何分歧都被視為風險訊號。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 嚴格一致性 (Strict Agreement)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 最終 PASS 的條件是：(Judge A == PASS) AND (Judge B == PASS) AND (Bias_Check == PASS),,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 禁止取平均 (No Averaging)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 若 Judge A 判定 PASS 但 Judge B 判定 FAIL，系統 嚴禁 取平均值或權重計算。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 處置：直接判定 FAIL。這代表兩位法官對品質有不同解讀，代碼或文檔存在模糊地帶，必須退回修正 (Stage 4),,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 確定性聚合器 (Deterministic Aggregator)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 最終的判決彙整由一個純 Python 腳本（judge_aggregate.py）執行，而非另一個 LLM。這確保了判決邏輯是透明、固定且可審計的,,。
表 7-4：雙法官裁決矩陣
Judge A (Codex)
	Judge B (Claude)
	Bias Check (Swap/Perturb)
	Final Verdict
	Action
	PASS
	PASS
	Stable
	PASS
	進入 Merge Queue
	PASS
	FAIL
	-
	FAIL
	退回 Repair Loop
	FAIL
	PASS
	-
	FAIL
	退回 Repair Loop
	PASS
	PASS
	Unstable
	FAIL
	標記為 Flaky，需人工介入或重試
	通過此協定，我們將 LLM 從「不可控的黑盒生成者」轉變為「受控的、可量測的品質檢測器」，滿足了架構對 可稽核 (Auditable) 與 可回放 (Replayable) 的核心要求,。
________________

8. 模組化核心元件 V：證據鏈與可回放 (Evidence)

________________
8.1 核心證據工件 (Core Evidence Artifacts)
證據工件（Evidence Artifacts）是 CI 流水線最終產出的核心交付物，必須打包為結構化的 evidence_bundle.zip。若 Evidence Bundle 缺失、結構不符或雜湊鏈斷裂，GateKit 必須依據 Fail-Closed 原則直接判定合流失敗,。
8.1.1 輸入封印與身份證明 (Identity & Seal)
此類別工件用於證明「是誰在跑」以及「跑的是什麼」，防止「換料欺詐（Bait-and-Switch）」與環境漂移。
A. input_manifest.json (輸入清單)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：詳細列出參與本次生成的所有輸入檔案路徑、行數、來源類型（Repo/Web/Transcript）與個別檔案的 Checksum。
Schema 要求：
{
  "run_id": "run-20260127-001",
  "timestamp": "2026-01-27T10:00:00Z",
  "files": [
    { "path": "docs/SRS.md", "sha256": "a1b2...", "source_type": "repo" }
  ],
  "bundle_hash": "e5f6..."
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * Fail-Closed：若 Manifest 格式錯誤或缺欄位，視為無效輸入，拒絕進入 Draft 階段,。
B. source_bundle_sha256 (輸入封印)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：在 Stage 1 (Normalize) 階段，對所有有效輸入進行 SHA-256 雜湊計算生成的唯一指紋。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 作用：此雜湊值必須貫穿整個流水線。Stage 5 Final Audit 時，會重新計算輸入雜湊並與此值比對。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 阻斷條件：若不一致，視為輸入在過程中被篡改（如 Agent 偷偷修改了需求文件以通過測試），直接 P0 FAIL,。
C. run_manifest.json (環境重現)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：記錄執行當下的環境參數，確保「可回放性（Replayability）」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 必要欄位：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * runner_image: Codespaces 或 Actions Runner 的映像檔版本/SHA。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * tool_versions: 執行的工具版本（如 claude-code==0.2.1, black==24.1）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * git_commit: 當前 Repo 的 Commit SHA。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 價值：這是未來的「黑盒子紀錄器」，用於 Production Incident 時重建環境,。
8.1.2 覆蓋率與追蹤 (Coverage & Traceability)
此類別工件用於證明「可驗證地不遺漏（Verifiable Completeness）」與「無來源即無規範（No-Source-No-Norm）」。
A. normalized.jsonl (原子化契約)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：將非結構化輸入轉化為可定址的原子（Atoms）清單。包含 REQ, DEC, ASM, RISK 等類型及其唯一 ID（如 DEC-012）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 地位：這是整個流水線的 不可變真理來源 (Immutable Truth),。
B. trace_map.json (雙向追蹤表)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：記錄「輸出段落」到「輸入原子」的映射關係。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 結構：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Forward Trace: Source_ID -> [Output_Anchor_1, ...]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Backward Trace: Output_Anchor -> [Source_ID_1, ...]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Untraced Claims: 若發現新增的主張無法反查到 Source ID，且未被標記為「推論（Inference）」，視為幻覺，直接 FAIL,。
C. coverage_map.json (覆蓋率報告)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：統計輸入原子在輸出中的落點，計算覆蓋率。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 必要欄位：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * total_requirements: 需求總數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * covered_requirements: 已覆蓋數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * residual_atoms: 未被引用的原子清單（殘差）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 阻斷條件：若 residual_atoms > 0 且未列入 coverage_exceptions.yaml，視為 需求蒸發 (Omission)，直接 FAIL,。
8.1.3 裁決與閘門報告 (Verdicts & Gates)
此類別工件是 Stage 3 (Dual Review) 與 GateKit 的執法紀錄，GitHub Actions 據此決定是否亮綠燈。
A. verdict.json (最終裁決)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：由機械聚合器（Aggregator）生成的最終判決書，非單一 LLM 產出。
結構：
{
  "final_outcome": "PASS",
  "judges": {
    "judge_a": { "model": "Claude", "verdict": "PASS", "score": 0.95 },
    "judge_b": { "model": "Codex", "verdict": "PASS", "score": 0.98 }
  },
  "consistency_check": {
    "swap_consistency": 1.0,
    "perturb_stability": "STABLE"
  }
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 阻斷條件：若 final_outcome 為 FAIL，或 swap_consistency 低於閾值（如 0.9），GitHub Status Check 標記為失敗,,。
B. judges/*.json (原始裁決)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：保留雙法官（Judge A & Judge B）的原始 JSON 輸出，包含具體的 findings（違規事項）與 evidence_ptr（證據指針）。這是審計「為何 FAIL」的依據,。
C. gate_report.json (機械閘門報告)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：匯總所有 Deterministic Gates（如 Schema Check, Regex Scan, Lint）的執行結果。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：當流程 FAIL 時，Ralph 收斂引擎 會讀取此檔案中的 error_code 與 location，進行精確修補,。
D. diff_report.md (變更摘要)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：針對本次修補或生成內容的 Unified Diff 摘要，並附帶對 Drift（漂移）的機械分析（如：是否修改了 must_hold 的段落）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：供人類在最後關頭快速掃描，確認變更範圍未失控,。
8.1.4 技能與執行上下文 (Skill & Execution Context)
此類別工件用於記錄「用了什麼技能」以及「執行的決策路徑」，來自 Agent Skills 與 Ralph 的整合。
A. skillpack.json (技能清單)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：記錄本次任務實際啟用的技能集合、版本鎖定資訊（Commit SHA）與 Token 預算。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：防止供應鏈投毒，確保使用的 Skill 是經過核准的版本,。
B. lane_decision.json (路由決策)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：記錄 Router 分流的依據（如輸入特徵、風險分級）與最終選擇的泳道（Vibe/Spec/Dev/Ops）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：證明系統是依據規則分流，而非隨機選擇,。
C. ambiguity_report.json (歧義報告)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：來自 Stage 0.5 Ambiguity Gate。列出識別出的模糊需求及是否構成阻斷（Blocking）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Fail-Closed：若存在 blocking=true 的項目，流程應在早期終止,。
D. converge_log.jsonl (收斂日誌)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：記錄 Ralph 每一輪迭代的 timestamp、error_target、patch_hash 與 gate_result。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：證明系統是如何一步步收斂的，以及是否觸發過熔斷機制,。
8.1.5 失敗資產化 (Failure Assets)
A. wrongbook_entry.md (錯題本條目)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定義：若本次執行曾失敗並修復，必須包含生成的錯題本條目（Failure Case + Root Cause + Defense）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 用途：證明已進行學習回寫，實現 複利工程。若修復了 FAIL 但未產出此條目，合流可能被阻斷,。
________________


表 8-1：證據工件必要性與阻斷表
工件名稱
	必要性
	核心用途
	Fail-Closed 阻斷條件
	來源
	source_bundle_sha256
	P0
	輸入防篡改
	Hash 不符即 FAIL
	[DocOps 方案A]
	verdict.json
	P0
	雙法官裁決
	格式錯誤或含有 FAIL 即阻斷
	[Ralph 升級]
	coverage_map.json
	P1
	驗證全量覆蓋
	覆蓋率 < 98% (或設定值)
	[Spec Kit 升級]
	trace_map.json
	P1
	驗證引用完整性
	存在未引用的新增主張
	[DocOps 方案A]
	gate_report.json
	P1
	機械閘門結果
	任一 Gate 失敗
	[5 份筆記]
	skillpack.json
	P2
	技能供應鏈審計
	使用未核准 Skill
	[Agent Skills]
	wrongbook_entry.md
	P2
	失敗學習回寫
	Fix 後缺回寫 (Configurable)
	[複利工程]
	此證據體系確保了從「輸入封印」、「技能選用」、「執行收斂」到「最終裁決」的每一步，都有據可查、有法可依，滿足最嚴格的稽核要求。
________________


8.2 可追溯性與簽章 (Traceability & Attestation)
8.2.1 核心原則：引用式批評與 No-Source-No-Norm
為了消除 LLM 的幻覺與「一本正經胡說八道」，系統強制執行 引用式批評 (Reference-style Criticism)。這意味著 Agent 的每一句主張（Claim）或法官的每一次指控，都必須附帶具體的來源指針，否則視為無效。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * No-Source-No-Norm (無來源即無規範)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 定義：任何新增的規範性描述（Normative Description）或代碼邏輯，若無法回指到 normalized.jsonl 中的唯一 ID（如 [REQ-001], [DEC-015]），視為無效。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 阻斷機制：G2 Trace Gate 會掃描所有產出物。若發現「無來源的主張（Orphan Claim）」，直接判定 FAIL。AI 不被允許「憑空創作」需求，只能「演繹」或「實作」已知需求。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 引用格式契約：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 文檔層：每個邏輯段落末尾必須標註隱藏錨點，例如 <!-- source: [CHUNK-A1] -->。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 代碼層：關鍵邏輯的註釋必須包含需求追蹤碼，例如 // Implements: REQ-Auth-001。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 審查層：Judge 若判定 FAIL，必須指出「哪一段草案（Draft Span）」違反了「哪一條契約（Contract ID）」。若 Judge 給出 FAIL 但無法提供 ID，視為「無效判決」，系統將報錯並阻斷。
8.2.2 JSON Verdict 結構化輸出 (Structured Verdicts)
為了讓 GitHub Actions 能機械化地處理 AI 的審查結果，所有判決必須從「自然語言」降維成「結構化數據」。系統不接受 "Looks good to me" 這種模糊評論。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * JSON 輸出契約：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 強制格式：所有 Judge Agent（Claude/Codex）的 Prompt 中必須包含 Output ONLY valid JSON 的強約束。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * Schema 定義 (verdict.schema.json)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * verdict: 必須是 "PASS" 或 "FAIL"（無中間狀態）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * confidence_score: 0.0 到 1.0 的浮點數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * findings: 違規事項陣列。每項必須包含 violated_rule_id 與 evidence_ptr（指向支持該判決的證據片段）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 確定性解析 (Deterministic Parsing)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Gate 邏輯：GitHub Actions 直接解析此 JSON。若解析失敗（JSON Syntax Error）或欄位缺失，視為 System Error，直接阻斷合流。這防止了 AI 輸出亂碼導致的「假性通過」。
8.2.3 產物簽章與不可抵賴性 (Attestation & Non-repudiation)
為了將證據從「系統自述（Self-reported）」提升為「可驗證的產地證明（Verifiable Provenance）」，系統強制引入 GitHub Artifact Attestations 機制。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 簽章機制：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 利用 GitHub 的 actions/attest-build-provenance Action，對生成的 evidence_bundle.zip 或關鍵 JSON 檔案（如 final_audit.json）進行數位簽章。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Sigstore 整合：對於 Public Repo，簽章會記錄在 Sigstore 的公共透明日誌（Public Transparency Log）中，確保產物確實是由特定的 Workflow 在特定的時間點生成，無人能篡改生成紀錄。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 驗證流程 (Verification)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * CLI 驗證：審計人員或下游系統可使用 gh attestation verify 指令，離線或在線驗證證據包的完整性與來源。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 供應鏈安全：這解決了「如何證明 Evidence 沒有被 Agent 或惡意人員事後偽造」的問題，是零人工核准架構中的信任基石。
8.2.4 持久化回寫機制 (Persistence & Write-back)
可追溯性不僅存在於 CI 運行期間，還必須持久化到 Git 歷史 與 Pull Request 中，形成永久的審計軌跡（Audit Trail）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Git Commit 策略：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 原子化提交：Agent 的每次修補（Patch）必須是獨立的 Commit。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 元數據注入：Commit Message 必須包含 Run-ID、Evidence-Hash 或 Triggered-By 等機械標籤，以便於 Git Log 分析。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * PR Comment 回寫 (Bot Reporting)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 自動報告：GitHub Actions 在 Gate 執行完畢後，自動將 gate_report.json 的摘要（如 Coverage %, Drift Count）與 verdict.json 的關鍵發現，以 Comment 形式貼回 PR。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * Artifact 連結：評論中必須包含指向該次 Run 的 Evidence Bundle Artifact 下載連結，方便人工稽核員（Auditor）進行深層驗證。
________________


表 8-2：可追溯性工件清單
工件名稱
	格式
	用途
	驗證閘門 (Gate)
	Fail-Closed 處置
	來源
	Trace Map
	JSON
	記錄 Source ID <-> Output Anchor 的雙向映射
	G2 Trace
	若有 untraced_claims，直接 FAIL
	,
	Verdict
	JSON
	雙法官的結構化判決結果 (PASS/FAIL)
	G4 Dual-Judge
	JSON 解析失敗或分歧即 FAIL
	,
	Run Manifest
	JSON
	記錄本次執行的環境、工具版本、輸入 Hash
	G0 Input Seal
	Hash 不符或缺檔即 FAIL
	,
	Attestation
	Sigstore
	對 Evidence Bundle 的數位簽章
	Final Audit
	簽章驗證失敗視為偽造，FAIL
	,
	此設計確保了從需求輸入到最終交付的每一步，都有據可查、有證可考，滿足最嚴格的稽核要求。
________________

9. 四大泳道配置 (The 4 Profiles/Lanes)
________________


9.1 Vibe Lane (探索原型)
9.1.1 核心定義與定位 (Definition & Positioning)
Vibe Lane 是專為 「高模糊度、高互動性、低風險」 任務設計的專用泳道。它的存在是為了承認開發過程中的「探索（Exploration）」需求，允許開發者用自然語言快速產出原型，而無需在一開始就背負沉重的規範包袱。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 定位：沙箱與候選 (Sandbox & Candidate)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 此泳道的產出物僅被視為 「候選變更 (Candidate Change)」 或 「探針 (Spike)」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 不保證合併 (No Guarantee of Merge)：Vibe Lane 的 PR 預設 不具備合流資格。它必須經過「晉升（Promotion）」流程，轉入 Dev Lane 並補齊測試與文檔後，才能進入主幹,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 應用場景：快速原型製作（Prototyping）、可行性驗證（PoC）、單次性腳本撰寫、或是當需求極度模糊需要透過「做出來看看」來釐清時,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 與 Vibe Coding 的關係：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 此 Lane 支援 Vibe Coding 的操作模式（大量自然語言指令、快速迭代），但將其 「關在 Lane 裡」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 透過 GitHub 控制平面 的權限隔離，確保 Vibe 的隨意性不會汙染主幹的穩定性，實現「你可以很隨性地寫，但不能很隨性地合」,。
9.1.2 輸入與輸出契約 (I/O Contracts)
為了在保持靈活性的同時維持可稽核性，Vibe Lane 仍需遵守最低限度的 I/O 契約。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 輸入 (Inputs)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 形式：粗略的自然語言需求、腦力激盪筆記（Brainstorming Notes）、低結構化的討論紀錄。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 信任分級：此類輸入通常被標記為 Untrusted（特別是若來自外部），在進入執行環境前需經過 Stage 1 的 Normalize 進行基本的清洗（如去除顯式惡意指令）,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 輸出 (Outputs)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 可跑原型 (Runnable Prototype)：代碼可能不完美，但必須能執行且無語法錯誤。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Spike 分支：所有變更提交至 vibe/* 或 spike/* 命名空間的分支。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 風險清單 (Risk List)：AI 必須產出 risk_assessment.md，列出當前原型的已知缺陷與安全隱患。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 下一步計畫 (Next Step Plan)：產出 PLAN.md 草案，作為晉升至 Dev Lane 的基礎,。
9.1.3 路由邏輯與觸發條件 (Routing & Triggers)
Lane Router (分流路由器) 依據任務特徵，決定是否將任務導向 Vibe Lane。此決策過程由機械規則驅動。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 觸發條件 (Triggers)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 顯式指令：Issue 或 PR 標題包含 [VIBE]、[SPIKE] 或 [POC] 標籤。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Slash Command：使用者輸入 /vibe 或 /run mode:vibe 指令,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 複雜度評分：若 Router 分析 task_manifest.json 後，判定任務的 風險等級 (Risk Tier) 為 Low 且 不明確度 (Ambiguity) 為 High，則自動導向此 Lane。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 自動最佳化配置 (Module Profile)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 當 Router 選擇 Vibe Lane 時，會載入特定的 module_profile.json，該配置會 關閉重型閘門（如雙法官深度審查、全量覆蓋率檢查），並 開啟防呆閘門，以最大化迭代速度,。
9.1.4 輕量級閘門配置 (Lightweight Gate Configuration)
為了不扼殺探索速度，Vibe Lane 採用「防呆不防錯」的策略，僅攔截致命錯誤。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 必過閘門 (Required Gates - Fail-Closed)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * G_Syntax (語法檢查)：代碼必須能通過基本的 Linter（無 Syntax Error）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * G_SecretScan (金鑰掃描)：P0 級別。由於 Vibe 模式下開發者容易直接貼上 API Key 或憑證，必須強制執行 Secret Scanning。若發現敏感資料，直接阻斷並刪除 Artifacts,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * G_AntiPlatform (反平台化)：使用 Regex 掃描，防止原型中偷渡「統一平台」、「全域中樞」等架構漂移敘事,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 豁免閘門 (Skipped Gates)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * G1 Coverage：不要求全量覆蓋。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * G4 Dual-Judge：不進行深度語義審查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Traceability：不強制要求每一行代碼都有來源引用。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Stopline (止損線)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 未產出可執行測試：若原型無法提供最小的可重現步驟（Reproduction Steps），視為無效產出 -> FAIL,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Prompt Injection 跡象：若偵測到輸入試圖混淆「資料」與「指令」，直接終止,。
9.1.5 晉升機制與合流限制 (Promotion & Merge Restrictions)
這是 Vibe Lane 與其他 Lane 最大的不同點：它的終點不是 Merge，而是 Promotion。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 隔離牆 (Isolation Wall)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 禁止 Auto-merge：Vibe Lane 的 PR 絕對禁止 觸發 Auto-merge，無論 Check 是否通過。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * Merge Queue 限制：此類 PR 不得進入主幹的 Merge Queue，防止實驗性代碼破壞主線構建,。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 晉升流程 (Promotion Workflow)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 當原型驗證完成後，必須透過 /promote 指令或手動更改 Label（如改為 [DEV]），觸發 晉升事件。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 轉換 Lane：系統會將該 PR 重新路由至 Dev/Implement Lane。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 補齊債務：此時，系統會強制執行 Dev Lane 的所有重型閘門（Coverage, Dual-Judge, Trace）。開發者（或 Agent）必須補齊測試、文檔引用與架構合規性，直到通過所有檢查，才能最終合流,。
通過此機制，Vibe Lane 既保留了探索的靈活性，又守住了主幹的品質底線，完美符合「治理適中但夠狠」的架構原則。
________________


9.2 Design/Spec Doc Lane (設計規範)
1. 核心定位：契約優先與全量覆蓋 (Core Positioning)
Design/Spec Doc Lane 的存在是為了產出系統的 單一真相來源（SSOT）。與 Vibe Lane 的快速原型不同，此泳道追求的是「精確」與「不遺漏」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 契約優先 (Contract-First)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 定義：文檔生成不是「寫作文」，而是「填空題」。Agent 必須先依據 PlanPack 抽出規範骨架（Schema），再將輸入的原子需求（Atoms）填入對應章節。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 約束：嚴禁 Agent 擅自發明新的章節結構或添加未經授權的「創意」內容。所有產出必須是對輸入契約的忠實履行。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 可驗證的全量覆蓋 (Verifiable Completeness)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 目標：將「AI 讀過所有文檔」的主觀感覺，轉化為 「ID 覆蓋率 (Coverage Rate)」 的數學指標。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 機制：輸入端的每一個需求原子（REQ/DEC），在輸出端都必須找到對應的落點。若覆蓋率未達標（如 < 98%），視為「需求蒸發（Omission）」，流程直接阻斷。
2. 輸入處理：Normalize 與 Coverage Pack (Input Processing)
本泳道不接受雜亂的自然語言輸入，強制要求先經過 Stage 1 Normalize 處理。
2.1 輸入正規化 (normalized.jsonl)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 原子化拆解 (Atomization)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 利用 Core Skill: Normalize 將長文檔（如會議記錄、原始 PRD）切分為可定址的 原子 (Atoms)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Schema：每個原子必須包含 id (如 REQ-001)、type (REQ/DEC/ASM)、content 與 source_span。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 不變量標記 (Invariant Tagging)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 針對核心決策，標記 must_hold=true。這將成為後續 G5 Invariant Check 的執法依據，防止規範在迭代中被弱化（例如從 MUST 變成 SHOULD）。
2.2 建立 Coverage Pack
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 輸入封印 (Input Seal)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 計算所有輸入檔案的 source_bundle_sha256 並寫入 input_manifest.json。這是防止「換料欺詐」的物理防線。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 覆蓋率基線 (Baseline)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * input_manifest.json 中記錄的原子總數（Total_IDs）將作為分母，用於計算最終的覆蓋率。
3. 生成機制：錨點回指 (Generation & Traceability)
本泳道的生成過程由 Drafter（寫手）與 Researcher（查證者）並行執行，並受到 Trace Map 的嚴格約束。
3.1 Drafter：基於追蹤的寫作
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 工具：Claude Code (Headless CLI) 於 Codespaces 執行。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 規則：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Anchor-Backref (錨點回指)：生成的每一個邏輯段落（Paragraph）或條款，必須在末尾附帶隱藏標籤或 Metadata，指明其來源 ID（如 <!-- ref: REQ-001 -->）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Trace Map 生成：同步產出 trace_map.json，記錄 Output_Anchor -> Source_ID 的雙向映射。
3.2 Researcher：受控補強
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 工具：NotebookLM 或 Codex。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 邊界：僅允許補強「背景（Context）」與「依據（Basis）」。嚴禁利用外部資料創造不存在於 IR 中的新需求（Create Requirements）。若發現 Researcher 試圖新增 REQ，GateKit 直接判定 FAIL。
4. 驗收閘門 (Acceptance Gates)
本泳道啟用最嚴格的 GateKit 配置，確保規範的嚴謹性。
4.1 G1 Coverage Gate (覆蓋率閘門)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 公式：$Coverage = \frac{Covered_IDs}{Total_IDs}$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 門檻：$\ge$ 98%（或殘差 residual == 0）。允許的例外必須列在 docops/registry/coverage_exceptions.yaml 中，並附帶到期日。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Fail-Closed：低於門檻直接阻斷。
4.2 G2 Trace Gate (引用鏈閘門)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * No-Source-No-Norm：檢查 trace_map.json。若發現新增的主張（Claim）無法回指到 normalized.jsonl 中的 ID，視為「幻覺」或「未授權擴張」，直接 FAIL。
4.3 G3 Drift-Heuristic (漂移獵殺)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 反平台化：使用 anti_platform.regex 掃描，禁止「統一平台」、「全域中樞」等敘事。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 不變量檢查：檢查 must_hold=true 的 ID 是否在文檔中消失或語氣被弱化。
4.4 G4 Dual-Judge Verdict (雙法官裁決)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 雙盲審查：Judge A (Codex) 檢查結構與 Diff，Judge B (Claude) 檢查邏輯與語義。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 抗偏誤：執行 Swap Order 與 Prompt Perturb 測試。若兩位法官意見分歧或對位置敏感，直接 FAIL。
5. 輸出工件 (Output Artifacts)
本泳道的最終產出不僅是文檔，還包含完整的 證據包 (Evidence Bundle)，以滿足可回放性要求。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 規範本體：final_spec.md (或 SRS/ARCH/LBP)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 證據鏈：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * normalized.jsonl：原始需求原子。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * trace_map.json：雙向追蹤表。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * coverage_report.json：覆蓋率計算結果與殘差清單。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * verdict.json：雙法官的結構化判決書。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 防偽簽章：source_bundle_sha256 與 GitHub Artifact Attestations，證明產物未被篡改。
________________


表 9-2：Design/Spec Doc Lane 配置摘要
配置項目
	規格與要求
	來源
	輸入 (Input)
	SSOT, 討論紀錄, normalized.jsonl (IR)
	

	核心技能 (Skills)
	Normalize, Extract, Synthesize, Review (Dual)
	

	必過閘門 (Gates)
	G0 Input Seal, G1 Coverage, G2 Trace, G3 Drift, G4 Dual-Judge
	

	覆蓋率要求
	$\ge$ 98% (ID-level)
	

	漂移處置
	嚴禁無源新增；例外需註冊並設到期日
	

	合流機制
	Merge Queue (需 merge_group 觸發) + Auto-merge
	

	________________


9.3 Dev/Implement Lane (開發實作)
9.3.1 核心定義與輸入 (Definition & Inputs)
開發實作泳道並非讓 Agent 自由發揮的畫布，而是嚴格的 「規格履行（Spec Fulfillment）」 過程。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 目標：將 Design Lane 產出的「鎖定規格（Locked Spec）」轉化為通過測試的源代碼（Source Code）與測試套件（Test Suite）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 主要角色：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Profile: Builder (通常由 Codex/Copilot 驅動)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Orchestrator: Ralph (CLI 工具，負責管理 TDD 循環與熔斷)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 硬性輸入 (Fail-Closed)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 系統必須讀取 spec_bundle.json（含 G0 簽章）。若輸入缺乏簽章或 Hash 不符，Ralph 拒絕啟動，防止「規格換料」[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Input Context：repo_map.json（當前代碼庫結構）與 tech_stack_rules.yaml（技術棧約束）[複利工程指南_筆記][Ralph_升級方案+討論紀錄]。
9.3.2 核心流程：Ralph TDD 雙循環 (The Ralph TDD Loop)
為了防止 Agent 寫出「無法驗證的代碼」，本泳道強制採用 「紅-綠-藍（Red-Green-Blue）」 的微步循環。此流程由 Ralph 自動化調度，不依賴人工記憶。
Phase 1: Test Generation (Red)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 動作：Builder 讀取 Spec 中的驗收標準（Acceptance Criteria），編寫失敗的單元測試（Unit Test）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 驗證：Ralph 執行測試。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 期望結果：測試 失敗 (FAIL)。這證明測試捕捉到了缺失的功能。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 異常：若測試直接通過（PASS），視為「偽測試」或功能已存在，Ralph 觸發 Invalid State 警報並要求重寫 [Ralph_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
Phase 2: Implementation (Green)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 動作：Builder 根據失敗的測試報錯（Stderr），編寫或修改 src/ 下的實作代碼。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 約束：Minimal Implementation。只允許編寫「剛好能通過測試」的代碼，嚴禁「過度設計（Over-engineering）」或引入 Spec 未提及的功能 [Spec Kit_升級方案+討論紀錄][複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 驗證：Ralph 再次執行測試。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 期望結果：測試 通過 (PASS)。
Phase 3: Refactor & Hooks (Blue)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 動作：在測試通過後，Ralph 觸發 Local Hooks（L2 層級）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Linter: 檢查語法規範（如 flake8, eslint）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Formatter: 強制格式化（如 black, prettier）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Dirty Check: 若 Formatter 修改了檔案，Ralph 自動提交變更並標記為「Style Fix」[GitHub Multi-Agent DocOps_架構指南][複利工程指南_筆記]。
________________


9.3.3 追溯性與代碼契約 (Traceability & Code Contract)
在此泳道中，"No-Source-No-Code" 原則被具體化為 代碼註釋契約。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Spec ID 標註：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 每個核心函數或類別（Class/Function）的 Docstring 必須包含 @implements: [SPEC_ID] 標籤。
範例：
def calculate_risk(score: int) -> str:
    """
    Calculates risk level based on input score.
    @implements: [REQ-auth-001]
    @source: spec_bundle.json (v1.2)
    """
    ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Trace Map 更新：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Ralph 在每次循環結束時，會掃描代碼並更新 trace_map.json，建立 Source ID <-> File Path:Line 的雙向映射 [GitHub Multi-Agent DocOps_方案A][Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 阻斷：若發現代碼區塊未標註 Spec ID，視為「孤兒代碼（Orphan Code）」，CI 階段將予以攔截。
________________


9.3.4 異常熔斷與人工介入 (Circuit Breaker & Intervention)
Ralph 內建 熔斷機制（Circuit Breaker），防止 Agent 陷入無限嘗試或燒錢迴圈。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Max Iterations (迭代上限)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 設定每個 TDD 循環最多嘗試 $N$ 次（預設 5 次）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 若在 $N$ 次內無法讓測試變綠（Green），Ralph 強制 STOP，產出 failure_report.json 並請求人工介入 [Ralph_升級方案+討論紀錄][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Oscillation Detection (震盪偵測)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 若 Ralph 偵測到 Agent 在兩個代碼版本間反覆修改（Hash A -> Hash B -> Hash A），視為無法收斂。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 處置：觸發 Hard Stop，標記任務為 BLOCKED [Ralph_升級方案+討論紀錄]。
________________


9.3.5 交付物與出口閘門 (Artifacts & Exit Gates)
當任務完成時，Dev Lane 必須產出標準化的交付包（Artifact Bundle），供後續 Review Lane 審查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 交付物清單：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Source Code: 實作代碼。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Test Suite: 對應的測試代碼。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Run Manifest: run_manifest.json（紀錄 Ralph 的執行步驟、Token 消耗、工具版本）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Local Evidence: local_test_results.xml (JUnit format) 與 coverage.xml。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 出口閘門 (Exit Criteria)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * G_Tests: 本地測試 100% 通過。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * G_Coverage: 新增代碼的測試覆蓋率 $\ge$ 閾值（如 90%）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * G_Format: 無 Linter 錯誤，且工作樹乾淨（No Dirty Tree）[GitHub Multi-Agent DocOps_架構指南][複利工程指南_筆記]。
表 9-3：Dev Lane 關鍵配置
項目
	配置值 / 規則
	目的
	來源
	Tool
	Ralph (CLI)
	統一執行 TDD 循環，隔離 Agent 幻覺
	[Ralph_升級]
	Strategy
	TDD (Red-Green-Refactor)
	確保代碼可驗證性
	[複利工程]
	Trace
	@implements: [ID]
	連結代碼與規格，防止孤兒代碼
	[DocOps A]
	Limit
	max_iterations=5
	防止無限迴圈消耗 Token
	[Ralph_升級]
	Gate
	G_Tests + G_Format
	進入 Review Lane 前的最低品質門檻
	[架構指南]
	________________


9.4 Ops/Usage Lane (運維回放)
9.4.1 核心定位：手冊與劇本驗證 (Manuals & Playbooks Verification)
在 C-Plus 架構中，Ops/Usage Lane 專注於 「將文檔視為可執行的程式碼（Docs-as-Code）」。它解決了「操作手冊過期」、「修復步驟無法重現」與「錯誤重複發生」的運維痛點。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 定位：針對運維腳本（Runbooks）、操作手冊（User Manuals）、故障排除劇本（Wrongbook）以及實際使用場景的回放驗證 [貼上的文字][GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 與 Dev Lane 的區隔：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Dev Lane：關注程式碼的構建（Build）、單元測試（Test）與功能實作。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Ops Lane：關注 「操作指令的有效性」。例如，當文檔說「執行 ./setup.sh 可以初始化環境」時，Ops Lane 的 CI 必須在沙盒中實際執行此指令，驗證其是否成功 [GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 適用場景：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 更新 README.md 或 RUNBOOK.md 中的安裝步驟。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 記錄並驗證故障修復流程（Incident Response）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 生成與驗證 WRONGB00K.md 中的防禦規則 [複利工程指南_筆記][GitHub Multi-Agent DocOps_方案A]。
9.4.2 輸入與輸出契約 (I/O Contracts)
此泳道執行時，必須遵守嚴格的輸入輸出契約，確保運維變更有據可查。
輸入 (Inputs)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Runbook Drafts：待驗證的操作手冊草案或變更（如 docs/deployment.md）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Execution Scripts：與文檔配套的自動化腳本（如 scripts/verify_env.sh）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Incident Logs：若為故障修復任務，需輸入原始的錯誤日誌或 Issue 描述 [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
輸出 (Outputs)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Runbook Patch：經過驗證的文檔補丁。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Verification Evidence：沙盒執行日誌（Log）、截圖或終端錄影（Asciinema），證明操作步驟確實可行。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Updated Wrongbook：若涉及錯誤修復，必須產出更新後的錯題本條目 [複利工程指南_筆記][GitHub Multi-Agent DocOps_架構指南]。
9.4.3 可回放性與證據留存 (Replayability & Retention)
運維操作最怕「一次性成功」的倖存者偏差。此泳道強制要求所有操作必須在 乾淨的沙盒（Clean Sandbox） 中可被機械重現。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 驗證邏輯：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 沙盒執行：CI 系統（GitHub Actions/Codespaces）必須在隔離環境中，逐行執行文檔中的 Code Block 或指定腳本。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 判定標準：僅當所有指令的 Exit Code 為 0，且產出預期的副作用（如服務啟動、檔案生成）時，才視為 PASS [GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Evidence Retention (存留策略)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 長期保存：不同於 Dev Lane 的暫存構建檔，Ops Lane 的執行證據（如 run_manifest.json, execution.log）往往涉及合規審計。因此，此泳道的 Artifacts 存留期應設定為更長（如 90 天至 365 天），或利用 GitHub Artifact Attestations 進行永久簽章封存 [GitHub Multi-Agent DocOps_架構指南][貼上的文字]。
9.4.4 Wrongbook 回寫與複利機制 (Wrongbook Write-back)
此泳道是 「複利工程（Compound Engineering）」 的核心執行點。它負責將失敗轉化為資產，防止錯誤遞迴。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 觸發條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 當任務涉及修復錯誤（Fix Bug/Incident），或在 CI 流程中發生過 FAIL 並成功修復後 [複利工程指南_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 執行動作：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 提取 (Extract)：Agent 分析失敗原因（Root Cause）與修復方案（Defense）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 生成 (Generate)：產出標準化的 wrongbook_entry.md，包含「失敗案例」、「成因」、「防線」與「新阻斷線（New Stopline）」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 回寫 (Write-back)：將 Entry 自動追加至 docops/registry/WRONGB00K.md，並同步更新 repo instructions 或 copilot-instructions.md [複利工程指南_筆記][GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Fail-Closed 規則：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 若 PR 標記為 type: fix，但 diff 中未包含 WRONGB00K.md 的更新，GateKit 必須判定 FAIL。這強制開發者（或 Agent）必須留下知識資產才能合流 [GitHub Multi-Agent DocOps_方案A][貼上的文字]。
9.4.5 相關 Skill 與工具 (Skills & Tools)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Skills：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skill.runbook_verify：解析 Markdown 中的代碼塊並執行驗證 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skill.rollback_check：驗證回滾程序的有效性 [GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skill.wrongbook_gen：從錯誤日誌生成錯題本條目 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * GateKit：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * G_Replay：檢查操作步驟是否具備確定性（Deterministic）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * G_Compound：檢查是否完成 Wrongbook 回寫 [GitHub Multi-Agent DocOps_架構指南]。
通過 Ops/Usage Lane，我們將「運維文檔」從靜態文字提升為「可測試的軟體交付物」，確保了每一次的操作變更都是安全的、可驗證的，並且能為團隊積累長期的運維知識。
________________

10. 標準化五階段工作流 (Standardized 5-Stage Workflow)
________________


10.1 Stage 0: Constitution & Ambiguity (立法與消歧)
10.1.1 核心定義：元流程與憲法建立 (Meta-Process & Constitution)
Stage 0 不產生最終交付物，而是產生 「執行計畫的契約」。它是一個元流程（Meta-Process），負責在消耗昂貴的 LLM 算力進行生成之前，先鎖定任務範圍、風險等級與合規邊界。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 憲法 (Constitution) 的定位：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 源自 Spec Kit 的 constitution 指令，意在建立專案的「鐵律（Iron Rules）」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 不可協商性：這些規則（如反平台化、TDD 順序、引用規範）是 Agent 的行為底線。任何後續產出若違反憲法，GateKit 將直接判定 P0 FAIL，不允許豁免 [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 執行環境：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 此階段由 GitHub Actions (Control Plane) 觸發，調用 Codespaces (Execution Plane) 內的輕量級分析器生成 Manifest [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
10.1.2 Constitution Pack 生成 (Constitution Pack Generation)
系統透過自動化流程，將人類的模糊意圖轉化為機器可讀的「任務憲法包」。
A. Task Intake & Manifest (任務攝取)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 觸發入口：透過 GitHub Issue Forms 或 /plan 斜線指令觸發。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 產出物：task_manifest.json。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 內容：包含 task_id、task_type（文檔/代碼/修補）、scope（允許觸及的路徑）與 inputs（輸入檔案清單）[GitHub Multi-Agent DocOps_架構指南][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Fail-Closed：若 Manifest 格式錯誤或缺欄位，流程直接終止。
B. 風險分級與證據等級 (Risk Tiering)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Router 決策：Lane Router 依據 task_manifest.json 自動判定風險等級。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Tier 1 (Low)：Vibe Lane（僅需基本 Schema Gate）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Tier 2 (Medium)：Standard Lane（需 Evidence Pack）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Tier 3 (High)：Strict Lane（修改 SSOT/核心邏輯，強制雙法官 + 完整 Trace Map）[GitHub Multi-Agent DocOps_架構指南][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 參數鎖定：生成 module_profile.json，鎖定本次執行所需的 Gate 強度與 Stopline 參數。
C. 技能解析與鎖定 (Skills Resolver)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 動態掛載：依據任務類型，自動從 docops/registry/skills/ 掛載 Core Skills（必選）與 Domain Packs（如 Doc Pack 或 Dev Pack）[貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 鎖定版本：產出 execution_plan.json，內含所有使用 Skill 的 Commit SHA 與 Hash，防止執行期間的供應鏈漂移 [貼上的文字]。
10.1.3 Ambiguity Gate 與 Blocking 檢查 (Ambiguity Gate)
此閘門源自 Spec Kit 的 ask 機制，旨在於「施工前」強制消除需求中的模糊地帶，防止 LLM 自行腦補（Hallucination）。
A. 執行邏輯 (The Ask Protocol)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               1. 分析 (Analyze)：Agent 讀取輸入的原始需求（Raw Inputs）與 normalized.jsonl（若 Stage 1 已部分執行），識別定義不清的術語、邊界條件或邏輯衝突。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               2. 提問 (Ask)：Agent 主動提出關鍵問題（通常限制為 3-5 題），要求人類釐清。例如：「跨日資料應歸屬哪一天？」或「通話中斷時計時器應暫停還是重置？」[Spec Kit项目解析_筆記][Spec Kit_升級方案+討論紀錄]。
B. 產出物：歧義報告 (Ambiguity Report)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 生成 ambiguity_report.json，包含 ambiguous_items[] 清單。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 每項必須標記 blocking 屬性：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * blocking=true：涉及核心安全、驗收標準或 must_hold 不變量的模糊點。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * blocking=false：次要細節，可延後決策或使用預設假設 [Spec Kit_升級方案+討論紀錄]。
C. 阻斷條件 (Fail-Closed Stopline)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Blocking 阻斷：若存在 blocking=true 的項目，系統 拒絕進入 Stage 2 Draft。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 處置：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * GitHub Actions 標記為 FAIL。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * Bot 在 PR/Issue 中留言要求使用者補充 clarifications.md。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 禁止腦補：嚴禁 Agent 在此階段「自行假設」以求過關。模糊的需求必須由人類裁決，而非由機率模型猜測 [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南]。
10.1.4 輸出工件匯總 (Stage 0 Artifacts)
本階段結束時，必須產出以下工件存入 evidence/ 目錄，作為後續執行的「法律依據」：
工件名稱
	來源
	用途
	Fail-Closed 檢查
	task_manifest.json
	Router
	定義任務範圍與類型
	缺欄位即 FAIL
	execution_plan.json
	Resolver
	鎖定 Skill 版本與輸入 Hash
	Hash 不符即 FAIL
	ambiguity_report.json
	Spec Kit
	記錄需求模糊點
	含 Blocking=true 即 FAIL
	module_profile.json
	Router
	定義 Gate 強度與參數
	格式錯誤即 FAIL
	通過 Stage 0，我們確保了「只有被定義清楚、且符合憲法規則的任務」才能消耗後續的算力資源，這是實現「低人工、高自動化」的第一道，也是最重要的一道防線。
________________


10.2 Stage 1: Normalize (結構化與契約)
10.2.1 核心定義：從「對話」轉向「契約」
為了消除「AI 讀過但漏掉」的黑盒風險，本架構強制引入 中間表達形式 (Intermediate Representation, IR) 作為單一真理來源（SSOT）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 一次性結構化 (One-time Structuring)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 目的：取代傳統 Prompt Engineering 中反覆貼上原始文本的低效模式。系統在此階段將雜亂文本「固化」為 Schema，後續所有 Agent（寫手、裁判）僅需讀取此結構化產物，消除上下文搬運的誤差 [DocOps 多代理自動化與治理_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * IR 屬性要求：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 可定址性 (Addressable)：每個語義區塊必須擁有全域唯一的 ID（如 REQ-001, DEC-015），這是計算覆蓋率（Coverage）與偵測漂移（Drift）的數學基礎 [5 份筆記_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 不可變性 (Immutable)：一旦生成並封印（Seal），IR 在本次 Run 中即不可變更。下游生成的文檔必須引用這些 ID，否則視為幻覺 [Spec Kit_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
________________


10.2.2 輸入適配器 (Input Adapters)
由於輸入來源異質（Heterogeneous），系統需透過適配器將其統一轉化為標準文本流，並在源頭攔截無效輸入。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * TXT/Chatlog Adapter (對話紀錄)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 功能：處理 LLM 討論紀錄，識別並標記 Q（問題）、A（回答）與 Decision（決策）區塊。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 校驗：檢查時間線連貫性，若發現因果倒置或時間戳混亂，直接 FAIL [DocOps 多代理自動化與治理_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Repo Adapter (存儲庫)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 功能：讀取既有的 SSOT 文件（如 SRS, ARCH）作為基準（Baseline），用於後續的升級比對 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * Video Input Adapter (影片/YouTube)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 限制：依據 VideoInputPack 規範，僅支援處理 字幕文字稿 (Transcript)。系統無法「觀看」影像，嚴禁 AI 對畫面內容進行腦補 [DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Fail-Closed 條件：若影片無字幕、無語音、或為新上架（<72 小時導致字幕未生成），適配器必須直接回報 FAIL，禁止進入流程 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Skill Seeker (文檔/網頁)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 功能：利用 Skill Seeker 的智能爬取與分類引擎，將外部長文檔或技術手冊切分為結構化的 Chunks，並建立索引目錄（TOC）作為 Coverage Manifest 的基礎 [Skill 生態指南_筆記][貼上的文字]。
________________


10.2.3 原子化拆解與 ID 分配 (Atomization)
這是將非結構化文本轉為 normalized.jsonl 的核心工序。Normalizer 必須將文本切分為以下五類原子（Atoms），並寫入 JSONL：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Block Types (區塊類型)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * REQ (Requirement)：明確的功能或系統需求。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * DEC (Decision)：已確認的架構決策或設計選擇（需標註 must_hold=true）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * ASM (Assumption)：尚未被完全證實的前提（需標記風險等級）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * RISK (Risk)：潛在的失敗點與緩解措施。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * ACTION (Action)：具體的待辦事項 [GitHub Multi-Agent DocOps_方案A][Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * Metadata Requirements (關鍵欄位)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * id：唯一識別碼（如 DEC-20260127-01）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * content：原始文本內容。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * source_span：原始檔案中的行號範圍或位元組偏移量（Byte Offset），用於 G2 Trace Gate 的反查驗證。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * must_hold：布林值。若標記為 true，代表此條款為不可動搖的約束，後續文檔若遺漏或弱化即視為漂移 [GitHub Multi-Agent DocOps_方案A]。
________________


10.2.4 Coverage Pack 建立 (Evidence Baseline)
完成原子化後，系統必須產出 Coverage Pack，作為後續所有閘門的「分母」。這是一組不可篡改的證據檔案。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * input_manifest.json：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 列出所有輸入檔案的路徑、大小、雜湊值與原子數量統計 [貼上的文字][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * atoms.jsonl：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 包含所有原子化後的資料，是下游生成任務的唯一原料 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * source_bundle_sha256 (Input Seal)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 輸入封印：對所有原始輸入檔案計算總體雜湊值。此 Hash 會被寫入 execution_plan.json。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 防偽作用：後續任何 Stage 若發現輸入 Hash 與此值不符，視為「換料欺詐」，直接觸發 P0 級別阻斷 [貼上的文字][DocOps 多代理自動化與治理_筆記]。
________________


10.2.5 Fail-Closed 阻斷條件 (Stoplines)
在 Normalize 階段，系統不進行「模糊推測」。若輸入資料品質不足以建立可靠的 Schema，必須直接 FAIL 並中止流程。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 時間線混亂 (Timeline Chaos)：若無法確定討論的時間順序，導致決策因果倒置，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 切分失敗 (Unstable Slicing)：若同一段落混合過多主題且無法穩定切分，視為資料品質不佳，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 過度推論 (Over-Assumption)：若偵測到連續出現超過 3 個 ASM 且周圍無 EVIDENCE 支持，判定為模型幻覺或過度推論，直接 FAIL [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 輸入封印破壞 (Input Seal Broken)：若 source_bundle_sha256 計算結果與輸入檔案不符，G0 Gate 直接阻斷 [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 證據缺口 (Evidence Gap)：若 DEC 缺乏 source_span 或理由（Rationale），視為孤兒決策，標記為 FAIL [DocOps 多代理自動化與治理_筆記]。
________________


表 10-2：Stage 1 輸出工件清單
工件名稱
	格式
	用途
	驗證閘門
	來源
	source_bundle_sha256
	String
	輸入防篡改封印
	G0 Input Seal
	[DocOps 方案A]
	input_manifest.json
	JSON
	輸入檔案清單與 Metadata
	G0 Input Seal
	[5 份筆記]
	normalized.jsonl
	JSONL
	原子化需求契約 (SSOT)
	G1 Coverage
	[Spec Kit 升級]
	atoms.jsonl
	JSONL
	用於覆蓋率計算的分母
	G1 Coverage
	[貼上的文字]
	此設計確保了後續所有生成動作都有一個「不可變、可驗證」的起點，徹底杜絕了 AI 在流程中途「偷換概念」的可能性。
________________


10.3 Stage 2: Draft & Research (矩陣並行)
10.3.1 核心定義：矩陣並行與上下文隔離 (Matrix Parallelism & Context Isolation)
本階段的核心邏輯是將「寫作（Drafting）」與「查證（Researching）」拆解為兩個獨立工序，並透過 控制平面（GitHub Actions） 調度 執行平面（Codespaces） 來實現並行。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * GitHub Actions Matrix Strategy：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 機制：利用 strategy: matrix 同時啟動多個獨立的 Job（如 job-drafter, job-researcher, job-consistency）。這取代了人類在瀏覽器中開啟多個分頁的低效操作 [GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 上下文隔離 (Context Isolation)：每個 Job 運行在獨立的 Runner 或 Container 中，強制實現「冷啟動（Cold Start）」。子代理（Subagent）只讀取其任務所需的最小輸入（normalized.jsonl 的特定 Chunks），互不干擾。這徹底解決了長對話導致的「注意力疲勞（Attention Fatigue）」與「幻覺遞增」問題 [Superpowers指南_筆記][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 執行環境 (Codespaces Runner)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 物理分離：由於 Actions 無法處理訂閱制工具（如 Claude Code, Codex CLI）的互動式登入，所有 Matrix Job 實際上是發送指令給 Codespaces 內的 supervisor.sh 腳本。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 憑證快取：利用容器內快取的憑證（如 ~/.codex/auth.json）執行任務，確保在不使用付費 API Key 的前提下實現自動化 [Ralph_升級方案+討論紀錄][貼上的文字]。
________________


10.3.2 角色分工與契約 (Role Specialization & Contracts)
本階段將 Agent 角色嚴格切分為「寫手」與「研究員」，兩者皆為「工人」，不具備放行權，且必須產出符合 Schema 的證據工件。
A. Drafter (文檔生成者)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 執行工具：Claude Code (Headless CLI) 於 Codespaces 執行 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 核心職責：依據契約施工。負責將 Stage 1 產出的 normalized.jsonl（正規化 IR）擴充為連貫的文檔草案。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 輸入契約：normalized.jsonl (SSOT), PLAN.md (施工計畫), PACK-OUTLINE (結構模具) [DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 輸出契約：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * draft.md：文檔草案。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * trace_map.json：關鍵產物。必須標示每個輸出段落對應到哪一個 Input Atom ID（如 [DEC-012]），證明內容非憑空捏造 [5 份筆記_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Fail-Closed 約束：嚴禁自由創作。若生成的內容超出 normalized.jsonl 定義的範圍且未標記為推論，視為漂移 [Spec Kit_升級方案+討論紀錄]。
B. Researcher (來源補強者)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 執行工具：NotebookLM (作為來源索引庫) 或 Codex (CLI) [Skill 生態指南_筆記][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 核心職責：尋找證據與來源落地。負責從外部（Web/YouTube/Repo）抓取證據來支撐 Drafter 的內容，或填補 IR 中的 Unknowns。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 輸入契約：REQ.md, draft.md (若需針對草案查證)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 輸出契約：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * sources.md：包含具體來源 URL、日期與摘要。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * evidence_pack.json：結構化的證據索引 [DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Fail-Closed 約束：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * No Creation：Researcher 僅能補強「背景與依據（Context & Basis）」，嚴禁利用外部資料創造不存在於 IR 中的新需求（Create Requirements）。若發現 Researcher 試圖新增 Requirement，Gate 直接判定 FAIL [貼上的文字][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Video Limits：針對 YouTube 來源，僅能處理字幕文字稿（Transcript）。若無字幕或影片上架 < 72 小時，視為無效來源，直接 FAIL [DocOps 多代理自動化與治理_筆記]。
________________


10.3.3 Consistency Analyze (Stage 2.5)：規格/計畫一致性檢查
此步驟源自 Spec Kit 的 analyze 命令，被整合為 Stage 2 的並行任務之一，旨在於「生成後、審查前」即刻攔截邏輯矛盾 [Spec Kit_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 執行邏輯：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 交叉比對：系統自動比對 normalized.jsonl (規格)、PLAN.md (計畫) 與生成的 draft.md (草案)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 檢查重點：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 互斥性：同一需求在不同文件中的描述是否衝突？
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 遺漏：Plan 中列出的 Task 是否在 Draft 中有對應產出？
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 完整性：IR 中的 must_hold=true 條款是否被保留？
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 產物與阻斷：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 產物：consistency_report.json，列出所有不一致的項目（Inconsistencies）與衝突點。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Stopline：若發現 Blocking 級別的衝突（如需求互斥），直接觸發 FAIL。系統拒絕進入 Stage 3 雙法官審查，強制要求先修復一致性問題 [Spec Kit_升級方案+討論紀錄][5 份筆記_升級方案+討論紀錄]。
________________


10.3.4 Trace Map 生成 (Trace Map Generation)
為了達成「可驗證的全量覆蓋」，本階段強制生成 Trace Map，將自然語言與結構化 ID 鎖死 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Trace Map 定義：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 這是一份雙向映射表（Bi-directional Map），記錄了 Output Paragraph ID <--> Input Source Atom ID 的關係。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 格式範例：{"para_01": ["REQ-001", "DEC-005"], "para_02": ["ASM-002"]}。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 生成機制：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Drafter 在生成草案時，必須在每個邏輯段落末尾附帶隱藏標籤或 Metadata（如 <!-- ref: REQ-001 -->），指明該段落的來源 ID。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 後處理腳本（Post-processing Script）會掃描這些標籤，自動構建 trace_map.json [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 驗證門檻 (G2 Trace Gate)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * No-Source-No-Norm：任何新增的主張（Claim）若無法在 Trace Map 中找到對應的 Source ID，且未被標記為「推論（Inference）」，視為幻覺或未授權擴張，直接 FAIL [5 份筆記_升級方案+討論紀錄]。
________________


10.3.5 扇入與匯流 (Fan-in & Aggregation)
當所有矩陣任務（Draft, Research, Consistency）執行完畢後，系統執行「扇入」操作，將分散的產物聚合為單一交付包。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Artifacts 收集：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 利用 actions/upload-artifact 與 download-artifact，將各 Job 的產物（draft.md, sources.md, consistency_report.json, trace_map.json）匯總到 staging/ 目錄 [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 預檢 (Pre-flight Check)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 在進入 Stage 3 之前，聚合器會檢查所有必要檔案是否齊全（Artifact Presence Check）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Fail-Closed：若缺檔（例如 Researcher 崩潰未產出 sources.md），流程直接中斷，不浪費算力進行後續審查 [貼上的文字]。
________________


表 10-3：Stage 2 關鍵配置摘要
元件/角色
	執行工具 (Runtime)
	輸入契約 (Input)
	輸出契約 (Output)
	Fail-Closed 阻斷條件
	來源
	Drafter
	Claude Code (Codespaces)
	normalized.jsonl, PLAN.md
	draft.md, trace_map.json
	缺少 Trace Map 或結構不符
	[DocOps 方案A]
	Researcher
	NotebookLM / Codex
	REQ.md
	sources.md, evidence.json
	創造新需求、引用無效
	[Skill 生態筆記]
	Consistency
	Script / Spec Kit
	normalized.jsonl vs draft.md
	consistency_report.json
	發現 Blocking 衝突
	[Spec Kit 升級]
	Matrix
	GitHub Actions
	task_manifest.json
	Artifacts Bundle
	任意子 Job 失敗
	[5 份筆記]
	此階段確保了進入審查環節的內容是「結構完整、來源清晰、且已通過一致性預檢」的候選版本，為後續的雙法官審查奠定了可信基礎。
________________


10.4 Stage 3: Dual Review (雙重審查)
10.4.1 核心定義：聯合判決體系 (Joint Judgment System)
在「零人工核准」的硬約束下，PASS 的定義被重構為：當且僅當所有機械閘門與兩位 AI 法官皆輸出 PASS 訊號，且抗偏誤測試通過時，系統才認可該變更的合法性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 機械優先原則 (Mechanical First)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 順序：只有當前置的機械閘門（G0 Input Seal, G1 Coverage, G2 Trace, G3 Schema）全部通過後，才會啟動昂貴的語義審查[GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 目的：避免 AI 浪費算力去檢查低級錯誤（如 JSON 格式錯誤或來源 Hash 不符）。若機械層未通過，流程直接阻斷，絕不進入語義審查[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 語義轉譯 (Semantic Translation)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 去模糊化：語義審查的產出絕不是自然語言評論（如 "Looks good"），而是必須「降維」為機器可執行的 Verdict Artifacts（如 verdict.json）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 狀態鎖定：GitHub Actions 只認 JSON 中的 verdict: "PASS" 訊號。任何無法解析的輸出、格式錯誤或欄位缺失，一律視為 System Error，直接 FAIL[貼上的文字]。
10.4.2 雙法官機制：分工與隔離 (Judge A + Judge B)
為了克服單一 LLM 的幻覺、盲點與隨機性，系統強制實施 「雙盲審查（Double-Blind Review）」。兩位法官在 Codespaces 的隔離環境中獨立運作，互不干擾。
A. Judge A：Codex/GPT (The Structure Judge)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 執行環境：Codespaces CLI / GitHub Native Integration (Non-interactive mode)[GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 核心職責：專注於 微觀層面（Micro-level） 的結構與語法檢查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * PR Diff 分析：檢查變更是否符合 scope_write 限制，有無觸碰禁止路徑（如 .github/workflows）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 代碼語法與 Lint：驗證代碼片段的語法正確性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * JSON Schema 驗證：確保所有產出物符合 I/O 契約[GitHub Multi-Agent DocOps_方案A]。
B. Judge B：Claude Code (The Logic Judge)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 執行環境：Codespaces Headless CLI (利用訂閱制憑證)[GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 核心職責：專注於 宏觀層面（Macro-level） 的邏輯與語義檢查。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 長文檔邏輯連貫性：檢查前後文是否矛盾。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 語義漂移 (Drift Hunting)：檢查是否弱化了 must_hold=true 的不變量（例如將 MUST 改為 SHOULD）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 反平台化敘事：檢查是否出現隱性的「大一統平台」描述，即使未命中 Regex 關鍵字，語義上若違規也必須 FAIL[貼上的文字][GitHub Multi-Agent DocOps_方案A]。
C. JSON 判決契約 (The Verdict Contract)
兩位法官必須遵守嚴格的輸出契約，否則判決無效。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Schema 定義 (verdict.schema.json)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * verdict: "PASS" 或 "FAIL"（無中間狀態）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * confidence_score: 0.0 - 1.0 的信心指數。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * findings: 違規事項陣列。每項必須包含 violated_rule_id 與 evidence_ptr（引用來源指針）[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 引用式批評：Judge 若判定 FAIL，必須指出「哪一段草案」違反了「哪一條契約」。若無法提供 ID，視為無效判決 -> FAIL[GitHub Multi-Agent DocOps_方案A]。
10.4.3 抗偏誤協定 (Anti-Bias Protocol)
鑑於學術研究指出 LLM 作為裁判時存在顯著的 位置偏誤 (Position Bias) 與 提示敏感度，本架構強制執行對抗性測試，不信任單次評分[5 份筆記_升級方案+討論紀錄][貼上的文字]。
A. 位置交換測試 (Swap Order)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 機制：針對比較類任務（如 A/B 方案），強制交換候選答案的順序（Candidate A vs B $\to$ Candidate B vs A），要求法官重新評分[5 份筆記_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若兩次評分結果發生翻轉（Flip）或差異超過閾值（例如 $\Delta > 1$ 分），視為模型對位置敏感，判決不可信 -> FAIL[5 份筆記_升級方案+討論紀錄]。
B. 提示擾動測試 (Prompt Perturb)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 機制：使用語義等價但表述不同的 Prompt（Rubric Variants）進行二次確認[貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 阻斷條件：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若同一內容在微擾後的 Prompt 下得到不同的判決（Inconsistent Verdict），視為模型不穩（Flaky） -> FAIL[貼上的文字]。
10.4.4 聚合與阻斷邏輯 (Aggregation & Stoplines)
最終的 PASS/FAIL 訊號由一個 確定性聚合器 (Deterministic Aggregator) 產生，而非由 AI 決定。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 聚合公式： $$Final_Result = (Judge_A == PASS) \land (Judge_B == PASS) \land (Bias_Check == STABLE)$$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 分歧即阻斷 (Disagreement as Fail)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若 Judge A 判定 PASS 但 Judge B 判定 FAIL，系統 嚴禁 取平均值或進行人工裁決。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 處置：直接判定 FAIL。這代表代碼或文檔存在模糊地帶，必須退回 Stage 4 進行修補[5 份筆記_升級方案+討論紀錄][GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Drift Allowlist 管理：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 若判定為漂移（Drift）但存在於 drift_exceptions.yaml 白名單中且未過期，聚合器可視為 PASS，但必須在 Evidence 中註記[貼上的文字][Agent Skills決策樹_升級方案+討論紀錄]。
10.4.5 輸出工件 (Evidence Artifacts)
Stage 3 結束時，必須產出以下工件存入 Evidence Bundle，供 Stage 5 稽核使用：
工件名稱
	格式
	內容
	來源
	verdict.json
	JSON
	最終聚合判決結果 (PASS/FAIL)
	[Ralph_升級]
	judges/judge_a.json
	JSON
	Judge A 的原始輸出 (含 findings)
	[方案A]
	judges/judge_b.json
	JSON
	Judge B 的原始輸出 (含 findings)
	[方案A]
	swap_consistency.json
	JSON
	位置交換測試的一致性分數
	[5 份筆記]
	drift_report.json
	JSON
	漂移獵殺結果 (Weaken/New Claims)
	[貼上的文字]
	此設計確保了審查過程不再是「依賴運氣」的黑箱，而是「可量測、可回放、Fail-Closed」的工程流程。
________________


10.5 Stage 4: Integrate & Converge (自動收斂)
10.5.1 核心定義：機械迴圈與最小修補 (Mechanical Loop & Minimal Patch)
此階段的核心目標是將「錯誤（Failure）」轉化為「資產（Asset）」。當 Stage 3 (Dual Review) 產生 FAIL 訊號且錯誤類型標記為 FIXABLE（如引用遺漏、格式錯誤、覆蓋率不足）時，系統自動觸發此階段。若為 BLOCKING（如架構錯誤、平台化漂移），則直接終止流程，不進入此階段[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * 機械迴圈 (Mechanical Loop)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 定義：這是一個由 GitHub Actions（外部狀態機） 與 Ralph（內部執行引擎） 協同運作的自動化流程。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 閉環邏輯：流程定義為「讀取錯誤報告 $\to$ 生成補丁 $\to$ 套用補丁 $\to$ 提交 $\to$ 重新觸發 Gate」，直到通過或熔斷[GitHub Multi-Agent DocOps_方案A][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 無人值守：此過程嚴禁人工介入點擊或確認，完全依賴機械規則推進。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 最小修補原則 (Patch Minimalist)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 禁止重寫：嚴禁 Agent 重新生成整份文檔。全篇重寫容易導致原先 PASS 的部分產生新的幻覺（Regressive Hallucination）或語義漂移[GitHub Multi-Agent DocOps_方案A][5 份筆記_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 鎖定範圍：Agent 僅被允許產出 Unified Diff 格式的補丁，且必須鎖定 gate_report.json 指出的錯誤行數範圍。未被 Patch 觸及的區域即視為「不變」[GitHub Multi-Agent DocOps_方案A]。
10.5.2 Ralph 驅動的修補迴圈 (Ralph-Driven Remediation Loop)
Ralph 引擎運行於 Codespaces 執行平面 的隔離環境中，負責執行具體的修補邏輯，而 GitHub Actions 負責管理狀態與提交[Ralph_升級方案+討論紀錄][貼上的文字]。
Step 1: 生成補丁 (Patch Generation)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 輸入契約：draft.md（原始草案）+ gate_report.json（機械閘門報告）+ verdict.json（雙法官裁決）+ coverage_map.json（殘差清單）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 執行者：Codex CLI（擅長結構化 Diff）或 Claude Code（擅長邏輯修補）[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 輸出契約：Unified Diff。Prompt 強制約束「Output ONLY the unified diff」，禁止輸出 Markdown 閒聊、解釋性文字或包裝，確保產物可被 git apply 直接解析[GitHub Multi-Agent DocOps_方案A]。
Step 2: 套用補丁 (Patch Application)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 執行者：GitHub Actions（作為 Patch Applier）[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 動作：執行 git apply --reject delta.patch。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 成功：自動提交 Commit 並標記 [AUTO-FIX]，推送到 PR 分支。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 失敗：若發生 Context 不匹配或衝突，視為 Patch 無效，回報 FAIL 並觸發 Stopline[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
Step 3: 上下文重置 (Context Reset)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 機制：在每一輪修補後，Ralph 強制清除 Agent 的對話歷史（Memory Wipe/Clear）[Spec Kit_升級方案+討論紀錄][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 目的：確保 Agent 在第 N 次修補時不會被前 N-1 次的錯誤嘗試誤導，保持「清醒」的決策能力，防止「越修越笨」[Spec Kit项目解析_筆記][Ralph_升級方案+討論紀錄]。
Step 4: 重跑檢查 (Re-Trigger)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 觸發：新的 Commit 會自動觸發 GitHub Actions 重新執行 Stage 3 (Dual Review) 的所有驗證。此時流程回到 Review 階段，形成閉環[GitHub Multi-Agent DocOps_方案A]。
10.5.3 Stoplines：熔斷與終止條件
為了防止 AI 陷入「無限修補」或「越修越壞」的死循環，系統定義了三道硬性熔斷防線（Stoplines），一旦觸發即刻 Fail-Closed[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * 迭代上限 (Max Iterations)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 規則：強制設定重試上限（建議 3 至 5 次）[5 份筆記_升級方案+討論紀錄][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 處置：若 N 次後仍未 PASS，Gate 直接 FAIL 並鎖定流程，輸出 fail_packet（含失敗原因分類與最小人工介入點），禁止繼續消耗算力[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 震盪偵測 (Oscillation Detection)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 規則：偵測代碼是否在兩個狀態間反覆修改（例如：Hash A $\to$ Hash B $\to$ Hash A）[Ralph_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 處置：一旦偵測到 Hash 重複出現，視為「震盪」，立即觸發熔斷（Circuit Breaker），防止無意義的 Token 消耗[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * 語義退出檢測 (Semantic Exit Detection)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 雙重驗證：退出條件 = (Semantic_Exit == True) AND (GateKit_Status == PASS)[Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 處置：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 若 Agent 認為「我修好了」（Semantic Exit），但機械 Gate（如 Coverage）仍報錯，Ralph 拒絕退出並強制進行下一輪修補。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * 若 Gate 通過但 Agent 仍在碎念，強制終止並視為 PASS[GitHub Multi-Agent DocOps_方案A]。
10.5.4 衝突處理 (Conflict Handling)
針對自動化過程中可能出現的 Git 衝突或格式錯誤，採取絕對的 Fail-Closed 策略，嚴禁 AI「自作聰明」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * Git Apply 衝突：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 規則：若 git apply 失敗（Conflict）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 處置：嚴禁 讓 AI 嘗試自動解衝突（Auto-resolve conflict）。這被視為高風險的「魔術操作」，容易破壞代碼庫完整性。系統應直接 FAIL，並將衝突檔案寫入 conflict_report.md 請求人工介入[GitHub Multi-Agent DocOps_方案A][Ralph_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * 無效補丁 (Invalid Patch)：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 規則：生成的 Diff 格式錯誤、包含 Markdown 雜訊、或無法解析。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 處置：視為修補失敗。Ralph 記錄一次「無效嘗試」，若連續 2 次無效，觸發 Stopline[GitHub Multi-Agent DocOps_方案A]。
10.5.5 輸出工件 (Evidence Artifacts)
本階段必須產出完整的修補履歷，確保自動化過程可被審計與回放。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * converge_log.jsonl：記錄每一輪迭代的 timestamp、error_target、patch_hash 與 gate_result。證明系統是如何一步步收斂的[Ralph_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * delta.patch：最終生效的補丁檔案[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * diff_report.md：本次自動修補造成的最終差異摘要，供 Stage 5 Final Audit 使用[GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * wrongbook_entry.md（若發生過 FAIL）：若修補成功，將原本的錯誤模式自動格式化為錯題本條目，準備在合流時寫回 WRONGB00K.md，實現複利效應[複利工程指南_筆記][GitHub Multi-Agent DocOps_方案A]。
________________


表 10-5：Stage 4 工具角色分工矩陣
角色 (Role)
	建議工具 (Tool)
	職責定義 (Responsibility)
	來源
	Patch Generator
	Codex CLI
	讀取 FAIL 報告，產出針對性的 Unified Diff。被要求「不重構、只補缺口」。
	[DocOps 方案A]
	Converger
	Claude Code
	處理較複雜的整合任務（如結構性修補），或在 Codex 失敗時接手。
	[DocOps 方案A]
	Patch Applier
	GitHub Actions
	負責執行 git apply、commit、push，並維護迭代計數器。
	[DocOps 方案A]
	Orchestrator
	Ralph
	控制迭代迴圈、速率限制、熔斷與上下文重置。
	[Ralph 升級]
	此設計確保了「自動收斂」不是無限制的嘗試，而是一個受控、可觀測、且具備安全底線的工程過程。
________________


10.6 Stage 5: Final Audit (一致性稽核)
10.6.1 核心定義：零信任的總帳核對 (Zero-Trust Ledger Reconciliation)
Final Audit 的核心哲學是 「不信任過程，只驗證結果」。即便前序階段（Draft, Review, Repair）都回報 PASS，本階段仍需獨立驗證所有證據工件的完整性與一致性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 執行者：由 GitHub Actions (Control Plane) 直接執行的獨立審計腳本（audit_main.py），不依賴任何 LLM 模型，以確保判定邏輯的確定性（Deterministic）[GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Fail-Closed 原則：此階段的任何失敗都是 P0 級別 阻斷。失敗意味著系統的完整性（Integrity）受損，必須立刻停止合流並觸發警報 [5 份筆記_升級方案+討論紀錄]。
10.6.2 輸入封印驗證 (Input Seal Verification)
為了防止 「換料欺詐（Bait-and-Switch）」——即 Agent 在生成過程中偷偷修改了原始需求文件以通過測試——系統必須驗證輸入的一致性。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 驗證邏輯：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 讀取 Stage 0/1 產出的 execution_plan.json 中的 source_bundle_sha256（原始封印）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. 重新計算當前工作區（Workspace）中所有輸入檔案（SRS, IR, Config）的 SHA-256 雜湊值。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. 比對：若兩者不一致，代表輸入在過程中被篡改。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 阻斷處置：直接判定 FAIL，並標記為 SECURITY_RISK。這確保了最終交付物確實是基於「最初被核准的需求」所生成的 [GitHub Multi-Agent DocOps_方案A][DocOps 多代理自動化與治理_筆記]。
10.6.3 覆蓋率與追蹤終審 (Coverage & Trace Final Check)
確保「每一個需求都有落點」且「每一個產出都有來源」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 覆蓋率重算 (Coverage Recalculation)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 讀取 normalized.jsonl（分母）與最終交付物（分子）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 執行 Spec Kit 的 coverage 指令進行最終計算。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 門檻：必須滿足 $\ge$ 98%（或 module_profile.json 設定值）。若低於門檻且未列入例外清單，判定 FAIL [Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 孤兒主張掃描 (Orphan Claim Scan)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 掃描 trace_map.json。檢查是否所有新增的邏輯段落都有對應的 Source ID。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * No-Source-No-Norm：若發現未引用的規範性描述（Normative Description），視為「來源不明的增補」，判定 FAIL [5 份筆記_升級方案+討論紀錄][GitHub Multi-Agent DocOps_架構指南]。
10.6.4 政策合規與漂移獵殺 (Policy Compliance & Drift Hunting)
針對非結構化的風險進行最後的機械掃描。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 不變量檢查 (Invariant Check)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 檢查所有標記為 must_hold=true 的原子（Atoms）是否在最終文檔中被保留且未被否定（Negated）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 機制：使用關鍵字匹配或簡易的 NLI（Natural Language Inference）模型確認語義保留 [Spec Kit_升級方案+討論紀錄]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 反平台化掃描 (Anti-Platform Scan)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 載入 anti_platform.regex 黑名單（如 "unified platform", "central hub", "global dashboard"）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 若在最終產出中發現此類敘事，視為 架構漂移（Architecture Drift），判定 FAIL [5 份筆記_升級方案+討論紀錄][DocOps 多代理自動化與治理_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 錯題本回寫檢查 (Wrongbook Check)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 若本次任務類型為 FIX 或 HOTFIX，檢查是否已產出 wrongbook_entry.md 並包含有效的防禦措施。若無，判定 FAIL [複利工程指南_筆記][GitHub Multi-Agent DocOps_方案A]。
10.6.5 數位簽章與交付 (Attestation & Delivery)
當所有審計項目皆通過（PASS）後，系統將證據打包並進行數位簽章，賦予其法律效力。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 證據打包 (Evidence Bundling)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 將 source_bundle_sha256, trace_map.json, verdict.json, coverage_report.json, final_audit.json 打包為 evidence_bundle.zip [GitHub Multi-Agent DocOps_方案A]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Artifact Attestation：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 使用 GitHub Actions Attestations (actions/attest-build-provenance) 對 evidence_bundle.zip 進行簽章。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Sigstore：簽章紀錄寫入 Sigstore 公共日誌，證明此證據包確實是由特定的 Workflow Run 在特定時間生成的，無人能偽造 [DocOps 多代理自動化與治理_筆記][GitHub Multi-Agent DocOps_架構指南]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 合流信號 (Merge Signal)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 產出 final_audit.json，其中 outcome: PASS。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * GitHub Actions 接收此信號，將 PR 狀態標記為綠色（Green），解鎖 Merge Button 或觸發 Auto-merge（視 Lane 規則而定）[Ralph_升級方案+討論紀錄]。
________________


表 10-6：Final Audit 檢查清單摘要
檢查項目 (Check Item)
	驗證對象
	判定邏輯 (Fail-Closed)
	來源
	Input Seal
	輸入檔案雜湊
	Hash 不符 $\to$ FAIL
	[DocOps 方案A]
	Trace Coverage
	需求覆蓋率
	< 98% (且無例外) $\to$ FAIL
	[Spec Kit 升級]
	Orphan Claim
	追蹤映射表
	存在無來源的主張 $\to$ FAIL
	[5 份筆記]
	Invariants
	must_hold 原子
	關鍵條款消失或弱化 $\to$ FAIL
	[Spec Kit 升級]
	Anti-Platform
	全文內容
	命中黑名單 Regex $\to$ FAIL
	[5 份筆記]
	Wrongbook
	錯誤修復記錄
	Fix 任務缺回寫 $\to$ FAIL
	[複利工程]
	Attestation
	最終證據包
	簽章失敗 $\to$ FAIL
	[架構指南]
	通過 Stage 5，我們確保了每一行合併到主幹的代碼或文檔，都具備 「可追溯的出身證明（Provenance）」 與 「可驗證的合規性（Compliance）」，徹底消除了人工審查的盲區與信任成本。
________________

11. 複利工程與持續學習 (Learning & Compound)

________________
11.1 記憶架構 (Memory Architecture)
在模組化 Core 架構下，記憶不依賴外部向量資料庫（Vector DB）或黑盒平台，而是嚴格遵守「檔案即治理（File-based Governance）」原則。記憶被劃分為 持久化硬記憶（Explicit）、適應性軟記憶（Implicit） 與 動態執行期記憶（Runtime） 三層結構。
11.1.1 CLAUDE.md：外部海馬迴與專案憲法
CLAUDE.md 被定義為 Agent 的「外部海馬迴（External Hippocampus）」，它是位於專案根目錄的核心治理文件，負責將專案的特殊性（Idiosyncrasies）與鐵律（Iron Rules）持久化，確保 Agent 始終與專案架構保持一致 [複利工程指南_筆記]。
A. 核心定位與知識分類 CLAUDE.md 不是普通的 Readme，而是 Agent 的行為準則。其內容必須嚴格分類以最大化 Agent 的理解效率：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 架構模式 (Architectural Patterns)：記錄特定的代碼風格、目錄結構以及函式庫偏好（Library preferences）。包含專案的構建與運行指令，確保 Agent 能獨立執行任務 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 操作規則與約束 (Operational Rules)：明確的負向約束（Negative Constraints），例如「絕不使用某函式庫」或「測試必須寫在 Y 目錄」。這也包含工作環境維護規則 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 錯題本摘要 (Historical Corrections)：這是文件中最至關重要的部分。採用「錯誤案例」與「正確做法」對照的方式記錄（Learn by doing），阻斷錯誤重複發生 [複利工程指南_筆記]。
B. 專案級 vs. 全局級配置
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 專案級 (Project-level)：存放於 Repo 根目錄，針對該 Repo 的具體構建與規範。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 全局級 (Global-level)：作用於所有項目的通用設定（例如透過 antigravity 打開）。其功能包括克服上下文焦慮（明確告訴 AI 不要擔心 Token 用完）、鼓勵行動、以及防止過度設計的通用哲學 [複利工程指南_筆記]。
C. 團隊共享與自動化更新
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Git 版控：團隊應共享同一個 CLAUDE.md 並提交至 Git，視為源碼的一部分進行版本控制 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 自動化集成：利用 GitHub Actions，可在代碼審查（PR）過程中，自動將審查意見或修正內容寫入 CLAUDE.md，實現文檔的持續演進與「錯誤固化」 [複利工程指南_筆記]。
11.1.2 Copilot Memory：隱式與顯式雙軌體系
為了滿足工程嚴謹性與 AI 靈活性的需求，架構強制實施「雙軌記憶」策略，將 GitHub Copilot 的原生能力納入複利體系 [貼上的文字]。
A. 顯式規範 (Explicit Instructions / Hard Memory)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 載體：Repo 內的 Custom Instructions 檔案（通常為 .github/copilot-instructions.md 或類似規範檔）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 性質：「硬記憶」，儲存絕對規則與不可違背的憲法。確保所有接入該 Repo 的 Agent 在啟動時，強制讀取並遵守基礎約束。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 內容範疇：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 禁區 (Forbidden Zones)：如「嚴禁使用付費 API Key」、「嚴禁提及統一平台敘事」 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Wrongbook 防線：從錯題本中提煉出的 Regex 阻斷規則 [貼上的文字]。
B. 隱式記憶 (Implicit Memory / Soft Memory)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 載體：GitHub Copilot Memory 功能（Public Preview）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 性質：「軟記憶」，儲存上下文偏好與非強制性的習慣。讓 Agent 在生成內容時能「順著毛摸」，減少因風格不符導致的重寫成本。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 內容範疇：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 架構偏好：如「本專案偏好使用 Functional Programming 風格」 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 歷史教訓：過去任務中踩過的坑，但難以寫成死規則的經驗 [貼上的文字]。
C. 複利循環 (The Compounding Loop) 這是「六步閉環」中的最後一步（Step 6: Compound），確保「同樣的錯誤（FAIL）不會消耗兩次算力」：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 觸發：當任務在 Stage 3 (Dual Review) 或 Stage 4 (Integrate) 遭遇失敗（FAIL）並完成修復後。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. 強制沉澱：學習不是可選項。系統強制要求將 WRONGB0OK.md 中的結論轉化為資產。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. 分流寫入：若屬「硬性違規」更新至 Instructions；若屬「風格偏好」寫入 Copilot Memory [貼上的文字]。
11.1.3 記憶模式與上下文衛生 (Context Hygiene)
除了持久化文件，本架構還定義了動態的會話記憶管理機制，以維持推理的高質量並防止「上下文中毒」 [複利工程指南_筆記]。
A. 記憶模式指令 (# memory mode)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 定義：這是一種臨時/會話知識（Ephemeral Knowledge），透過 # 指令進入 Memory Mode。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 用途：用於告知 Agent 在「當前任務或會話中」必須記住的特定事項，補足全域知識與持久化知識之間的空白 [複利工程指南_筆記]。
B. 上下文壓縮與清除 (Compression & Clearing) 為了防止模型因冗長的日誌或除錯訊息而產生幻覺或「困惑」，必須執行上下文衛生管理：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 壓縮 (/compact)：將當前對話進行摘要，保留核心上下文並移除多餘的 Token 膨脹（Token bloat） [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 清除 (/clear)：重置對話視窗，消除殘留的無關上下文。這對應 Spec Kit 中的 clear 指令，強制每個 Job 冷啟動上下文，避免互相干擾 [Spec Kit项目解析_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Ralph Loop 重置：在自動收斂迴圈中，每一輪迭代開始時強制清除上下文（Context Reset），確保 AI 在第 N 次修補時與第 1 次一樣清醒 [Ralph for Claude Code解析_筆記]。
C. 歷史分支與錯誤回滾 (History Branching)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 雙重跳脫 (Esc Esc)：使用「雙擊 Esc」技巧瀏覽互動歷史，選擇錯誤發生「之前」的時間點重新開始。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 衛生管理：此操作能有效「刪除」錯誤的時間線（Erroneous timeline），防止錯誤代碼與後續修正污染上下文 [複利工程指南_筆記]。
D. Token 預算控制
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 預算限制：錯題本（Error Notebook）與核心記憶文件的規模應維持在 2.5K Tokens 左右。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 效率平衡：過多的 Token 消耗會導致 AI 效率下降與成本上升，因此需定期精煉內容（Refine），而非無限制堆疊。若超過預算，Gate 將強制要求縮減或歸檔 [複利工程指南_筆記]。
________________


11.2 錯題本機制 (Wrongbook)
核心哲學：失敗資產化 (Failure as Asset)
在模組化 Core 架構中，Wrongbook (錯題本) 被嚴格定義為一種 「反脆弱契約 (Anti-Fragile Contract)」，而非傳統的錯誤日誌（Error Log）。 傳統 Log 紀錄的是「發生了什麼（Stack Trace）」，是給人除錯用的；Wrongbook 紀錄的是「未來如何防禦（Defense）」，是給 Agent 與 GateKit 讀取的規則資產。其戰略目標是建立控制論中的負回饋迴圈（Negative Feedback Loop），將每一次的 FAIL 轉化為 GateKit 的新規則或 Prompt 的新約束，實現 $E = B(1 + r)^{t}$ 的效率複利。
________________


11.2.1 WRONGB00K.md 結構與契約 (Structure & Schema)
為了防止錯題本變成 AI 的「抱怨日記」或無效的敘事堆疊，必須強制執行嚴格的 Schema 契約。所有寫入 docops/registry/WRONGB00K.md 的條目必須包含以下四大核心欄位，缺一不可：
欄位名稱 (Field)
	定義與要求 (Definition)
	目的 (Fail-Closed Objective)
	1. 失敗案例 (Failure Case)
	具體發生了什麼錯誤（如：覆蓋率未達標、產生幻覺引用、Schema 解析失敗）。必須引用具體的 run_id 或 gate_report.json。
	定義問題邊界，防止模糊描述。確保錯誤可被「重現 (Reproducible)」。
	2. 成因 (Root Cause)
	導致錯誤的根本原因（如：Prompt 歧義、Schema 定義漏洞、模型位置偏誤）。區分是「隨機錯誤」還是「結構性缺陷」。
	避免治標不治本（如只重跑不修規則）。
	3. 防線 (Defense)
	當下採取的具體修補措施（如：修改了哪一行 Prompt、增加了哪一個 Check、調整了哪一個 Regex）。
	記錄解決方案的有效性證據。
	4. 新的阻斷線 (New Stopline)
	最關鍵欄位。定義未來如何 自動攔截 此錯誤（如：新增 anti_platform.regex 規則、更新 input.schema.json、新增 Gate 腳本）。
	確保下次由 機械閘門 (GateKit) 直接攔截，而非依賴人工發現或 AI 自覺。
	Token 預算控制 (Budget Gate)： 為了避免 Context 膨脹導致模型「越學越笨」，Wrongbook 設有 2.5K Tokens 的硬性預算上限。當內容超過此限制時，必須觸發 /compact 流程，將舊案例提煉為更精簡的規則（Rules）或移入歸檔（Archive），始終保持上下文的精煉與高關聯性。
________________


11.2.2 失敗資產化與自動回寫流程 (The Compounding Loop)
這是架構中「六步閉環」的最後一步（Compound）。系統強制規定：「沒有回寫，就不算修復完成」。
1. 觸發條件 (Trigger) 當任務在 Stage 3 (Dual Review) 或 Stage 4 (Integrate) 遭遇 阻斷性失敗 (FAIL)，且隨後由 Agent 修補成功並通過 Gate 時，觸發回寫流程。
2. 自動化流水線 (The Write-back Pipeline) 此流程由 compound_job 執行，不依賴人工操作：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Extract (提取)：由 Agent 分析 gate_report.json (失敗點) 與修復後的 diff (防禦點)，提取上述四大欄位內容。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Generate (生成)：產出 wrongbook_entry.md 作為中間產物。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Verify (驗證)：GateKit 檢查該 Entry 是否包含有效的 "New Stopline"。若僅寫了感想而未提出可執行的防禦手段（Regex/Schema/Gate），視為無效回寫，CI 報錯。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Merge (合流)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 將 Entry 追加至 docops/registry/WRONGB00K.md。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 同步更新控制平面：若 "New Stopline" 涉及 Regex 或 Schema，必須同步產出對應的 anti_platform.regex 或 schemas/*.json 變更。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Distribute (分發)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 硬規範：將新的 Stopline 注入 Repo 層級的 .github/copilot-instructions.md 或 Agent System Prompt，確保所有 Agent 下次啟動時「天生」就知道此禁忌。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 軟記憶：若屬於風格偏好，寫入 Copilot Memory。
3. Gate 規則 (Fail-Closed) 在 PR Check 中，若系統檢測到這是一個 "Fix" 類型 的 PR（修復了先前的 FAIL），但 沒有包含 WRONGB00K.md 的更新，CI 將直接判定 FAIL。這強制開發者（或 Agent）必須留下知識資產才能合流。
________________


11.2.3 Prompt Deltalog (提示詞演進錄)
為了避免對 Prompt 進行隨機的「試錯式修改（Random Trial-and-Error）」，必須維護 PROMPT_DELTALOG.md。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 定位：這是 Prompt 的「Git Commit Log」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 記錄內容：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 變更理由：對應哪一條 Wrongbook Entry（例如：為了解決 FAIL-20260127 的漂移問題）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 預期影響：修改這段 Prompt 預期能解決什麼特定的漂移或幻覺。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * A/B 測試結果：如果有做 Prompt Perturb（提示擾動）測試，記錄其穩定性差異。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 價值：確保 Prompt 的演進是 工程導向 的，每一行修改都有據可查，防止「改了好 B 壞了 A」的迴歸問題。
________________


11.2.4 風險控制與治理 (Governance)
Wrongbook 機制本身也面臨被污染的風險，需透過以下規則進行治理：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 禁止敘事性碎念 (No Narrative Bloat)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Wrongbook 禁止收錄「我覺得模型今天怪怪的」這類無法量測的主觀描述。只收錄 可重現、可攔截 的工程錯誤。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. 規則審計 (Rule Audit)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Wrongbook 的 PR 也必須跑同一套 Drift/Coverage Gates。防止 Agent 為了修復一個 Bug 而寫入一條「忽略所有錯誤」的惡意規則（Prompt Injection 風險）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. 唯讀執行 (Read-Only Execution)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 在執行任務時，Agent 對 Wrongbook 僅有 讀取權。寫入權限僅限於特定的 compound_job，且必須走 PR 審查，嚴禁 Agent 在 Runtime 直接修改規則庫。
________________


11.3 效率優化與環境配置 (Efficiency Optimization & Environment Configuration)
在「零人工核准」的架構下，開發者的角色從「撰寫者」轉變為「指揮官」。為了支撐這種高頻率的派工與監控，必須建立一套符合人體工學的操作介面，將重複性動作封裝為指令，並將監控非同步化。
11.3.1 自定義斜線指令 (/slash-commands)
斜線指令是連接「人類意圖」與「機械執行」的標準介面。本架構將指令分為兩類：執行平面指令（CLI）與控制平面指令（ChatOps），分別對應 Codespaces 內的 Agent 操作與 GitHub Issues 上的狀態機觸發。
A. 執行平面指令（Codespaces / CLI）
這類指令用於 Codespaces 內的終端機，直接驅動 Ralph、Claude Code 或 Codex 執行具體任務。
指令 (Command)
	對應 Skill / 功能
	執行邏輯與自動化動作
	來源
	/init-repo
	Bootstrap
	透過 spec-init 生成目錄骨架、寫入 .devcontainer 鎖定工具鏈、建立 CLAUDE.md 憲法。
	,
	/brainstorm
	Superpowers (Brainstorm)
	啟動蘇格拉底式對話，釐清需求並生成 ambiguity_report.json（Stage 0.5）。
	,
	/plan
	Superpowers (Writing Plans)
	將需求拆解為 2-5 分鐘粒度的原子任務，產出 PLAN.md 與 tasks.json。
	,
	/review
	Agent Skills (Decision Tree)
	觸發決策樹路由，評分變更複雜度，自動選擇 Jina (輕量) 或 Codex (深度) 進行審查。
	,
	/push-pr
	Compound (Workflow)
	封裝「格式化 → 測試 → 提交 → 推送 → 開 PR」全流程。含 pre-push hook 檢查。
	,
	/docops run
	Scheme A++ (Orchestrator)
	啟動 Ralph Loop 引擎，依據 router_rules.yaml 自動掛載對應的 Domain Pack 並執行收斂迴圈。
	,
	配置要求：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 上述指令必須在 .devcontainer/devcontainer.json 的 postCreateCommand 中自動註冊別名（Alias）或安裝對應腳本，確保環境啟動即用。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 指令必須支援參數化（例如 /review --strict），以對應不同 Lane 的需求。
B. 控制平面指令（GitHub IssueOps）
這類指令用於 GitHub Issue/PR 的評論區，觸發 GitHub Actions 狀態機。
指令 (Command)
	觸發事件 (Event)
	後端動作 (Workflow)
	來源
	/run gate:check
	issue_comment
	觸發 docops-gatekit workflow，執行所有機械閘門（G0-G4）並回報狀態。
	,
	/delegate <lane>
	repository_dispatch
	依據指定 Lane（如 vibe, spec）派發 Matrix Jobs 進行並行施工。
	

	/approve
	pull_request_review
	(人類專用) 僅在極少數需要人工介入時使用；日常合流由 Auto-merge 接管。
	

	________________


11.3.2 終端機人體工學與快捷鍵 (Terminal Ergonomics & Hotkeys)
為了維持開發者的「心流狀態（Flow State）」，必須消除在編輯器、終端機與瀏覽器間切換的微小延遲。本架構強制規範 Codespaces 或本地 iTerm2 的佈局策略。
A. 標籤頁管理策略 (Tab Strategy)
依據「複利工程」思維，固定標籤頁的用途可將切換成本降至毫秒級。建議佈局如下：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Tab 1: 核心開發 (Dev)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 用途：運行主 Agent（Claude Code/Ralph），執行 /plan、/docops run 等指令。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 狀態：互動式 Session，保留上下文。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Tab 2: 測試與驗證 (Test/Gate)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 用途：執行單元測試、運行 GateKit 腳本（如 python docops/scripts/gatekit.py）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 狀態：短暫執行，頻繁清屏。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Tab 3: 監控儀表板 (Monitor)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 用途：運行 tmux 顯示 Ralph Dashboard 或 tail -f 監控 Log。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 狀態：唯讀，長駐。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Tab 4: 檔案操作 (Files)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 用途：執行 git 操作、檔案移動、目錄結構調整。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 狀態：輔助操作。
B. 快捷鍵與操作優化
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 數字切換：配置 Cmd+1 至 Cmd+4 直接跳轉對應標籤，消除視覺搜尋成本。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 雙擊跳脫 (Esc Esc)：在 Claude Code CLI 中，使用雙擊 Esc 瀏覽並回滾歷史對話，用於「刪除」錯誤的時間線，維護上下文衛生。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 上下文指令：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * /compact：壓縮當前上下文，釋放 Token。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * /clear：重置對話，強制 Agent 冷啟動，防止注意力疲勞。
________________


11.3.3 非同步監控與 ChatOps (Asynchronous Monitoring)
隨著任務複雜度提升（如長文檔生成或全量回歸測試），同步等待已不可行。系統需提供「射後不理（Set and forget）」的非同步監控機制。
A. 實時儀表板 (Tmux Dashboard)
針對 Codespaces 內的長跑任務（如 Ralph Loop），使用 Tmux 提供可視化監控。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 顯示內容：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Status：當前階段（Thinking, Executing, Validating）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Loop Count：當前迭代次數（如 3/5）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Progress：GateKit 通過率（如 Coverage: 98%, Drift: 0）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Logs：實時滾動的工具輸出日誌。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 價值：解決無頭模式下「不知 Agent 是否卡死」的焦慮，提供即時的可觀測性,。
B. 單一面板監控 (Single Pane of Glass)
針對 GitHub 控制平面的狀態，統一由 GitHub Issue/PR Timeline 呈現。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Issue Timeline：所有 Agent 的活動軌跡（Plan 生成、Gate 結果、失敗報告）必須回寫至 Issue Timeline，嚴禁散落在外部系統。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Bot Reporting：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * GitHub Actions 在執行完畢後，自動將 gate_report.json 的摘要（如 Coverage %, Drift Count）與 verdict.json 的關鍵發現，以 Comment 形式貼回 PR。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 評論中必須包含指向 Evidence Bundle Artifact 的下載連結，供深度稽核使用。
C. 跨設備遠端查閱
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Web/Mobile 監控：利用 GitHub Mobile App 或 Web 介面查看 Issue 狀態與 Actions 進度。開發者無需守在電腦前，即可接收「大問題裁決（Big Issue）」的通知並進行決策,。
________________


總結： 透過將斜線指令標準化、終端機佈局固定化以及監控非同步化，本章節確保了開發者在面對多 Agent 系統時，能以最低的認知負擔維持最高的掌控力，達成「30 分鐘在場，其餘自動化」的運作目標。
________________

12. 風險管理與安全 (Risk & Security)

________________
12.1 技術與執行風險 (Technical & Execution Risks)
12.1.1 Merge Queue 卡死與事件觸發失效 (Merge Queue Deadlocks)
在 org-owned public repo 啟用 Merge Queue 是實現「序列化合流」與「零人工核准」的關鍵，但 GitHub Actions 的事件觸發機制若配置不當，將導致 PR 進入隊列後永久卡在 "Queued" 狀態，阻斷合流。
A. 風險描述：merge_group 事件缺失
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 機制衝突：GitHub Merge Queue 在創建臨時合併分支（如 gh-readonly-queue/main/...）進行測試時，會觸發特殊的 merge_group 事件，而非傳統的 pull_request 事件 [5 升級合併方案-A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 後果：若 Required Checks 的 Workflow 僅設定監聽 pull_request，當 PR 被加入隊列後，CI Jobs 將不會被觸發。由於 Rulesets 要求狀態檢查必須通過，系統會無限期等待回報，導致隊列卡死 [GitHub Multi-Agent DocOps_方案A.txt]。
B. 偵測指標
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * PR 狀態顯示 "Queued" 但 CI Jobs 未啟動 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Required Checks 顯示 "Expected" 狀態但永遠未執行 [貼上的文字]。
C. 強制緩解 (Hard Mitigation)
事件對齊：所有被標記為 Required Status Checks 的 Workflow，必須在 on: 區塊中明確包含 merge_group 事件 [5 份筆記_升級方案+討論紀錄]。
on:
  pull_request:
  merge_group: # 必須存在，否則 Merge Queue 無法觸發檢查
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * Bypass 設定：若使用 Rulesets，需將 github-merge-queue[bot] 加入 Bypass list，避免規則集誤殺隊列生成的臨時分支或提交 [貼上的文字]。
D. 備援方案 (Fallback)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 若 Merge Queue 持續故障，暫時停用隊列功能，退回至「Strict Required Checks（要求分支最新）」加上「Linear Merge」的傳統模式 [5 份筆記_升級方案+討論紀錄]。
12.1.2 LLM 認證卡死與無頭環境衝突 (Auth Deadlock)
在「嚴禁使用付費 API Key」的硬約束下，CI 環境（Headless）與訂閱制工具（如 Claude Code CLI, Codex CLI）之間的認證衝突是本架構最大的結構性風險 [GitHub Multi-Agent DocOps_方案A.txt]。
A. 風險描述：無頭環境的互斥性
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 互動式阻斷：GitHub Actions 是無頭環境。若 CLI 工具嘗試彈出瀏覽器進行 OAuth 驗證或詢問 "Press Enter to continue"，流程將立即掛起直至超時（Timeout） [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 環境重置：Actions 每次執行都是全新容器，無法保留上一次的登入狀態（Session Token）。若無持久化機制，會導致「零人工」變成「每次都要人工登入」 [5 升級合併方案-A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 計費陷阱：部分工具（如 Claude Code）在偵測到無頭環境且環境變數含 API Key 時，會自動切換為計費模式，違反成本約束 [5 升級合併方案-A.txt]。
B. 緩解策略：控制與執行物理分離
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 控制平面 (GitHub Actions)：僅作為狀態機與機械閘門，嚴禁在此執行需要登入的 LLM 任務 [5 升級合併方案-A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 執行平面 (Codespaces)：作為唯一可重現的執行沙盒。利用容器的存儲持久化特性，快取 CLI 工具的憑證（如 ~/.codex/auth.json），實現免 API Key 的自動化執行 [GitHub Multi-Agent DocOps_方案A.txt]。
C. Fail-Closed 規則
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 禁止互動式 CLI：Workflow 腳本中嚴禁包含任何會觸發互動式提示的指令。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * API Key 掃描：執行前掃描環境變數，若發現 ANTHROPIC_API_KEY 或 OPENAI_API_KEY，視為架構違規，直接 P0 FAIL [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 認證失效中斷：Supervisor 監控 CLI 的 Exit Code。若回報 Auth Error，不進行自動重試（避免帳號被鎖），直接暫停並通知人工介入 [GitHub Multi-Agent DocOps_方案A.txt]。
12.1.3 無限迴圈與收斂失敗 (Infinite Loops & Convergence Failure)
當 Agent 試圖自動修復錯誤時，可能陷入「修復 A 導致 B 錯，修復 B 導致 A 錯」的震盪（Oscillation），或因無法解決的邏輯矛盾而無限消耗資源 [GitHub Multi-Agent DocOps_方案A.txt]。
A. 風險描述：震盪與發散
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Fixer Agent 在兩個狀態之間反覆切換（例如：不斷修改同一行代碼的格式），導致 Diff 不斷產生但 Gate 始終不過 [Ralph for Claude Code解析_筆記.txt]。
B. 緩解策略：Ralph 收斂引擎
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 熔斷器 (Circuit Breaker)：必須導入 Ralph 的熔斷機制。若偵測到連續兩次提交針對同一組檔案產生相反的 Diff，或 Hash 重複出現，直接觸發熔斷 [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Diff Radius Gate：單次自動修補的變更行數若超過閾值（例如 35%），視為發散風險，強制阻斷 [貼上的文字]。
C. Stoplines (硬停損點)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 迭代上限：強制設定自動修補迴圈上限（建議 3~5 次）。若 N 次後仍 FAIL，強制硬停（Hard Stop），不允許繼續重試 [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 錯誤資產化：當硬停發生時，必須輸出 fail_packet（含失敗原因與最小人工介入點），並寫入 Wrongbook，確保失敗轉化為規則資產 [GitHub Multi-Agent DocOps_方案A.txt]。
12.1.4 執行成本膨脹 (Execution Cost Inflation)
在追求「全量覆蓋」與「自動化」的過程中，CI/CD 成本可能因架構設計不當而倍增，特別是在 Public Repo 環境下。
A. 風險描述：Merge Queue 的雙倍執行
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Merge Queue 為了確保合流安全，會在 merge_group 事件中重新運行 Required Checks。這意味著每個 PR 至少會跑兩次流水線（PR 階段一次 + Merge Group 階段一次） [DocOps 多代理自動化與治理_筆記.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 若在兩個階段都執行全量矩陣測試與 LLM 審查，CI 等待時間與潛在運算成本將翻倍 [貼上的文字]。
B. 緩解策略：分層執行 (Tiered Execution)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * PR 階段 (Lightweight)：僅執行「輕量級」檢查，如 Schema 校驗、Lint、靜態分析與基礎 Coverage 檢查。目標是快速反饋 [DocOps 多代理自動化與治理_筆記.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Merge Group 階段 (Heavyweight)：執行「重量級」檢查，包含全量矩陣測試、雙法官語義審查 (Dual Judge) 與漂移獵殺。這是合流前的最終防線 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Artifact Cache：利用 GitHub Actions Cache 重用 PR 階段已生成的無效應中間產物（如 normalized.jsonl），避免重複計算 [DocOps 多代理自動化與治理_筆記.txt]。
________________


12.2 資料與合規風險 (Data & Compliance Risks)
12.2.1 提示詞注入與資料指令混淆 (Prompt Injection & Data-Instruction Confusion)
根據 OWASP LLM Top 10 (2025) 與 NCSC 的定義，LLM 本質上具有「易混淆性 (Inherently Confusable)」，攻擊者可透過惡意輸入（如 Issue 評論、外部文檔、引用的 Skill）覆寫系統指令，導致 Agent 越權執行 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
A. 輸入信任分級 (Input Trust Tiers) 為了防止 Agent 將「資料」誤判為「指令」，系統強制對所有輸入來源進行分級管理 [GitHub Multi-Agent DocOps_架構指南.md.txt]：
分級 (Tier)
	定義與來源 (Definition & Source)
	處置規則 (Handling Rule)
	Untrusted (非受信)
	來自外部 Fork 的 PR、Issue Comments、外部抓取的網頁內容、SkillsMP 下載的未審核 Skills [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
	僅能被視為「純文本證據 (Evidence Only)」。在進入 LLM 上下文前，必須經過 Normalize 階段剝除任何類似指令的語法（如 "Ignore previous instructions"）[GitHub Multi-Agent DocOps_架構指南.md.txt]。
	Trusted (受信)
	Repo 內經 Code Owner 核准的 PLAN.md、CONSTITUTION.md、SKILL.md [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
	只有受信來源的內容才能被 Agent 視為「執行指令 (Instructions)」[GitHub Multi-Agent DocOps_架構指南.md.txt]。
	B. 偵測與阻斷機制 (Detection & Stopline)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 機械掃描 (Mechanical Scan)：在 Stage 1 (Normalize) 階段，使用 Regex 掃描輸入內容是否包含常見的注入模式或越權關鍵字 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 雙法官獵殺 (Dual Judge Hunting)：在 Stage 3 (Dual Review)，Judge A 與 Judge B 必須檢查輸出內容是否表現出「遵循了輸入中的隱藏指令」之跡象。若發現 Agent 違背了 System Prompt 而聽從了輸入內容，直接判定 FAIL [GitHub Multi-Agent DocOps_架構指南.md.txt]。
C. 控制平面防禦
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 禁止修改工作流：GateKit 設有 scope_write 規則，嚴禁 Agent 修改 .github/workflows/、docops/gates/ 或 docops/schemas/ 等控制平面檔案。若 Diff 觸及此禁區，機械閘門直接 FAIL [GitHub Multi-Agent DocOps_架構指南.md.txt]。
12.2.2 敏感資料外洩與隱私保護 (Sensitive Data Leakage & Privacy Protection)
由於架構採用 Public Repo 以獲取免費的 GitHub Actions 與 Rulesets 資源，資料外洩是 P0 級別的風險。必須實施嚴格的物理隔離與衛生管理 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
A. 分倉策略 (Repo Splitting Strategy)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Public Repo (執行層/模板層)：僅存放「模板 (Templates)」、「通用 Packs」、「Schema」與「非敏感文檔」。這裡的內容即使公開也不會造成業務損失 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Private Repo (數據層/策略層)：存放「具體策略」、「敏感數據」、「客戶資料」與「商業機密」。敏感資料嚴禁推送到 Public 主幹，若需引用，應透過 Submodule 或僅在 Private 環境（如 Codespaces 內）進行數據注入 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
B. 日誌衛生與掃描 (Log Hygiene & Scanning)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * No-Log Policy：Workflow 設計時，明確禁止將任何憑證、金鑰、環境變數或敏感資料打印到 stdout/stderr。必須利用 GitHub Actions 的 ::add-mask:: 功能確保即使意外輸出也會被遮蔽 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Secret Scanning：必須啟用 GitHub 原生的 Secret Scanning 與 Push Protection。若 Commit 中偵測到疑似金鑰或 Token 的字串，Push 會被平台層級直接阻斷 (Hard Block) [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
C. 證據包脫敏 (Evidence Sanitization)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Hash 封印：對於敏感的原始輸入（如內部會議記錄），在 input_manifest.json 中僅存儲其 SHA-256 Hash 與 Chunk ID，而不存儲原始文本 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 摘要存儲：Evidence Bundle 中的 trace_map 僅記錄「引用座標（Chunk ID + Offset）」，避免將敏感原文直接複製到 Public Artifacts 中 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
12.2.3 Evidence 可信度與偽造風險 (Evidence Credibility & Forgery Risks)
在高度自動化環境中，風險不僅是「做錯」，更是「造假」（例如 Agent 偽造了通過測試的報告）。系統必須確保證據具備不可抵賴性 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
A. 供應鏈鎖定 (Supply Chain Locking)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Skill 檢疫：外部 Skills（如來自 SkillsMP）被視為「不受信任供應鏈」。必須經過 Skill Ingestion Gate（來源封印、靜態衛生檢查、契約化）才能進入 docops/registry/skills/approved/ [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Action Pinning：所有第三方 GitHub Actions 必須鎖定 Commit SHA，而非使用浮動的 Tag（如 @v1），以防止上游供應鏈被投毒 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
B. 產物簽章與溯源 (Artifact Attestations)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Provenance：利用 GitHub Artifact Attestations 功能，對關鍵的 Evidence Bundle（如 final_audit.json、verdict.json）進行數位簽署。這建立了可驗證的「產地證明」，確保證據確實由特定的 Workflow Run 在受控環境下產生，而非由 Agent 手動偽造 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 離線驗證：支援使用 gh attestation verify 進行離線驗證，確保即使在 GitHub 平台之外，證據的完整性仍可被稽核 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
C. 來源防偽 (Source Anti-Spoofing)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Input Seal：在 Stage 0 產生的 source_bundle_sha256 是整個流水線的「封條」。後續所有 Gate（G1~G6）都必須驗證當前處理的輸入 Hash 是否與封條一致。若不一致，視為「換料偷跑」，直接 FAIL [GitHub Multi-Agent DocOps_架構指南.md.txt][DocOps 多代理自動化與治理_筆記.txt]。
D. 權限升級阻斷 (Privilege Escalation Blocking)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Scope Write Gate：嚴格限制 Agent 的寫入路徑白名單（如僅限 drafts/, evidence/）。若 Diff 試圖修改根目錄配置檔、.github/ 目錄或 docops/registry/ 內的規則檔，機械閘門將直接攔截 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Human-in-the-loop for Escalation：任何涉及權限變更、Secret 讀取或規則修改的操作，Supervisor AI 必須判定為「大問題 (Big Issue)」，強制中斷自動化流程，轉為人工裁決模式，禁止自動執行 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
________________


12.3 營運與成本風險 (Operational & Cost Risks)
在追求「全量覆蓋」與「自動化」的過程中，若缺乏邊界控制，CI/CD 成本可能因架構設計不當而倍增，外部技能庫的引入也帶來了新的供應鏈攻擊面。本節將這些風險轉化為可執行的阻斷規則與治理策略。
12.3.1 Skill 供應鏈投毒與惡意代碼 (Skill Supply Chain Poisoning)
隨著引入外部技能庫（如 SkillsMP、Lenny's Database 或 GitHub Repos），系統面臨最大的營運風險不再是代碼寫錯，而是「惡意指令注入」與「供應鏈投毒」 [貼上的文字][Skill 生態指南_筆記]。
A. 風險定義
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 惡意指令混入：外部 Skill 可能包含惡意 Prompt，誘導 Agent 執行越權操作（如修改 Workflow、竊取 Secrets 或外連下載惡意腳本）。這屬於 OWASP LLM Top 10 中的核心風險 [貼上的文字][5 份筆記_升級方案]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 依賴崩潰 (Dependency Collapse)：若直接引用外部 URL 或浮動標籤（如 @main），當上游變更或刪除時，流水線將立即中斷，導致不可回放 [貼上的文字]。
B. 偵測與防禦機制 (Skill Ingestion Gate) 所有外部 Skill 在進入系統前，必須通過機械掃描。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * G-S0 來源封印 (Source Seal)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 禁止動態引用：嚴禁在 Runtime 直接從網路下載 Skill 執行。所有外部 Skill 必須 本地收編 (Vendorize)，複製進 docops/vendor_skills/ 目錄 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Hash 校驗：生成 skill_lockfile.json，紀錄 source_url、version、license 與 sha256。若執行時 Hash 不符，視為來源被偷換，直接阻斷 (FAIL) [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * G-S1 靜態衛生 (Static Hygiene)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 使用 Regex 掃描 Skill 代碼是否包含可疑 Shell 指令（如 curl, wget）、是否試圖修改 .github/ 目錄、是否宣告了不必要的權限。命中即 FAIL [貼上的文字][Skill 生態指南_筆記]。
C. 隔離策略
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Quarantine (檢疫區)：新引入的 Skill 預設放入檢疫區，僅允許在沙箱 (Sandbox) 中執行評測，不得進入生產流水線 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Approved (核准區)：僅有通過雙法官審查與機械 Gate 的 Skill 才能移入核准區（Allowlist），供 Router 選用 [貼上的文字]。
12.3.2 執行時間與 CI 成本膨脹 (Execution Time & CI Cost Inflation)
為了達成「零人工核准」，系統引入了 Merge Queue 與多層 Gate，這會導致 CI 執行次數與時間的顯著增加，若不控制將導致成本失控。
A. Merge Queue 的雙倍成本陷阱
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 機制：Merge Queue 為了確保合流安全，會在 merge_group 事件中重新運行 Required Checks。這意味著每個 PR 至少會跑兩次流水線（PR 階段一次 + Queue 階段一次） [貼上的文字][5 份筆記_升級方案]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 風險：若在兩個階段都執行全量矩陣測試與 LLM 審查，CI 成本與等待時間將直接翻倍。
B. 分層執行策略 (Mitigation Strategy)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * PR 階段 (Lightweight)：僅執行「輕量級」檢查，如 Schema 校驗、Lint、靜態分析與基礎 Coverage 檢查。目標是快速反饋，不消耗昂貴算力 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Merge Group 階段 (Heavyweight)：執行「重量級」檢查，包含全量矩陣測試、雙法官語義審查 (Dual Judge) 與漂移獵殺。這是合流前的最終防線 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 緩存利用：利用 GitHub Actions Cache 或 Artifacts，在 Merge Group 階段復用 PR 階段已生成的無效應中間產物（如 normalized.jsonl），避免重複計算 [貼上的文字]。
C. 平台成本差異 (Public vs. Private)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Public Repo：GitHub Actions 標準 Runner 目前免費，但需注意 Artifacts 存留政策（建議設為 7-14 天）與 Log 公開風險 [貼上的文字][5 份筆記_升級方案]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Private Repo：免費用戶僅有 2,000 分鐘/月額度。若採用此架構，極易在數天內耗盡額度。若必須使用 Private Repo，建議配置 Self-hosted Runner 或升級 Pro 方案 [DocOps 多代理自動化與治理_筆記][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Codespaces 成本：Codespaces 按核心小時計費，長時間運行的 Agent 任務應設定 Stopline (超時/預算熔斷)，防止單一任務燒穿預算 [貼上的文字][Ralph_升級方案+討論紀錄]。
D. 外部工具配額風險
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Antigravity：嚴禁將其放入主幹流程（Critical Path），以免因 5 小時配額刷新機制導致流水線卡死。它僅能作為旁路加速器（Sidecar） [DocOps 多代理自動化與治理_筆記]。
12.3.3 過度自動化反噬與維護成本 (Over-Automation Backlash)
「自動化」若無節制，會演變成「自動化垃圾生成」或「技能平台化」的維護地獄。
A. 技能爆炸 (Skill Explosion)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 風險：為了應對各種邊角情況，不斷新增微型 Skill，導致 skills/ 目錄膨脹，維護成本上升，且 Router 選擇準確度下降 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 治理 (Governance)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Core Skills 上限：強制限制核心技能（Core Skills）數量（建議 6-10 個），確保主幹清晰。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 淘汰機制：定期掃描 Skill 使用率，若 30 天未被 Router 選中或品質指標低於基線，自動降級至檢疫區或封存 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Extras 分流：非核心技能一律放入 extras/，且不得成為 Required Path [貼上的文字]。
B. 廢話堆砌 (Fluff Generation)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 風險：Agent 為了滿足覆蓋率或字數門檻，生成大量無意義的「治理廢話」（如反覆強調「本系統具備強大的治理能力」），導致文檔信噪比下降 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 對策：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 語義漂移獵殺：GateKit 需包含針對「語義稀釋」的檢測（如 MUST 被弱化為 SHOULD） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 反平台化規則：嚴格執行 anti_platform.regex，攔截空洞的平台化敘事 [貼上的文字]。
C. 壞結果快速擴散
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 風險：在全自動合流機制下，若 Gate 設定過鬆，一個錯誤的 Prompt 或 Skill 變更會迅速汙染整個代碼庫。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 熔斷機制 (Circuit Breaker)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 震盪偵測：若同一組檔案在短時間內被反覆修改（A 改 B，B 改 A），視為 Agent 失控，直接阻斷並觸發人工介入 [Ralph_升級方案+討論紀錄][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 規則變更鎖定：任何針對控制平面（Workflows, Gates, Schemas）的變更，必須經過更嚴格的審查流程，禁止 Agent 自行修改規則 [貼上的文字]。
________________

13. 落地實作與文檔體系 (Implementation & Documentation)

________________
13.1 四份文檔權威分層 (SSOT Strategy)
為了確保在「零人工核准」與「無付費 API」的硬約束下，系統仍具備可執法性與可維護性，本架構拒絕將所有資訊混寫在單一 README 中。我們採用**「四層權威體系」**，明確劃分 規範 (Normative)、程序 (Procedural)、機械 (Machine) 與 策略 (Strategic) 的邊界 [貼上的文字]。
13.1.1 共同全域原則 (Global Principles)
這四份文檔必須共同遵守以下七大不可協商的原則，任何違反此原則的文檔變更皆視為無效 [貼上的文字]：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 控制/執行物理分離：控制平面是 GitHub 的「裁判+狀態機」，執行平面是 Codespaces 的「可重現工廠」；控制平面禁止跑需要互動認證的 LLM 任務 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. Fail-Closed (預設阻斷)：缺證據、缺契約、缺 required check 名稱、缺 trace，一律 FAIL；禁止腦補與「合理推測」 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. SSOT 分裂治理：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Spec 決定「什麼是對/錯」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Runbook 決定「怎麼做」。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Registry 決定「怎麼驗證/怎麼跑」 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           4. 可測試的規範語言：規範段落要能寫出測試/檢查；強制使用 RFC 2119 關鍵字（MUST/SHOULD/MAY），避免模糊語義 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           5. GitHub 原生合流鐵律：Required status checks / Rulesets / Merge queue 需要配套工作流；使用 merge queue 時必須支援 merge_group 事件，否則視為架構錯誤 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           6. 供應鏈與權限硬化：第三方 Actions 必須 pin SHA，workflow 權限最小化；這些必須寫進 Spec 並以 Gate 機械化 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           7. 證據可驗證化：Evidence Pack 不只「有檔案」，要能被驗證 provenance（例如透過 artifact attestations） [貼上的文字]。
________________


13.1.2 A) DocOps & DevOps Execution Control Plane Spec (規範 SSOT)
定位：這是系統的**唯一法典 (The Law)**與最高權威。它定義了合流的合法性、Gate 的語義、失敗的處置方式以及變更的權限。它直接映射到 GitHub 的 Rulesets 與 Required Checks，是控制平面進行裁決的法理依據 [貼上的文字]。
A. 職責與邊界 (Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * In-Scope：規則、契約、門檻、判決語義、控制平面配置、變更治理、供應鏈/安全基線 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Out-of-Scope：具體命令步驟（移交 Runbook）、Schema 的細節欄位（移交 Registry）、長篇背景論述（移交架構指南） [貼上的文字]。
B. 必備核心章節
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. Scope-Lock：定義目標與非目標，列出禁止事項（如 Anti-Platforming 條款） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. Authority & Change Control：定義哪些檔案是控制平面的關鍵路徑，以及提案變更的流程 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. Artifact Taxonomy：定義 PLAN、IR、Review、Patch、Final、Evidence Pack 等工件的分類學 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           4. Gate Semantics：定義 Stage 0~N 的通過標準、Fail-Closed 規則、重試策略與 Timeout Stop 機制 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           5. Evidence Contract：定義 Evidence Pack 必須包含哪些最小證據（索引、Hash、Trace、Coverage、工具版本） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           6. GitHub Control Plane Mapping：明確指定 Rulesets、Required checks、Merge Queue 與 merge_group 的對應關係 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           7. Security Baseline：定義 Pin SHA、Permissions、Secrets Masking 的安全基線 [貼上的文字]。
C. 硬性要求
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Spec 內的 Required Check 名稱是唯一 SSOT；Runbook 或 Registry 必須引用它，不得另起名稱 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 任何降低安全或證據門檻的改動，必須觸發「降級模式」或直接 FAIL [貼上的文字]。
________________


13.1.3 B) DocOps & DevOps Runbook & WI (操作 SSOT)
定位：這是系統的唯一施工手冊 (The Manual)。它將 Spec 中的規則轉化為「可重現、可照做」的標準作業程序（SOP）。Runbook 是步驟導向（Step-by-step）的，旨在讓人類或代理能精確執行操作 [貼上的文字]。
A. 職責與邊界 (Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * In-Scope：Day-1 設定步驟、Codespaces 啟動、Workflow 觸發指令、產出 Evidence Pack 的方法、常見故障處置、回滾/止血流程 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Out-of-Scope：新規範的制定（那是 Spec）、Schema 的定義（那是 Registry）、大篇章的背景故事 [貼上的文字]。
B. 必備核心章節
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. Day-1 Setup：Rulesets/Branch protection、Required checks、Auto-merge、Merge queue 的開啟與驗證步驟 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. Codespaces Environment：.devcontainer 啟動流程、工具鏈版本鎖定、Lifecycle hooks（如 postCreateCommand）的配置 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. Task Execution WI：從 IssueOps/ChatOps 入口，經過 Plan、IR、施工、Evidence 產出，到 GateKit 驗收與合流的完整路徑 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           4. Failure Handling：Required checks 不出現、Merge queue 卡死（通常因缺 merge_group）、權限不足、Schema 驗證失敗等故障的排除 SOP [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           5. Wrongbook Process：FAIL 發生時如何記錄條目、如何將防線回寫成 Gate/Policy 以實現複利 [貼上的文字]。
C. 硬性要求
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 每個 WI (Work Instruction) 必須具備：前置條件、步驟、驗證點、失敗分支、回滾/止血 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 禁止模糊用語（如「應該能行」），只允許條件分支邏輯（做 A -> 看到 B -> 否則走 C） [貼上的文字]。
________________


13.1.4 C) Registry / Contracts (機械 SSOT)
定位：這是系統的狀態機資料庫 (The Machine State)。它存放所有機器可讀的規則、契約與腳本。控制平面執行 Gate、解析 Verdict、驗證 Coverage，全靠這裡的 Schema 與註冊表。它是「程式的契約」，而非文件倉庫 [貼上的文字]。
A. 職責與邊界 (Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * In-Scope：JSON Schemas、Skills Catalog Metadata、Gate 腳本、Policies (Regex/YAML)、Hooks 定義、Allowlist、Evidence 索引 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Out-of-Scope：長篇敘述、教學文章、設計理念（這些會讓 Registry 變成垃圾場） [貼上的文字]。
B. 必備內容清單 (Repo 結構)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/registry/skills/**：定義 Skill 的 I/O、Runner 與版本 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/registry/gates/**：存放可在 GitHub Actions 運行的 GateKit 腳本 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/schemas/**：存放核心契約（input/output/ir/trace/verdict 等 schema） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/registry/policies/**：存放 Anti-platform、敏感路徑等 Policy (Regex/YAML) [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/registry/hooks/**：存放 HookKit 定義（具名、版本化） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * docops/evidence/runs//...：存放 Evidence Pack 存檔或索引 [貼上的文字]。
C. 硬性要求
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Registry 中的每個條目都必須通過 Schema 驗證；不通過直接 FAIL [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 所有可執行依賴（如 Actions）必須 Pin SHA，這是供應鏈防線 [貼上的文字]。
________________


13.1.5 D) Thin Vertical Slice (導入策略文檔)
定位：這是第一條閉環樣本的設計書 (The Prototype Spec)。它不是 Backlog 或 Roadmap，而是針對「單一特定任務類型」，穿透控制平面、執行平面與證據層的完整實作設計。其目的是產出第一個「可稽核的 PASS 樣本」 [貼上的文字]。
A. 職責與邊界 (Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * In-Scope：選定任務型別、端到端流程、最小 Packs（Skills/Gates/Policies）、驗收條件、Evidence Pack 最小集合、回放步驟 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Out-of-Scope：所有未納入本切片的「未來功能」細節（那是下一片 Slice） [貼上的文字]。
B. 必備核心章節
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. Goal & Non-Goal：明確定義切片的目標與非目標 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. End-to-End Flow：繪製從入口到合流的完整流程圖 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. Minimal Packs：定義本切片所需的最小 SkillPack、GatePack 與 PolicyPack [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           4. Minimal Evidence：定義本切片必須產出的 Evidence Pack 內容與門檻 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           5. Acceptance Criteria：對齊 Acceptance Checklist（G0..G5）的驗收條件 [貼上的文字]。
C. 硬性要求
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * TvS 只能引用 Spec/Registry 的既有門檻，禁止「臨時加一條」規則 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * TvS 必須能在 Merge Queue 情境下運作，即 Workflow 必須包含 merge_group 觸發 [貼上的文字]。
________________


13.2 文檔職責規範 (Document Charters)
13.2.1 Execution Control Plane Spec (規範 SSOT)
A. 權威等級 (Authority Level)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Normative（規範性）：這是唯一的「可引用法源」。定義合流的合法性、Gate 的語義、失敗處置、以及誰能修改規則 [貼上的文字]。
B. 允許內容 (In-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * MUST/SHOULD/MAY 類規範：使用 RFC 2119 關鍵字定義的硬性規則 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 定義與門檻：GateKit 的通過標準（如覆蓋率 ≥ 98%）、失敗語義（Fail-Closed 條件） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * SSOT 映射：Required Checks 名稱的唯一事實來源（如 docops-gatekit） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 基線安全：權限最小化原則、供應鏈鎖定策略（Pin SHA）、變更治理流程 [貼上的文字]。
C. 禁止內容 (Out-of-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 具體操作步驟：逐步命令、截圖、路徑操作（必須移交給 Runbook） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Schema 細節：JSON 欄位的逐條定義（必須移交給 Registry/Contracts） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 長篇論述：背景故事、教學文章、實作 Walkthrough（必須移交給架構指南或 Runbook） [貼上的文字]。
D. 篇幅防膨脹規則 (Anti-Bloat Rules)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 可測試性約束：每一條規範必須能對應至少一個：Gate、Policy、Schema 或 Required Check。若無法被機械驗證，則必須刪除 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. YAML 限制：Spec 內不允許貼上長段 YAML 或 Workflow 代碼，只允許引用檔名與 Check 名稱 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. 例外條款格式：「例外」必須明確列出：觸發條件、允許範圍、審計證據要求、撤銷機制 [貼上的文字]。
E. AI 自檢清單 (Fail-Closed Checklist)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否嚴格使用 RFC 2119 關鍵字（MUST/SHOULD）且用法一致？ [貼上的文字]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否存在「應該/大概/建議」等模糊詞彙但無測試對應？（若有，視為無效規範，必須刪除或改寫為可測條件） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否新增了 Runbook 或 Registry 才該出現的內容？（若有，必須移除並改為引用） [貼上的文字]。
________________


13.2.2 Runbook & WI (操作 SSOT)
A. 權威等級 (Authority Level)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Procedural（程序性）：這是唯一的「施工步驟來源」。目標是讓人類或自動化 Agent 能照做、可重現、可復原 [貼上的文字]。
B. 允許內容 (In-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Day-1 設定：Rulesets、Secrets、環境變數的初始配置步驟 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 操作指令：精確的 CLI 命令、檔案路徑、預期輸出 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 故障排查：常見錯誤的特徵（Log 關鍵字）、回滾步驟、止血流程 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 證據產出：如何生成並打包 Evidence Pack 的具體操作 [貼上的文字]。
C. 禁止內容 (Out-of-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 新門檻/新規範：嚴禁在操作手冊中發明新的通過標準（那是 Spec 的職責） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 新 Schema 定義：嚴禁定義 JSON 結構（那是 Registry 的職責） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 長篇論述：「為什麼要這樣做」的解釋最多允許一段，其餘應引用架構指南 [貼上的文字]。
D. 篇幅防膨脹規則 (Anti-Bloat Rules)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 固定模板：每個 WI (Work Instruction) 必須符合 Preconditions / Steps / Verify / Failure branches / Rollback 結構。不合模板者拒收 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. 可觀測性綁定：每個故障排查條目必須指向一個明確的「可觀測信號」（如 Log 錯誤碼、Check 名稱、Exit Code） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. Merge Queue 完整性：涉及 Merge Queue 的條目必須明寫 merge_group 事件觸發，否則視為未完成（因為會導致隊列卡死） [貼上的文字]。
E. AI 自檢清單 (Fail-Closed Checklist)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 每一步驟是否都有可驗證的輸出（Expected Output）？ [貼上的文字]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否試圖把 Spec 的規範改寫成新規則？（禁止重寫，只能引用 Spec 段落 ID） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否包含「可能/也許/試試看」這種不可回放的措辭？（必須改成明確的條件分支：If X then Y） [貼上的文字]。
________________


13.2.3 Registry / Contracts (機械 SSOT)
A. 權威等級 (Authority Level)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Machine-Readable（機械可讀）：這是「狀態機的資料庫」。控制平面執行 Gate、解析 Verdict、驗證 Coverage 全靠這裡的 Schema 與註冊表 [貼上的文字]。
B. 允許內容 (In-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * JSON Schemas：輸入/輸出契約、報告格式 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Skills Metadata：版本、Runner、I/O 定義 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Scripts/Policies：Gate 腳本、Regex 規則、Hooks 定義、Allowlist、Evidence 索引 [貼上的文字]。
C. 禁止內容 (Out-of-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 長篇說明：教學文章、設計理念（Rationale）。這些會讓 Registry 變成垃圾場，阻礙機器解析 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 任務計畫：具體的任務流程敘述（那是 TvS 或 Runbook 的職責） [貼上的文字]。
D. 篇幅防膨脹規則 (Anti-Bloat Rules)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. Schema 強制：所有條目必須通過 Schema 驗證。無 Schema 或不可解析的內容禁止進入主目錄（只能進 quarantine/） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. SKILL.md 限制：技能描述檔只允許包含目的（一句話）、I/O、Runner、版本、風險等級；禁止寫成教科書 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           3. 配套原則：每次新增 Schema，必須同時新增一個對應的 Gate 檢查點（否則 Schema 等於擺設） [貼上的文字]。
E. AI 自檢清單 (Fail-Closed Checklist)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否所有 JSON/YAML 都能被 CI 腳本驗證通過？ [貼上的文字]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否存在未經 Source Seal、靜態掃描或沙盒評測的技能進入了 Allowlist？（若有，直接 FAIL） [貼上的文字]。
________________


13.2.4 Thin Vertical Slice (導入策略文檔)
A. 權威等級 (Authority Level)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Design Doc（設計書）：這是「第一條閉環樣本」的設計與驗收清單。目標是產出可重現的 PASS 樣本 [貼上的文字]。
B. 允許內容 (In-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 切片定義：選定 1 類任務型別、端到端流程圖 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 最小集合：該切片所需的最小 Skills/Gates/Policies 集合 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 驗收條件：Evidence Pack 的最小集合、回放步驟 [貼上的文字]。
C. 禁止內容 (Out-of-Scope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 全量 Roadmap：未來的擴充計畫、所有可能的功能細節 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * 泛化平台設計：試圖建立通用平台的描述（這會導致 Big Bang 失敗） [貼上的文字]。
D. 篇幅防膨脹規則 (Anti-Bloat Rules)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1. 落地限制：只允許描述「本切片會落地的東西」。任何「之後再做」的內容只能列在「非目標（Non-Goals）」中，且最多 5 條 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2. 回指要求：每個「切片內元件」必須能指回：Spec 條款、Registry 條目或 Runbook WI（否則視為空想） [貼上的文字]。
E. AI 自檢清單 (Fail-Closed Checklist)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 是否產出了可在 Merge Queue 情境下運作的最小閉環？（需檢查 merge_group 觸發配置） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * [ ] 所有驗收條件是否都能由 Required Checks 表達？（不能表達就不算驗收條件） [貼上的文字]。
________________


13.2.5 額外補強：可驗證證據收斂 (Verifiable Evidence)
為了確保 AI 產物不只是長篇大論而是「可信證據」，以下規則必須寫入 Spec 並在 Registry/Gate 中落地：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Artifact Attestations (Provenance)：必須使用 GitHub Actions 產生 Build Provenance 的 Attestation，讓 Evidence Pack 或產物可驗證其來源與建置過程 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * OIDC + 最短憑證：外部系統存取必須使用 OIDC，禁止使用長效 Secrets [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * SHA Pin + 最小權限：這是「供應鏈與越權」兩大高概率事故的最低成本防線，必須強制執行 [貼上的文字]。
________________


13.3 Repo 目錄骨架與檔案結構 (Repo Directory Skeleton & File Structure)
為了滿足「最小人工介入」與「可回放稽核」的硬約束，Repository 的目錄結構必須被視為「系統架構圖」來嚴格執行。所有規則、技能、契約與證據都必須落地為具體的檔案，禁止依賴任何外部黑盒平台或隱性知識 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
13.3.1 根目錄與環境定義 (Root Level & Environment Definition)
根目錄存放全域治理文件與環境定義，是 Agent 進入專案時的「第一眼」上下文，也是防止環境漂移的第一道防線。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * CLAUDE.md (外部海馬迴)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 定位：專案的「外部海馬迴 (External Hippocampus)」與行為憲法。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 內容契約：必須包含「架構模式 (Architectural Patterns)」、「操作規則 (Operational Rules)」與「錯題本摘要 (Historical Corrections)」。這不是 Readme，而是 Agent 的執行準則 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 更新機制：透過 Git 版控，且必須由 CI 流程自動回寫錯誤教訓 [複利工程指南_筆記]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * .devcontainer/ (執行平面 / Execution Plane)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 定位：唯一可重現的執行沙盒 (Reproducible Sandbox)。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * devcontainer.json：必須鎖定 Runtime 依賴（如 Python 3.11, Node 20）、CLI 工具版本（Claude Code, Codex），確保「工廠環境」的一致性，消除「在我機器上可以跑」的變數 [GitHub Multi-Agent DocOps_方案A.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Lifecycle Hooks：定義 postCreateCommand 自動安裝 HookKit 與工具鏈，確保環境啟動即就緒 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * WRONGB00K.md (失敗資產化)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 定位：反脆弱契約。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * 結構：必須包含「失敗案例」、「成因」、「防線」與「新阻斷線 (New Stopline)」。CI 檢查若發現 Fix PR 未包含此檔案更新，直接 FAIL [複利工程指南_筆記][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * PROMPT_DELTALOG.md

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * 定位：提示詞演進錄。記錄 Prompt 變更的理由與 A/B 測試結果，防止隨機試錯 [複利工程指南_筆記]。
13.3.2 控制平面配置 (.github/ Control Plane)
此目錄定義了流水線狀態機與機械裁判，是「零人工核准」的執法機構。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * workflows/ (CI/CD 流程)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * docops.yml：定義核心流水線。必須包含 merge_group 事件觸發，否則 Merge Queue 的 Required Checks 將不會執行，導致合流卡死 [貼上的文字][GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * gatekit.yml：獨立運行的機械閘門檢查流程。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * copilot-instructions.md (顯式硬記憶)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 定位：Repo 層級的 Custom Instructions。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * 內容：儲存絕對規則（如「嚴禁使用付費 API Key」）與從 Wrongbook 提煉出的 Regex 阻斷規則 [貼上的文字][複利工程指南_筆記]。
13.3.3 docops/registry/：立法與規則庫 (The Law Layer)
此目錄存放所有「立法層」的資產。所有內容必須可被版本控制、Diff 審計，且是機械閘門執法的唯一依據 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * skills/ (技能目錄 / Skill Plane)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * core/：存放 6 個核心技能（Ingest, Normalize, Extract, Synthesize, Review, Repair）。這是所有任務的共用骨架，嚴禁刪改 [貼上的文字][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * extras/：存放非核心技能，預設不啟用，避免技能膨脹 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * third_party_cache/：外部技能（如來自 SkillsMP）的收編區。永不直接執行，必須經過 Ingestion Gate 檢疫與 Allowlist 核准後才可移入 approved/ [貼上的文字][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * skills_catalog.yaml：技能註冊表。定義每個 Skill 的 I/O Schema、對應的 Gate、Stopline 與 Retry 策略 [貼上的文字][Agent Skills決策樹_升級方案+討論紀錄.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 補強指針：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 多代理只用於「讀/弱耦合」與黑盒驗證；
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 遇到「寫/強耦合」必回歸單線程主腦以避免狀態分岔與傳話遊戲，且指揮官委派格式必固定為「目標＋輸出格式＋背景＋工具/邊界＋冷靜期」；
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 長跑任務必支援斷點續傳（Never Restart）與錯誤自癒；
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Claude Code 腳手架（Skills/Commands、Hooks、Sub-agents、Rule Implantation、MCP 工具/連線上限）不得散落在聊天或人腦，必落地為 Runbook/Registry 的可檢查檔案：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Runbook 請補在「TVS Run Procedure / Failure Handling / Day-1 Setup」相關章節（委派模板、checkpoint/重試、工具上限與資源預算）；
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Registry 請補在 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * skills_catalog.yaml（objective/output/tool_boundaries/cooldown/budget 欄位）、
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * hooks/registry.yaml（post_tool_execution checkpoint、
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * format/lint、
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * session-leave 提醒等）、
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * policies/（tool_budget.yaml：MCP 同開≤10、工具總數<80 等門檻與例外）、以及 CLAUDE.md / copilot-instructions.md（長期行為準則與子代理角色白名單）。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * gates/ (機械閘門腳本)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 內容：存放 Python/Shell 腳本，用於執行 Deterministic Checks。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * 必備腳本：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * g1_coverage_id_scan.py：計算 ID 覆蓋率 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * g3_drift_regex_scan.py：執行反平台化 Regex 掃描 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * g5_invariant_check.py：檢查 must_hold 不變量是否被弱化 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * judge_aggregate.py：聚合雙法官裁決結果 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * policies/ (政策與例外)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * router_rules.yaml：決策樹路由規則。定義任務特徵（如檔案類型、風險等級）與 Skill/Profile 的映射關係 [Agent Skills決策樹_升級方案+討論紀錄.txt][GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * anti_platform.regex：反平台化禁詞清單（如 "Unified Platform", "Center of Excellence"） [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * drift_exceptions.yaml：漂移豁免清單。必須包含 scope、理由與到期日（expiry），防止永生免死金牌 [貼上的文字][GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * skill_lockfile.json：鎖定外部技能的 Source URL 與 Commit SHA，防止供應鏈投毒 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * hooks/ (HookKit)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * registry.yaml：定義 Hook 的觸發條件、Scope 與擁有者，將 Hook 升級為一等公民管理 [貼上的文字]。
13.3.4 docops/schemas/：契約定義層 (The Contract Layer)
此目錄存放所有 JSON Schemas，用於強制約束 Agent 的輸入與輸出格式。GateKit 會依據這些 Schema 進行驗證，格式錯誤即視為 FAIL [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * input.schema.json / output.schema.json：定義 Skill 的輸入輸出契約。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * ir_chunk.schema.json：定義正規化後的中間表達格式 (IR)，包含 ID、Content、Hash [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * trace_map.schema.json：定義引用鏈追蹤格式 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * verdict.schema.json：定義雙法官裁決的輸出格式（必須包含 PASS/FAIL + 原因 + 證據指針） [Agent Skills決策樹_升級方案+討論紀錄.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * gate_report.schema.json：定義機械閘門報告的標準格式 [貼上的文字]。
13.3.5 docops/evidence/：稽核證據層 (The Audit Layer)
此目錄用於存檔每次任務執行的「證據包 (Evidence Pack)」，確保所有決策皆可回放 (Replayable) 與稽核 (Auditable) [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * runs/<run_id>/ (單次執行紀錄)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Manifests：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * run_manifest.json：記錄 Runner 環境、工具版本、Commit SHA [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * input_manifest.json：輸入檔案的清單與 Hash 封印 [5 份筆記_升級方案+討論紀錄.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Artifacts：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * source_bundle_sha256：輸入封印，防止換料偷跑 [DocOps 多代理自動化與治理_筆記.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * normalized.jsonl：正規化後的 IR [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * trace_map.json：內容引用映射表 [5 份筆記_升級方案+討論紀錄.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * verdict_codex.json / verdict_claude.json：雙法官的原始裁決檔案 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * gate_report.json：所有機械閘門的通過狀態報告 [GitHub Multi-Agent DocOps_方案A.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * diff_report.md：變更差異報告 [GitHub Multi-Agent DocOps & DevOps 架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Skill Evidence：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skillpack.json：本次任務實際啟用的技能集合與版本鎖定資訊 [貼上的文字]。
________________


13.4 啟動清單 (Bootstrap Checklist)
13.4.1 v0 最小三件套 (Spec v0, Runbook v0, Registry v0)
為了避免陷入「文檔寫完就過期」的迴圈，啟動階段不應撰寫全量文檔，而是產出僅夠支撐第一片 Thin Vertical Slice 的「v0 最小三件套」。以下清單為 AI 生成的「防膨脹」硬性約束 [貼上的文字]。
A. Execution Control Plane Spec v0（規範 SSOT）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 約束：v0 只允許 5 個章節，總規範條目上限 25 條。超過即視為越界 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 必備內容：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 範圍鎖與權威：定義 SSOT 分層與 Fail-Closed 原則 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Required Checks & Merge Policy：指定 docops-gatekit 為唯一 Required Check 名稱；若啟用 Merge Queue，強制要求 workflow 包含 merge_group 觸發 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * GateKit v0 語義：定義 G0~G4 的通過標準與 Stopline [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Evidence Contract v0：定義 Evidence Pack 最小清單（Manifest, Coverage Map, Trace Map） [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Security Baseline v0：GITHUB_TOKEN 最小權限與 Action Pin SHA [貼上的文字]。
B. Runbook & WI v0（操作 SSOT）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 約束：v0 只允許 4 個章節，每章最多 10 步，總步數上限 30 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 必備內容：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Day-1 Control Plane Setup：設定 Rulesets、Required Checks、Auto-merge [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Day-1 Execution Plane Setup：.devcontainer 固化工具鏈與 Lifecycle scripts [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * TvS v0 Run Procedure：IssueOps 入口 → 產 Plan/IR → 施工 → 產 Evidence → PR → Gate PASS → 合流 [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Failure Handling：FAIL 時保存 Evidence 並寫入 Wrongbook [貼上的文字]。
C. Registry / Contracts v0（機械 SSOT）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 約束：v0 不是圖書館，是狀態機最小資料庫。只允許：1 個 Index、1 個 Skill、1 個 Gate Runner、2 個 Policy、6 個 Schema [貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 必備 Schemas：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * inputs_manifest.schema.json (G0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * evidence_manifest.schema.json (G3)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * gate_report.schema.json (G1/G3)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * coverage_map.schema.json (G4)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * trace_map.schema.json (G4)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * verdict.schema.json [貼上的文字]
13.4.2 Day-1 設定與權限配置 (Day-1 Settings & Permissions)
本節定義專案啟動第一天必須完成的「硬體」配置，涵蓋 GitHub 控制平面與 Agent 執行平面的初始化 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
A. GitHub 控制平面設定 (Control Plane) 為了實現「零人工核准」，必須在 Repo 層級鎖死以下規則：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Merge Queue (合併隊列)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 啟用條件：確認 Repo 為 Org-owned Public 以免費使用此功能 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 觸發配置：所有 Required Workflows 必須監聽 merge_group 事件，否則隊列檢查不會執行，導致合併卡死 [GitHub Multi-Agent DocOps_架構指南.md.txt][貼上的文字]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Rulesets (規則集)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Require Merge Queue：在 Repo-level ruleset 中強制啟用 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Require Status Checks：列出關鍵的聚合器 Job（如 docops-gatekit 或 finalize），並設為必過 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 禁止 Bypass：除管理員緊急修復外，禁止繞過上述規則直接 Push 到主幹 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Auto-merge：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 在 Repo 設定中允許 Auto-merge，並在 Workflow 中使用 gh pr merge --auto 自動觸發，移除人工點擊按鈕的需求 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
B. Agent 執行平面初始化 (Execution Plane)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 目錄結構初始化：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 執行 spec-init：生成 constitution、specify、plan 等基礎文件 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 執行 /init：生成初始的 CLAUDE.md，定義專案級的架構模式與操作約束 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 建立 docops/registry/：存放 skills、hooks、gates 與 policies [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 環境固化：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 配置 .devcontainer/devcontainer.json：鎖定 Codespaces 的運行環境、工具版本（CLI）與 Lifecycle Hooks，確保「可重現沙盒」的一致性 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * 權限控制 (Least Privilege)：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * GITHUB_TOKEN：Actions 的 Token 權限預設設為 read-only，僅對特定需要的 Job 開放 contents: write 或 pull-requests: write [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Approve-and-Run：針對 Public Repo，開啟此選項以防止外部 Fork 的惡意 PR 消耗配額或進行注入攻擊 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
C. 自適應開機 (Adaptive Bootstrap)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Task Manifest：在任務開頭，透過 Stage 0 自動生成 task_manifest.json，分析任務類型、範圍與風險等級 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Skill Resolver：根據任務類型自動掛載 Core Skills 與 Domain Packs，並鎖定執行計畫 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
D. 會話腳手架 (Session Scaffolding) —— 讓多代理更少迷路、更少互毆
* 目的：把「狀態、進度、驗證」外部化，避免 LLM 上下文抖動導致的重工、覆寫、與“看似驗了其實沒驗”。


1) 會話狀態外部化（State Externalization）
   * 必須在 repo 內維持一份「單一權威」的進度/狀態檔（例如 progress.txt 或 progress.md）。
   * 內容最小集合（不可缺）：
     - current_step：目前做到哪一步（對齊 Runbook step id）
     - next_step：下一步要做什麼（可機械驗證的動作描述）
     - decisions：本次新增/改動的決策（每條附 evidence 指針）
     - open_questions：仍未釐清的歧義（若存在，必須阻斷合流或標 CR_OPEN）
     - evidence_ptrs：Evidence Pack 的路徑與關鍵工件清單（至少含 gate_report / verdict / diff）
   * 原則：你可以忘記，但 progress 不能忘記（把腦子當快取，把檔案當資料庫）。


2) 單寫入者規則（One-Writer Rule）
   * 任何「寫操作」（編輯檔案、變更目錄結構、git add/commit、套用 patch）必須由唯一的 Implementer/主代理負責。
   * 其他子代理只允許輸出：
     - 只讀分析（read-only）
     - 建議 patch（以 diff/patch 形式）
     - 驗證報告（verification report）
   * 目標：避免多代理同時改同一棵工作樹造成隱性覆寫與不可回放。


3) 可重現開機（Deterministic Bootstrap）
   * 必須有一個「可重現的開機入口」用於：
     - 工具鏈/版本檢查（與 run_manifest 對齊）
     - repo 狀態檢查（乾淨工作樹、正確分支、必要檔案存在）
     - 生成或校驗 progress 檔案
   * 注意：此處僅定義“必須存在開機入口”，具體命令與腳本放 Runbook/Registry（見下方指針）。


4) Verifier 反偷懶條款（Anti-Handwave Verification）
   * Verifier 不允許輸出「Looks good」「No issue found」這種無證據結論。
   * 每次驗證至少包含（缺一視為無效驗證）：
     - 已檢查的檔案清單（含路徑）
     - 已執行的驗證動作清單（含命令或 Gate 名稱）
     - 至少 1 個負向測試/破壞性檢查（例如：故意找邊界條件、衝突點、或規範矛盾）
     - 明確結論：PASS/FAIL/CR_OPEN，並附上 Evidence 工件指針
   * 目標：把“審查”變成可稽核的工件，而不是情緒價值。


5) UI / 行為變更的最小 E2E 證據（E2E Evidence, Minimal）
   * 若任務涉及 UI 或可視行為（特別是前端/文件渲染/流程界面）：
     - 至少提供 1 份可重現的 E2E/視覺證據（例如：截圖或錄影的 hash + 生成方式）
     - 證據必須被納入 Evidence Pack（並在 progress 的 evidence_ptrs 可追溯）
   * 目標：避免“口頭描述正常”但實際壞掉。


6) 工具預算與停止條件（Tool Budget & Stop Conditions）
   * 必須為每次任務明確列出：
     - 允許使用的工具集合（Allowed Tools）
     - 工具呼叫的預算上限（Budget）
     - 停止條件（Stopline）：遇到哪些情形必須停、必須產出 fail_packet / ambiguity_report
   * 目標：避免工具濫用、迴圈震盪、與上下文炸裂。


——補強落點指針（只指路，不在架構指南內展開細則）——
A) Runbook（操作 SSOT）
   * Runbook 第 2 章：Day-1 Execution Plane Setup
     - 放：開機入口（bootstrap）、progress 規格、單寫入者作業法、工具預算/停止條件的填寫規則
   * Runbook 第 3 章：TvS v0 Run Procedure
     - 放：Verifier 的最小驗證動作清單、E2E 證據產出/收集流程、Evidence Pack 收斂順序
   * Runbook 第 4 章：Failure Handling & Wrongbook
     - 放：Verifier 無效驗證/震盪/工具濫用的失敗分類與回寫規則（Wrongbook 指針）


B) Registry（機械 SSOT）
   * docops/registry/policies/
     - 放：One-Writer、Anti-Handwave Verification、Tool Budget/Stopline 的 policy 定義（可測）
   * docops/registry/hooks/
     - 放：bootstrap / post-run / evidence-collect 的 hook 定義（含觸發點與產物契約）
   * docops/registry/schemas/
     - 放：progress/run_state、verification_report、e2e_evidence 的 schema（Fail-Closed 驗證用）
   * docops/registry/scripts/
     - 放：檢查 progress 必備欄位、驗證報告完整性、E2E 證據存在性的機械腳本
   * docops/registry/index.yaml
     - 放：上述新增 policy/hook/schema/script 的索引，確保供應鏈可審計


13.4.3 最小驗收檢核表 (Acceptance Checklist)
此清單用於驗收「自動化流水線」本身是否合格。只有當以下所有項目皆為 PASS 時，系統才算具備「人只看 PASS」的能力 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
檢核項目 (Check Item)
	驗收標準 (Criteria)
	Fail-Closed 行為
	G0 Input Seal
	source_bundle_sha256 存在且前後一致。
	Hash 不符直接 FAIL，防止換料。
	G1 Coverage
	ID 覆蓋率 coverage >= 98% (或 unmapped_atoms == 0)。
	未達標直接 FAIL，不接受人工放行。
	G2 Traceability
	新增/改寫的 REQ/DEC 必有回指 ir_id。
	發現無來源主張 (No-Source) 即 FAIL。
	G3 Anti-Platform
	anti_platform.regex 未命中任何禁詞。
	命中即 P0 FAIL，禁止合流。
	G4 Dual Judge
	雙法官 (A/B) 判定一致且 Swap/Perturb 測試通過。
	分歧或不穩即 FAIL。
	G5 Merge Queue
	merge_group 事件能正確觸發 Required Checks。
	若 Queue 內未跑檢查，視為架構錯誤 FAIL。
	Evidence Pack
	產物包含 verdict.json, trace_map.json, diff_report.md 等。
	缺檔或 Schema 驗證失敗即 FAIL。
	Auto-merge
	系統能在 Checks 通過後自動合併，無人工介入。
	若需人工按鈕，視為自動化破功。
	13.4.4 補丁骨架 (Patch Skeleton)
針對從「方案 A」升級至本架構的具體檔案變更清單。所有新增元件皆遵循 Fail-Closed 原則 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
A. 針對方案 A 的具體修補點
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1. Workflow 觸發事件修補：在 .github/workflows/docops-gates.yml 中強制加入 merge_group 事件，否則 Merge Queue 無法觸發檢查 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         2. 漂移豁免白名單：建立 docops/registry/drift_exceptions.yaml，Schema 包含 id, scope, reason, expires_at，過期自動 FAIL [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         3. 錯題本回寫：建立 docops/registry/WRONGB00K.md，包含 Failure Case, Root Cause, New Stopline。若 PR 修復了 CI 失敗但未包含此檔案更新，判定 FAIL [GitHub Multi-Agent DocOps_架構指南.md.txt]。
B. 新增 Gate 腳本與設定檔 (docops/scripts/)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * atomize.py: 將文檔切分為 Atoms 並產出 input_manifest.json [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * trace_check.py: 檢查 trace_map.json 是否有無效引用 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * drift_check.py: 檢查無源新增或語氣弱化 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * anti_platform.py: 執行 Regex 掃描 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * judge_aggregate.py: 讀取雙法官 JSON 並執行一致性裁決 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * evidence_manifest.json: 定義必須產出的工件清單 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
C. Router 與 Skill Resolver 實作 (docops/registry/)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * router_rules.yaml: 定義任務特徵與 Lane/Skill 的映射關係 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skills_resolver.py: 根據規則產出 skill_plan.json，優先使用庫內技能，網搜技能僅生成 PR [GitHub Multi-Agent DocOps_架構指南.md.txt]。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * skill_lockfile.json: 鎖定外部 Skill 的來源與 Hash，Hash 不符直接阻斷 [GitHub Multi-Agent DocOps_架構指南.md.txt]。
________________


END